

<!DOCTYPE html>
<html lang="zh-CN" data-default-color-scheme=auto>



<head>
  <meta charset="UTF-8">
  <link rel="apple-touch-icon" sizes="76x76" href="/img/favicon.png">
  <link rel="icon" href="/img/favicon.png">
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=5.0, shrink-to-fit=no">
  <meta http-equiv="x-ua-compatible" content="ie=edge">
  
  <meta name="theme-color" content="#2f4154">
  <meta name="author" content="万宇">
  <meta name="keywords" content="">
  
    <meta name="description" content="整个Web工程运行的时候碰到奇奇怪怪的问题，先用Maven的clean执行一下 工程端口改为8082，忽略文档里之前写的8080 测试账号和密码：    账号 密码    wanyu 123   niuke 123   lihonghe 123   一、SpringBoot入门：开发社区首页1. 搭建开发环境不详细说明，前置课程自行搜索  Maven IDEA  2. 创建SpringBoot工程">
<meta property="og:type" content="article">
<meta property="og:title" content="项目：学校交流论坛">
<meta property="og:url" content="http://jswanyu.github.io/2022/06/11/%E9%A1%B9%E7%9B%AE/%E5%AD%A6%E6%A0%A1%E4%BA%A4%E6%B5%81%E8%AE%BA%E5%9D%9B/index.html">
<meta property="og:site_name" content="Wynn&#39;s blog">
<meta property="og:description" content="整个Web工程运行的时候碰到奇奇怪怪的问题，先用Maven的clean执行一下 工程端口改为8082，忽略文档里之前写的8080 测试账号和密码：    账号 密码    wanyu 123   niuke 123   lihonghe 123   一、SpringBoot入门：开发社区首页1. 搭建开发环境不详细说明，前置课程自行搜索  Maven IDEA  2. 创建SpringBoot工程">
<meta property="og:locale" content="zh_CN">
<meta property="og:image" content="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/icon/%E7%89%9B%E5%AE%A2%E7%BD%91%E5%9B%BE%E6%A0%87.jpeg">
<meta property="article:published_time" content="2022-06-11T13:22:43.000Z">
<meta property="article:modified_time" content="2022-06-23T04:44:39.435Z">
<meta property="article:author" content="万宇">
<meta name="twitter:card" content="summary_large_image">
<meta name="twitter:image" content="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/icon/%E7%89%9B%E5%AE%A2%E7%BD%91%E5%9B%BE%E6%A0%87.jpeg">
  
  
  
  <title>项目：学校交流论坛 - Wynn&#39;s blog</title>

  <link  rel="stylesheet" href="https://lib.baomitu.com/twitter-bootstrap/4.6.1/css/bootstrap.min.css" />



  <link  rel="stylesheet" href="https://lib.baomitu.com/github-markdown-css/4.0.0/github-markdown.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/hint.css/2.7.0/hint.min.css" />

  <link  rel="stylesheet" href="https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.css" />



<!-- 主题依赖的图标库，不要自行修改 -->
<!-- Do not modify the link that theme dependent icons -->

<link rel="stylesheet" href="//at.alicdn.com/t/font_1749284_hj8rtnfg7um.css">



<link rel="stylesheet" href="//at.alicdn.com/t/font_1736178_lbnruvf0jn.css">


<link  rel="stylesheet" href="/css/main.css" />


  <link id="highlight-css" rel="stylesheet" href="/css/highlight.css" />
  
    <link id="highlight-css-dark" rel="stylesheet" href="/css/highlight-dark.css" />
  




  <script id="fluid-configs">
    var Fluid = window.Fluid || {};
    Fluid.ctx = Object.assign({}, Fluid.ctx)
    var CONFIG = {"hostname":"jswanyu.github.io","root":"/","version":"1.9.1","typing":{"enable":true,"typeSpeed":70,"cursorChar":"_","loop":false,"scope":[]},"anchorjs":{"enable":true,"element":"h1,h2,h3,h4,h5,h6","placement":"left","visible":"hover","icon":""},"progressbar":{"enable":true,"height_px":3,"color":"#29d","options":{"showSpinner":false,"trickleSpeed":100}},"code_language":{"enable":true,"default":"TEXT"},"copy_btn":true,"image_caption":{"enable":false},"image_zoom":{"enable":true,"img_url_replace":["",""]},"toc":{"enable":true,"placement":"right","headingSelector":"h1,h2,h3,h4,h5,h6","collapseDepth":0},"lazyload":{"enable":true,"loading_img":"/img/loading.gif","onlypost":false,"offset_factor":2},"web_analytics":{"enable":true,"follow_dnt":true,"baidu":null,"google":null,"gtag":null,"tencent":{"sid":null,"cid":null},"woyaola":null,"cnzz":null,"leancloud":{"app_id":null,"app_key":null,"server_url":null,"path":"window.location.pathname","ignore_local":false}},"search_path":"/local-search.xml"};

    if (CONFIG.web_analytics.follow_dnt) {
      var dntVal = navigator.doNotTrack || window.doNotTrack || navigator.msDoNotTrack;
      Fluid.ctx.dnt = dntVal && (dntVal.startsWith('1') || dntVal.startsWith('yes') || dntVal.startsWith('on'));
    }
  </script>
  <script  src="/js/utils.js" ></script>
  <script  src="/js/color-schema.js" ></script>

  
<meta name="generator" content="Hexo 6.1.0"></head>


<body>
  

  <header>
    

<div class="header-inner" style="height: 70vh;">
  <nav id="navbar" class="navbar fixed-top  navbar-expand-lg navbar-dark scrolling-navbar">
  <div class="container">
    <a class="navbar-brand" href="/">
      <strong>Wynn&#39;s blog</strong>
    </a>

    <button id="navbar-toggler-btn" class="navbar-toggler" type="button" data-toggle="collapse"
            data-target="#navbarSupportedContent"
            aria-controls="navbarSupportedContent" aria-expanded="false" aria-label="Toggle navigation">
      <div class="animated-icon"><span></span><span></span><span></span></div>
    </button>

    <!-- Collapsible content -->
    <div class="collapse navbar-collapse" id="navbarSupportedContent">
      <ul class="navbar-nav ml-auto text-center">
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/">
                <i class="iconfont icon-home-fill"></i>
                首页
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/categories/">
                <i class="iconfont icon-category-fill"></i>
                分类
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/log/">
                <i class="iconfont icon-tags-fill"></i>
                日志
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/archives/">
                <i class="iconfont icon-archive-fill"></i>
                时间线
              </a>
            </li>
          
        
          
          
          
          
            <li class="nav-item">
              <a class="nav-link" href="/about/">
                <i class="iconfont icon-user-fill"></i>
                关于
              </a>
            </li>
          
        
        
        
          <li class="nav-item" id="color-toggle-btn">
            <a class="nav-link" target="_self" href="javascript:;" aria-label="Color Toggle">&nbsp;<i
                class="iconfont icon-dark" id="color-toggle-icon"></i>&nbsp;</a>
          </li>
        
      </ul>
    </div>
  </div>
</nav>

  

<div id="banner" class="banner" parallax=true
     style="background: url('https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/icon/%E7%89%9B%E5%AE%A2%E7%BD%91%E6%A8%AA%E5%B9%85.jpg') no-repeat center center; background-size: cover;">
  <div class="full-bg-img">
    <div class="mask flex-center" style="background-color: rgba(0, 0, 0, 0.3)">
      <div class="banner-text text-center fade-in-up">
        <div class="h2">
          
            <span id="subtitle" data-typed-text="项目：学校交流论坛"></span>
          
        </div>

        
          
  <div class="mt-3">
    
    
      <span class="post-meta">
        <i class="iconfont icon-date-fill" aria-hidden="true"></i>
        <time datetime="2022-06-11 21:22" pubdate>
          2022年6月11日 晚上
        </time>
      </span>
    
  </div>

  <div class="mt-1">
    
      <span class="post-meta mr-2">
        <i class="iconfont icon-chart"></i>
        
          104k 字
        
      </span>
    

    

    
    
  </div>


        
      </div>

      
    </div>
  </div>
</div>

</div>

  </header>

  <main>
    
      

<div class="container-fluid nopadding-x">
  <div class="row nomargin-x">
    <div class="side-col d-none d-lg-block col-lg-2">
      

    </div>

    <div class="col-lg-8 nopadding-x-md">
      <div class="container nopadding-x-md" id="board-ctn">
        <div id="board">
          <article class="post-content mx-auto">
            <!-- SEO header -->
            <h1 style="display: none">项目：学校交流论坛</h1>
            
            <div class="markdown-body">
              
              <p>整个Web工程运行的时候碰到奇奇怪怪的问题，先用Maven的clean执行一下</p>
<p>工程端口改为8082，忽略文档里之前写的8080</p>
<p>测试账号和密码：</p>
<table>
<thead>
<tr>
<th>账号</th>
<th>密码</th>
</tr>
</thead>
<tbody><tr>
<td>wanyu</td>
<td>123</td>
</tr>
<tr>
<td>niuke</td>
<td>123</td>
</tr>
<tr>
<td>lihonghe</td>
<td>123</td>
</tr>
</tbody></table>
<h1 id="一、SpringBoot入门：开发社区首页"><a href="#一、SpringBoot入门：开发社区首页" class="headerlink" title="一、SpringBoot入门：开发社区首页"></a>一、SpringBoot入门：开发社区首页</h1><h2 id="1-搭建开发环境"><a href="#1-搭建开发环境" class="headerlink" title="1. 搭建开发环境"></a>1. 搭建开发环境</h2><p>不详细说明，前置课程自行搜索</p>
<ul>
<li>Maven</li>
<li>IDEA</li>
</ul>
<h2 id="2-创建SpringBoot工程"><a href="#2-创建SpringBoot工程" class="headerlink" title="2. 创建SpringBoot工程"></a>2. 创建SpringBoot工程</h2><p>导入的包有：Spring web &#x2F; Thymeleaf &#x2F; Spring Boot DevTools &#x2F;  MySQL &#x2F; MyBatis Framework</p>
<p>配置文件 application.properties</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># 修改ServerProperties里的配置，服务器相关配置</span><br><span class="hljs-attr">server.port</span>=<span class="hljs-string">8080</span><br><span class="hljs-attr">server.servlet.context-path</span>=<span class="hljs-string">/community</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># 修改ThymeleafProperties里的配置  这里是关闭Thymeleaf的缓存</span><br><span class="hljs-attr">spring.thymeleaf.cache</span>=<span class="hljs-string">false</span><br></code></pre></td></tr></table></figure>



<h2 id="3-创建数据库"><a href="#3-创建数据库" class="headerlink" title="3. 创建数据库"></a>3. 创建数据库</h2><p>sql文件：仿牛客论坛\所有素材和源码\第一章素材和源码\素材\community-init-sql-1.5</p>
<p>创建新的数据库命名为community</p>
<p>SQLyog-工具-执行sql脚本-按下面的顺序依次执行3个文件</p>
<ul>
<li>init_schema.sql –&gt; 建表sql</li>
<li>init_data.sql –&gt; 初始化数据库数据SQL</li>
<li>tables_mysql_innodb.sql –&gt; quarter定时任务表SQL（这步前几章暂时用不到）</li>
</ul>
<p>或者在MySQL服务端窗口执行source命令，后面加上文件路径，在1.23MyBatis入门视频的11分钟左右有介绍</p>
<h2 id="4-使用Mybatis"><a href="#4-使用Mybatis" class="headerlink" title="4. 使用Mybatis"></a>4. 使用Mybatis</h2><p>对于Mybatis，建议注解和xml方式都要掌握，不要抗拒使用xml方式，很多公司的老代码都是XML的</p>
<p>首先是数据源和Mybatis的相关配置</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># DataSourceProperties 数据源相关配置</span><br><span class="hljs-attr">spring.datasource.driver-class-name</span>=<span class="hljs-string">com.mysql.cj.jdbc.Driver</span><br><span class="hljs-attr">spring.datasource.url</span>=<span class="hljs-string">jdbc:mysql://localhost:3306/community?characterEncoding=utf-8&amp;useSSL=false&amp;serverTimezone=Hongkong</span><br><span class="hljs-attr">spring.datasource.username</span>=<span class="hljs-string">root</span><br><span class="hljs-attr">spring.datasource.password</span>=<span class="hljs-string">12</span><br><span class="hljs-attr">spring.datasource.hikari.maximum-pool-size</span>=<span class="hljs-string">15</span><br><span class="hljs-attr">spring.datasource.hikari.minimum-idle</span>=<span class="hljs-string">5</span><br><span class="hljs-attr">spring.datasource.hikari.idle-timeout</span>=<span class="hljs-string">30000</span><br><span class="hljs-comment"></span><br><span class="hljs-comment"># MybatisProperties  Mybatis相关配置</span><br><span class="hljs-comment"># 这个是在resources目录下建立mapper文件夹，以后的mappper映射文件写在这里面</span><br><span class="hljs-attr">mybatis.mapper-locations</span>=<span class="hljs-string">classpath:mapper/*.xml</span><br><span class="hljs-comment"># 这个别名设置的路径是在Java的com.wanyu.community下建立entity包，用于放实体类，类似之前学的domain</span><br><span class="hljs-attr">mybatis.type-aliases-package</span>=<span class="hljs-string">com.wanyu.community.entity</span><br><span class="hljs-comment"># 主键是自增长的</span><br><span class="hljs-attr">mybatis.configuration.useGeneratedKeys</span>=<span class="hljs-string">true</span><br><span class="hljs-comment"># 让下划线命名方式和驼峰式命名方式能够自动匹配</span><br><span class="hljs-attr">mybatis.configuration.mapUnderscoreToCamelCase</span>=<span class="hljs-string">true</span><br></code></pre></td></tr></table></figure>



<h3 id="对数据库的uesr表进行CRUD"><a href="#对数据库的uesr表进行CRUD" class="headerlink" title="对数据库的uesr表进行CRUD"></a>对数据库的uesr表进行CRUD</h3><p>这一步需要用到user表，其DDL信息为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `<span class="hljs-keyword">user</span>` (<br>  `id` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `username` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `password` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `salt` <span class="hljs-type">varchar</span>(<span class="hljs-number">50</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `email` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `type` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;0-普通用户; 1-超级管理员; 2-版主;&#x27;</span>,<br>  `status` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;0-未激活; 1-已激活;&#x27;</span>,<br>  `activation_code` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `header_url` <span class="hljs-type">varchar</span>(<span class="hljs-number">200</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `create_time` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  KEY `index_username` (`username`(<span class="hljs-number">20</span>)),<br>  KEY `index_email` (`email`(<span class="hljs-number">20</span>))<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">151</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3<br><br></code></pre></td></tr></table></figure>

<p>这里只需在DAO层进行开发：</p>
<p>(1) 在entity包创建User类</p>
<p>(2) 在dao包创建UserMapper接口，定义接口内的CRUD方法，不要忘记@Mapper注解</p>
<p>(3) 在resources目录下建立mapper文件夹，创建user-mapper.xml的映射文件，并编写xml文件中的sql语句，有几个注意点：</p>
<ul>
<li><p>养成习惯尽量不要写 select * ….</p>
</li>
<li><p>可以用<sql>标签先封装查询或者插入的字段，降低耦合性</p>
</li>
<li><p>每条sql语句的id要和UserMapper里的方法对应好</p>
</li>
<li><p>为了方便调试，把日志级别改为debug，可以方便看到日志中的sql语句</p>
  <figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">logging.level.com.nowcoder.community</span>=<span class="hljs-string">debug</span><br></code></pre></td></tr></table></figure></li>
</ul>
<p>(4) 测试，一定要养成测试的好习惯</p>
<h2 id="5-开发社区首页"><a href="#5-开发社区首页" class="headerlink" title="5. 开发社区首页"></a>5. 开发社区首页</h2><p>严格按照三层架构模式开发，这里的社区首页其实就是分页展示一下全部的帖子，暂时的业务理解是：拉黑的帖子不展示，置顶的帖子放在前面，创建时间越新帖子的越放在上面</p>
<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch1%E5%8A%9F%E8%83%BD%E6%8F%8F%E8%BF%B0-%E5%BC%80%E5%8F%91%E7%A4%BE%E5%8C%BA%E9%A6%96%E9%A1%B5.png" srcset="/img/loading.gif" lazyload alt="image-20220515233645800"></p>
<h3 id="5-1-数据访问层"><a href="#5-1-数据访问层" class="headerlink" title="5.1 数据访问层"></a>5.1 数据访问层</h3><p>这一步需要用到discuss_post表，其DDL信息为：</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">CREATE</span> <span class="hljs-keyword">TABLE</span> `discuss_post` (<br>  `id` <span class="hljs-type">int</span> <span class="hljs-keyword">NOT</span> <span class="hljs-keyword">NULL</span> AUTO_INCREMENT,<br>  `user_id` <span class="hljs-type">varchar</span>(<span class="hljs-number">45</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `title` <span class="hljs-type">varchar</span>(<span class="hljs-number">100</span>) <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `content` text,<br>  `type` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;0-普通; 1-置顶;&#x27;</span>,<br>  `status` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span> COMMENT <span class="hljs-string">&#x27;0-正常; 1-精华; 2-拉黑;&#x27;</span>,<br>  `create_time` <span class="hljs-type">timestamp</span> <span class="hljs-keyword">NULL</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `comment_count` <span class="hljs-type">int</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  `score` <span class="hljs-keyword">double</span> <span class="hljs-keyword">DEFAULT</span> <span class="hljs-keyword">NULL</span>,<br>  <span class="hljs-keyword">PRIMARY</span> KEY (`id`),<br>  KEY `index_user_id` (`user_id`)<br>) ENGINE<span class="hljs-operator">=</span>InnoDB AUTO_INCREMENT<span class="hljs-operator">=</span><span class="hljs-number">281</span> <span class="hljs-keyword">DEFAULT</span> CHARSET<span class="hljs-operator">=</span>utf8mb3<br></code></pre></td></tr></table></figure>

<p>(1) 在entity包创建DiscussPost类</p>
<p>(2) 在dao包创建DiscussPostMapper接口，定义接口内的查询方法。有几个注意点：</p>
<ul>
<li>首页查询的帖子要写成分页的格式</li>
<li>如果定义的方法里只有一个参数，并且在<if>等动态sql标签里使用,则必须要加别名，可以用@Param注解</li>
</ul>
<p>(3) 在resources-mapper文件夹，创建discusspost-mapper.xml的映射文件，这其中有些简单的业务理解.</p>
<p>下面的selectDiscussPosts语句中，status&#x3D;2表明这是拉黑的帖子，所以不让他显示。userId不等于0，则就是显示所有没被拉黑的帖子，如果传入了userId，就是查看对应userId这个用户发的所有的帖子。排序策略为：置顶的帖子放在前面，创建时间越新帖子的越放在上面</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectDiscussPosts&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;DiscussPost&quot;</span>&gt;</span><br>    select <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;selectFields&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>    from discuss_post<br>    where status != 2<br>    <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;userId!=0&quot;</span>&gt;</span><br>        and user_id = #&#123;userId&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    order by type desc, create_time desc<br>    limit #&#123;offset&#125;, #&#123;limit&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>(4) 测试</p>
<h3 id="5-2-业务层"><a href="#5-2-业务层" class="headerlink" title="5.2 业务层"></a>5.2 业务层</h3><p>(1) service包创建DiscussPostService，在其中编写业务代码，虽然暂时都只是简单的调用DAO层接口，但还是要分层编写。有一个注意点是：</p>
<ul>
<li><p>分页查询帖子的时候，查询的是外键userId。但我们查询网页的时候显然不能显示userId，而是显示用户名，所以需要根据userId查询user表的用户名</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> List&lt;DiscussPost&gt; <span class="hljs-title function_">findDiscussPosts</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> offset, <span class="hljs-type">int</span> limit)</span> &#123;<br>    <span class="hljs-keyword">return</span> discussPostMapper.selectDiscussPosts(userId, offset, limit);<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
<p>​        有两种解决办法，一种是sql查询的时候关联查询用户，还有一种就是单独再写一个查询，用userId查询到用户名，然后和帖子查询结果拼到一起。此处采用的是后者，看起来麻烦一下，但是为了方便后续Redis使用缓存，提高性能</p>
<p>(2) 所以第二步是在service包再创建UserService，编写方法实现用userId查询到用户名</p>
<h3 id="5-3-表现层"><a href="#5-3-表现层" class="headerlink" title="5.3 表现层"></a>5.3 表现层</h3><p>这里需要用到前端的资源，将第1章素材和源码\素材\nowcoder-sql-1.6\nowcoder中的css&#x2F;img&#x2F;js都拷贝到工程resources下的static，将mail&#x2F;site&#x2F;index.html拷贝到templates中。本小节中只需要用到index.html</p>
<p><strong>(1)</strong> 分页作为非常常用的操作，最好能将其封装好，方便复用。在entity实体类下新建Page类（Mybatis是不自带Page类的，虽然其有PageHelper，但需要额外导入，MybatisPlus好像是自带 Ipage对象）。Page类具体有哪些属性和方法去代码里看，注释比较详细了</p>
<p><strong>(2)</strong> 在controller层创建HomeController.java，编写controller层代码，也有几个注意点</p>
<ul>
<li>我们希望Springmvc返回的是视图，所以可以在编写方法时，将Model直接传入，spring会帮我们自动实例化Model</li>
<li>上文提到的查询帖子的同时还查询用户名，可以用Map集合来解决，自动注入DiscussPostService和UserService，然后调用它们的方法解决，具体的见代码</li>
</ul>
<p><strong>(3)</strong> 在template添加的index.html是我们主要改写的文件，首先需要指定我们使用的模板引擎是thymeleaf</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span> <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>有些依赖资源如果是相对路径也需要<strong>用thymeleaf的语法</strong>去更改，让他去resources文件夹下的指定地方去查找</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;/css/global.css&#125;&quot;</span> /&gt;</span><br>......<br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">th:src</span>=<span class="hljs-string">&quot;@&#123;/js/global.js&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">th:src</span>=<span class="hljs-string">&quot;@&#123;js/index.js&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p><a href="">这个地方的第四行js前面不用加斜线吗</a>   好像不加也可以的样子，暂时不管</p>
<p>然后将html的纯静态页面转为基于thymeleaf模板的动态页面，本小节只需要更改帖子列表和分页部分内容，让th循环展示上文定义的map集合里的内容，包括分页的thymeleaf语法，比较复杂，具体写法见代码了，前端代码此处不过多介绍，不是本项目重点，在视频1.6节中有。</p>
<p>(4) 启动服务器，测试功能，url：<a target="_blank" rel="noopener" href="http://localhost:8080/community/index">http://localhost:8080/community/index</a></p>
<p>此处发现的bug是分页功能只有在点首页、尾页、上一页和下一页时有效，点到具体的页数时是不发生跳转的</p>
<h2 id="6-项目调试技巧"><a href="#6-项目调试技巧" class="headerlink" title="6. 项目调试技巧"></a>6. 项目调试技巧</h2><p>(1) 根据状态码初步定位到问题在哪里</p>
<p>(2) 服务端断点调试技巧，就是IDEA里的调试，不过多介绍</p>
<p>(3) 客户端断点调试技巧，是在浏览器开发者工具里进行调试，主要是前端工程师调试，不过多介绍</p>
<p>(4) 设置日志级别，并将日志输出到不同的终端</p>
<p>在测试文件夹中添加 LoggerTests 文件进行测试，加入下面这两个注解，保持和主文件的配置条件相同</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RunWith(SpringRunner.class)</span><br><span class="hljs-meta">@ContextConfiguration(classes = CommunityApplication.class)</span><br></code></pre></td></tr></table></figure>

<p>随后在application.properties里添加logger级别</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">logging.level.com.wanyu.community</span>=<span class="hljs-string">debug</span><br></code></pre></td></tr></table></figure>

<p>这样只会打印 设置级别在内的及以上的日志级别。平常常用的是<strong>debug、info、error</strong>三个级别</p>
<p>日志默认会打印到控制台，我们需要将日志保存到文件里，添加以下配置。</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">logging.file</span>=<span class="hljs-string">d:/work/data/nowcoder/community.log # 日志文件存储路径</span><br></code></pre></td></tr></table></figure>

<p>实际开发的时候肯定会更加复杂，视频1.38最后也讲解了一部分，此处略过</p>
<h1 id="二、SpringBoot实践：开发社区登录模块"><a href="#二、SpringBoot实践：开发社区登录模块" class="headerlink" title="二、SpringBoot实践：开发社区登录模块"></a>二、SpringBoot实践：开发社区登录模块</h1><h2 id="1-发送邮件"><a href="#1-发送邮件" class="headerlink" title="1. 发送邮件"></a>1. 发送邮件</h2><p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch2%E5%8A%9F%E8%83%BD%E6%8F%8F%E8%BF%B0-%E5%8F%91%E9%80%81%E9%82%AE%E4%BB%B6.png" srcset="/img/loading.gif" lazyload alt="image-20220515233948785"></p>
<p>常见的发送邮件功能，学过Springboot整合Mail的话应该很容易</p>
<p>（1）导入坐标</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.springframework.boot<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>spring-boot-starter-mail<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>（2）邮箱参数配置（邮箱需要启用SMTP）</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">spring.mail.host</span>=<span class="hljs-string">smtp.163.com</span><br><span class="hljs-attr">spring.mail.username</span>=<span class="hljs-string">xxxx@163.com</span><br><span class="hljs-attr">spring.mail.password</span>=<span class="hljs-string">xxxx</span><br></code></pre></td></tr></table></figure>

<p>（3）编写发送邮件的基础功能，使用JavaMailSender发送邮件</p>
<p>代码：util-MailClient.class</p>
<p>没有过多要说的，就是调用接口</p>
<p>（4） 使用Thymeleaf生成模板引擎发送邮件</p>
<p>其实也就是用JavaMailSender发送HTML格式的文本，此处Thymeleaf这个模板引擎用的不是太熟，本质上就是用模板引擎去生成HTML</p>
<p>在resources-templates-mail创建demo.html文件，以此为模板发送邮件</p>
<p>（5）测试类里进行测试</p>
<p>具体的见代码就行，MailTests.java</p>
<h2 id="2-开发注册功能"><a href="#2-开发注册功能" class="headerlink" title="2. 开发注册功能"></a>2. 开发注册功能</h2><p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch2%E5%8A%9F%E8%83%BD%E6%8F%8F%E8%BF%B0-%E5%BC%80%E5%8F%91%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD.png" srcset="/img/loading.gif" lazyload alt="image-20220515234118380"></p>
<h3 id="2-1-访问注册页面"><a href="#2-1-访问注册页面" class="headerlink" title="2.1 访问注册页面"></a>2.1 访问注册页面</h3><p>（1）在controller包下创建LoginController表现层代码，编写基本的请求处理代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginController</span>&#123;<br><br>    <span class="hljs-meta">@RequestMapping(path = &quot;/register&quot;, method = RequestMethod.GET)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getRegisterPage</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/register&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（2）更改templates-site-register.html，使其符合thymeleaf模板的语法，主要是开头引入、相对路径资源</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">html</span> <span class="hljs-attr">lang</span>=<span class="hljs-string">&quot;en&quot;</span> <span class="hljs-attr">xmlns:th</span>=<span class="hljs-string">&quot;http://www.thymeleaf.org&quot;</span>&gt;</span><br>......<br>   <span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;/css/global.css&#125;&quot;</span> /&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">link</span> <span class="hljs-attr">rel</span>=<span class="hljs-string">&quot;stylesheet&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;/css/login.css&#125;&quot;</span> /&gt;</span><br>   ......<br>   <span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">th:src</span>=<span class="hljs-string">&quot;@&#123;/js/global.js&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span> <span class="hljs-attr">th:src</span>=<span class="hljs-string">&quot;@&#123;/js/register.js&#125;&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>（3）访问注册页面，是从首页的导航栏中点击的，所以去更改<code>index.html</code>中头部的功能部分，把首页、注册和登录三个部分的相对路径资源改成thymeleaf的形式，其他地方本小节用不到，暂时不用改</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nav-item ml-3 btn-group-vertical&quot;</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nav-link&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;/index&#125;&quot;</span>&gt;</span>首页<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nav-item ml-3 btn-group-vertical&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nav-link&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;/register&#125;&quot;</span>&gt;</span>注册<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">li</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nav-item ml-3 btn-group-vertical&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;nav-link&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;/login&#125;&quot;</span>&gt;</span>登录<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">li</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>（4）标签复用</p>
<p>因为最终的网页呈现形式中，头部的信息是一直要显示的，所以最好能改成能复用的，thymeleaf也是支持这一点</p>
<p>在<code>index.html</code>中，头部标签上加上属性<code>th:fragment</code>，将其命名为header，这样在其他的html文件里就可以复用这一段程序</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!-- 头部 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;bg-dark sticky-top&quot;</span> <span class="hljs-attr">th:fragment</span>=<span class="hljs-string">&quot;header&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在其他html文件里如何复用这一段程序，只需要加上标签<code>th:replace</code>，比如在register.html中，更改头部标签</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">header</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;bg-dark sticky-top&quot;</span> <span class="hljs-attr">th:replace</span>=<span class="hljs-string">&quot;index::header&quot;</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>（5）测试，启动项目，访问<a target="_blank" rel="noopener" href="http://localhost:8080/community/index%EF%BC%8C%E7%82%B9%E5%87%BB%E6%B3%A8%E5%86%8C%E6%8C%89%E9%92%AE%EF%BC%8C%E6%B2%A1%E6%9C%89%E9%97%AE%E9%A2%98%E7%9A%84%E8%AF%9D%E5%8F%AF%E4%BB%A5%E6%88%90%E5%8A%9F%E8%AE%BF%E9%97%AE%E6%B3%A8%E5%86%8C%E9%A1%B5%E9%9D%A2%EF%BC%8C%E4%B9%9F%E5%8F%AF%E4%BB%A5%E7%82%B9%E5%87%BB%E9%A6%96%E9%A1%B5%E6%8C%89%E9%92%AE%E5%9B%9E%E5%88%B0%E9%A6%96%E9%A1%B5">http://localhost:8080/community/index，点击注册按钮，没有问题的话可以成功访问注册页面，也可以点击首页按钮回到首页</a></p>
<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/%E5%BC%80%E5%8F%91%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD-%E8%AE%BF%E9%97%AE%E6%B3%A8%E5%86%8C%E9%A1%B5%E9%9D%A2.png" srcset="/img/loading.gif" lazyload alt="image-20220419224525412"></p>
<h3 id="2-2-提交注册数据"><a href="#2-2-提交注册数据" class="headerlink" title="2.2 提交注册数据"></a>2.2 提交注册数据</h3><h4 id="工具类"><a href="#工具类" class="headerlink" title="工具类"></a>工具类</h4><p>（1）为了更好对<strong>字符串、集合空值</strong>的情况进行检测，我们需要额外引入一个包<code>commons-lang3</code>，以后也是经常用</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>org.apache.commons<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>commons-lang3<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>（2）在配置文件里配置本机域名，因为发邮件链接激活的时候肯定得访问社区网站来进行激活，所以需要配置一下，真正开发中，当然不可能是本机域名，此处暂时用</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># community</span><br><span class="hljs-attr">community.path.domain</span>=<span class="hljs-string">http://localhost:8080</span><br></code></pre></td></tr></table></figure>

<p>（3）为了更好的复用功能，编写一些工具类，在util包下创建CommunityUtil类</p>
<ul>
<li>首先是生成随机字符串，Java中的util包自带UUID可以实现，我们需要进行简单的封装</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 生成随机字符串</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">generateUUID</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> UUID.randomUUID().toString().replaceAll(<span class="hljs-string">&quot;-&quot;</span>, <span class="hljs-string">&quot;&quot;</span>); <span class="hljs-comment">// 不需要横线，只要字母数字</span><br>&#125;<br></code></pre></td></tr></table></figure>

<ul>
<li>对密码进行MD5加密，为了提高安全性，使用加盐加密，即用一段随机的字符串拼接在用户传入的密码中，再进行MD5加密</li>
</ul>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">md5</span><span class="hljs-params">(String key)</span> &#123;<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(key)) &#123;   <span class="hljs-comment">// commons.lang3中非常好用的判断空值</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> DigestUtils.md5DigestAsHex(key.getBytes());  <span class="hljs-comment">// md5DigestAsHex将传入的参数加密为16进制</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="业务层"><a href="#业务层" class="headerlink" title="业务层"></a>业务层</h4><p>（4）注册功能业务层上是对User业务的编写，所以需要编写UserService，由于注册业务需要向用户邮箱发邮件，并且发送是Thymeleaf引擎得到的html，所以要将邮件类、模板引擎、域名、项目名全部注入进来。注意非Bean类型的需要用@Value注解得到，这一部分就是如何获取配置文件里的值，可以去找找SpringBoot教程看看</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> MailClient mailClient;<br><br><span class="hljs-meta">@Autowired</span><br><span class="hljs-keyword">private</span> TemplateEngine templateEngine;<br><br><span class="hljs-meta">@Value(&quot;$&#123;community.path.domain&#125;&quot;)</span>  <span class="hljs-comment">// community.path.domain=http://localhost:8080</span><br><span class="hljs-keyword">private</span> String domain;<br><br><span class="hljs-meta">@Value(&quot;$&#123;server.servlet.context-path&#125;&quot;)</span> <span class="hljs-comment">// server.servlet.context-path=/community</span><br><span class="hljs-keyword">private</span> String contextPath;<br></code></pre></td></tr></table></figure>

<p>再对业务进行编写，如空值判断处理、账号或邮箱重复判断、注册用户（即将用户提交的信息再加上一些处理存到数据库里） 注册方法返回值是一个map，里面主要封装一些错误消息，比如账号密码为空等消息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">register</span><span class="hljs-params">(User user)</span> &#123;<br>    Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-comment">// 空值处理</span><br>    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;参数不能为空!&quot;</span>);<br>    &#125;<br>    <span class="hljs-comment">// 账号密码邮箱为空其实前端一般也会判断，这里只是应有的逻辑</span><br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(user.getUsername())) &#123;<br>        map.put(<span class="hljs-string">&quot;usernameMsg&quot;</span>, <span class="hljs-string">&quot;账号不能为空!&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(user.getPassword())) &#123;<br>        map.put(<span class="hljs-string">&quot;passwordMsg&quot;</span>, <span class="hljs-string">&quot;密码不能为空!&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(user.getEmail())) &#123;<br>        map.put(<span class="hljs-string">&quot;emailMsg&quot;</span>, <span class="hljs-string">&quot;邮箱不能为空!&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br><br>    <span class="hljs-comment">// 验证账号，账号如果重复就直接返回map</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> userMapper.selectByName(user.getUsername());<br>    <span class="hljs-keyword">if</span> (u != <span class="hljs-literal">null</span>) &#123;<br>        map.put(<span class="hljs-string">&quot;usernameMsg&quot;</span>, <span class="hljs-string">&quot;该账号已存在!&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br><br>    <span class="hljs-comment">// 验证邮箱</span><br>    u = userMapper.selectByEmail(user.getEmail());<br>    <span class="hljs-keyword">if</span> (u != <span class="hljs-literal">null</span>) &#123;<br>        map.put(<span class="hljs-string">&quot;emailMsg&quot;</span>, <span class="hljs-string">&quot;该邮箱已被注册!&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br><br>    <span class="hljs-comment">// 注册用户，即将用户提交的信息再加上一些处理存到数据库里</span><br>    user.setSalt(CommunityUtil.generateUUID().substring(<span class="hljs-number">0</span>, <span class="hljs-number">5</span>));<br>    user.setPassword(CommunityUtil.md5(user.getPassword() + user.getSalt()));<br>    user.setType(<span class="hljs-number">0</span>);<br>    user.setStatus(<span class="hljs-number">0</span>);  <span class="hljs-comment">// 注册未激活状态码是0</span><br>    user.setActivationCode(CommunityUtil.generateUUID());  <span class="hljs-comment">// 激活码就是一个随机字符串</span><br>    user.setHeaderUrl(String.format(<span class="hljs-string">&quot;http://images.nowcoder.com/head/%dt.png&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Random</span>().nextInt(<span class="hljs-number">1000</span>))); <span class="hljs-comment">// 设置随机的头像图片，这是牛客网自带的</span><br>    user.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    userMapper.insertUser(user);<br>    ...<br>    <span class="hljs-keyword">return</span> map;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>（5）注册功能是包含发送激活邮件的，显然需要发送一个html格式的文本，需要用到模板，其位置为templates-mail-activation.html，并将其改造成模板。部分位置设置为可变的</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">body</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">div</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>			<span class="hljs-tag">&lt;<span class="hljs-name">b</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;email&#125;&quot;</span>&gt;</span>xxx@xxx.com<span class="hljs-tag">&lt;/<span class="hljs-name">b</span>&gt;</span>, 您好!<br>		<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>		<span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>			您正在注册牛客网, 这是一封激活邮件, 请点击 <br>			<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;$&#123;url&#125;&quot;</span>&gt;</span>此链接<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>,<br>			激活您的牛客账号!<br>		<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>	<span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">body</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>如果后续激活邮件成功发送，其图片如下，如果鼠标悬停在此链接上，左下角会出现url</p>
<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/%E5%BC%80%E5%8F%91%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD-%E6%8F%90%E4%BA%A4%E6%B3%A8%E5%86%8C%E6%95%B0%E6%8D%AE-%E5%8F%91%E9%80%81%E6%BF%80%E6%B4%BB%E9%82%AE%E4%BB%B6.png" srcset="/img/loading.gif" lazyload alt="image-20220419225515323"></p>
<p>（6）再编写激活邮件功能，可以理解为是将发送邮件部分的测试代码改写到此处，用到了thymeleaf的context，process等对象和方法，需要多熟练使用。其中email和url需要动态的设置，注意url拼接的思路</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">register</span><span class="hljs-params">(User user)</span> &#123;<br>	...<br>    <span class="hljs-comment">// 激活邮件</span><br>    <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Context</span>();<br>    context.setVariable(<span class="hljs-string">&quot;email&quot;</span>, user.getEmail());<br>    <span class="hljs-comment">// http://localhost:8080/community/activation/101/code</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">url</span> <span class="hljs-operator">=</span> domain + contextPath + <span class="hljs-string">&quot;/activation/&quot;</span> + user.getId() + <span class="hljs-string">&quot;/&quot;</span> + user.getActivationCode();<br>    context.setVariable(<span class="hljs-string">&quot;url&quot;</span>, url);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> templateEngine.process(<span class="hljs-string">&quot;/mail/activation&quot;</span>, context);<br>    mailClient.sendMail(user.getEmail(), <span class="hljs-string">&quot;激活账号&quot;</span>, content);<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="表现层"><a href="#表现层" class="headerlink" title="表现层"></a>表现层</h4><p>（7）后面需要在表现层继续开发，在LoginController里编写register，编写表现层代码，添加返回各种模型视图。</p>
<p><strong>注意此处的表现层逻辑：</strong></p>
<ul>
<li><p>如果UserService.register返回的map没有消息表明没有问题，则返回一个操作成功的界面，其位置在templates-mail-operate-result.html，然后跳转到首页，不能跳转到激活页面，因为还没有激活</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping(path = &quot;/register&quot;, method = RequestMethod.POST)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">register</span><span class="hljs-params">(Model model, User user)</span> &#123;<br>    Map&lt;String, Object&gt; map = userService.register(user);<br>    <span class="hljs-keyword">if</span> (map == <span class="hljs-literal">null</span> || map.isEmpty()) &#123; <span class="hljs-comment">// map没有消息表明没有问题</span><br>        model.addAttribute(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;注册成功,我们已经向您的邮箱发送了一封激活邮件,请尽快激活!&quot;</span>);<br>        model.addAttribute(<span class="hljs-string">&quot;target&quot;</span>, <span class="hljs-string">&quot;/index&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/operate-result&quot;</span>;<br>    &#125;<br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>  前端代码为：</p>
  <figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-comment">&lt;!-- 内容 --&gt;</span><br><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;main&quot;</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;container mt-5&quot;</span>&gt;</span><br>        <span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;jumbotron&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;lead&quot;</span> <span class="hljs-attr">th:text</span>=<span class="hljs-string">&quot;$&#123;msg&#125;&quot;</span>&gt;</span>您的账号已经激活成功,可以正常使用了!<span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">hr</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;my-4&quot;</span>&gt;</span><br>            <span class="hljs-tag">&lt;<span class="hljs-name">p</span>&gt;</span><br>                系统会在 <span class="hljs-tag">&lt;<span class="hljs-name">span</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;seconds&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;text-danger&quot;</span>&gt;</span>8<span class="hljs-tag">&lt;/<span class="hljs-name">span</span>&gt;</span> 秒后自动跳转,<br>                您也可以点此 <span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;target&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;$&#123;target&#125;&#125;&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;text-primary&quot;</span>&gt;</span>链接<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span>, 手动跳转!<br>            <span class="hljs-tag">&lt;/<span class="hljs-name">p</span>&gt;</span><br>        <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>  如果注册成功则展示如下页面：</p>
<p>  <img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/%E5%BC%80%E5%8F%91%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD-%E6%8F%90%E4%BA%A4%E6%B3%A8%E5%86%8C%E6%95%B0%E6%8D%AE-%E6%88%90%E5%8A%9F%E8%BF%94%E5%9B%9E.png" srcset="/img/loading.gif" lazyload alt="123"></p>
</li>
<li><p>如果返回的map有消息表明有问题，那还是返回注册页面，并提示错误信息</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping(path = &quot;/register&quot;, method = RequestMethod.POST)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">register</span><span class="hljs-params">(Model model, User user)</span> &#123;<br>    Map&lt;String, Object&gt; map = userService.register(user);<br>    <span class="hljs-keyword">if</span> (map == <span class="hljs-literal">null</span> || map.isEmpty()) &#123; <span class="hljs-comment">// map没有消息表明没有问题</span><br>		...<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        model.addAttribute(<span class="hljs-string">&quot;usernameMsg&quot;</span>, map.get(<span class="hljs-string">&quot;usernameMsg&quot;</span>));<br>        model.addAttribute(<span class="hljs-string">&quot;passwordMsg&quot;</span>, map.get(<span class="hljs-string">&quot;passwordMsg&quot;</span>));<br>        model.addAttribute(<span class="hljs-string">&quot;emailMsg&quot;</span>, map.get(<span class="hljs-string">&quot;emailMsg&quot;</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/register&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>  如果注册失败，则返回如下界面</p>
  <img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/%E5%BC%80%E5%8F%91%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD-%E6%8F%90%E4%BA%A4%E6%B3%A8%E5%86%8C%E6%95%B0%E6%8D%AE-%E5%A4%B1%E8%B4%A5%E8%BF%94%E5%9B%9E.png" srcset="/img/loading.gif" lazyload alt="image-20220419223710394" style="zoom: 80%;" /></li>
</ul>
<p>（8）此时可以去进行测试，看是否能够注册成功，包括用户名、邮箱重复的一些检测</p>
<h3 id="2-3-激活注册账号"><a href="#2-3-激活注册账号" class="headerlink" title="2.3 激活注册账号"></a>2.3 激活注册账号</h3><p>（1）激活有三种结果：成功、重复激活、失败，可以将这三种状态设为常量，写成接口放在util包里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CommunityConstant</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">ACTIVATION_SUCCESS</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;  <span class="hljs-comment">// 激活成功</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">ACTIVATION_REPEAT</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;   <span class="hljs-comment">// 重复激活</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">ACTIVATION_FAILURE</span> <span class="hljs-operator">=</span> <span class="hljs-number">2</span>;  <span class="hljs-comment">// 激活失败</span><br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="业务层-1"><a href="#业务层-1" class="headerlink" title="业务层"></a>业务层</h4><p>（2）在UserService里编写激活代码，让其实现上述接口，业务层激活代码的逻辑就是邮件链接里的激活码和根据用户id查到的激活码是否相等。根据不同的情况，返回状态码，注意让UserService实现CommunityConstant接口</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserService</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CommunityConstant</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">activation</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String code)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(userId);<br>        <span class="hljs-keyword">if</span> (user.getStatus() == <span class="hljs-number">1</span>) &#123;  <span class="hljs-comment">// 激活成功为1，如果还是等于1，那就是重复激活</span><br>            <span class="hljs-keyword">return</span> ACTIVATION_REPEAT;<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (user.getActivationCode().equals(code)) &#123; <span class="hljs-comment">// 激活成功将状态设为1</span><br>            userMapper.updateStatus(userId, <span class="hljs-number">1</span>);<br>            <span class="hljs-keyword">return</span> ACTIVATION_SUCCESS;<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            <span class="hljs-keyword">return</span> ACTIVATION_FAILURE;  <span class="hljs-comment">// 激活失败</span><br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h4 id="表现层-1"><a href="#表现层-1" class="headerlink" title="表现层"></a>表现层</h4><p>（3）在LoginController里编写激活代码，也让其实现上述接口，根据状态码返回激活成功或失败的提示页面。返回的html页面还是之前的operate-result.html，放置提示消息和跳转页面。如果激活成功跳转到登陆界面，如果重复激活或者激活失败，跳转到首页。</p>
<p>注意当用户点击邮件里的链接时，是去访问类似于：&#x2F;&#x2F; <a target="_blank" rel="noopener" href="http://localhost:8080/community/activation/101/code%EF%BC%8C%E5%A6%82%E4%BD%95%E4%BB%8E%E8%BF%99%E4%B8%AAurl%E8%8E%B7%E5%8F%96%E7%94%A8%E4%BA%8E%E5%88%A4%E6%96%AD%E6%BF%80%E6%B4%BB%E7%9A%84%E4%BF%A1%E6%81%AF%EF%BC%8C%E6%98%AF%E9%80%9A%E8%BF%87**%E6%B3%A8%E8%A7%A3@PathVariable">http://localhost:8080/community/activation/101/code，如何从这个url获取用于判断激活的信息，是通过**注解@PathVariable</a>**</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// http://localhost:8080/community/activation/101/code</span><br><span class="hljs-meta">@RequestMapping(path = &quot;/activation/&#123;userId&#125;/&#123;code&#125;&quot;, method = RequestMethod.GET)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">activation</span><span class="hljs-params">(Model model, <span class="hljs-meta">@PathVariable(&quot;userId&quot;)</span> <span class="hljs-type">int</span> userId, <span class="hljs-meta">@PathVariable(&quot;code&quot;)</span> String code)</span> &#123;<br>    <span class="hljs-type">int</span> <span class="hljs-variable">result</span> <span class="hljs-operator">=</span> userService.activation(userId, code);<br>    <span class="hljs-keyword">if</span> (result == ACTIVATION_SUCCESS) &#123;<br>        model.addAttribute(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;激活成功,您的账号已经可以正常使用了!&quot;</span>);<br>        model.addAttribute(<span class="hljs-string">&quot;target&quot;</span>, <span class="hljs-string">&quot;/login&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (result == ACTIVATION_REPEAT) &#123;<br>        model.addAttribute(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;无效操作,该账号已经激活过了!&quot;</span>);<br>        model.addAttribute(<span class="hljs-string">&quot;target&quot;</span>, <span class="hljs-string">&quot;/index&quot;</span>);<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        model.addAttribute(<span class="hljs-string">&quot;msg&quot;</span>, <span class="hljs-string">&quot;激活失败,您提供的激活码不正确!&quot;</span>);<br>        model.addAttribute(<span class="hljs-string">&quot;target&quot;</span>, <span class="hljs-string">&quot;/index&quot;</span>);<br>    &#125;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/operate-result&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最终的返回页面为下面的提示信息页面（此截图是重复激活的页面）</p>
<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/%E5%BC%80%E5%8F%91%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD-%E6%BF%80%E6%B4%BB%E6%B3%A8%E5%86%8C%E8%B4%A6%E5%8F%B7-%E9%87%8D%E5%A4%8D%E6%BF%80%E6%B4%BB.png" srcset="/img/loading.gif" lazyload alt="image-20220419230640666"></p>
<p>测试账号：wanyu </p>
<p>测试密码：123</p>
<h2 id="3-会话管理"><a href="#3-会话管理" class="headerlink" title="3. 会话管理"></a>3. 会话管理</h2><p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch2%E5%8A%9F%E8%83%BD%E6%8F%8F%E8%BF%B0-%E4%BC%9A%E8%AF%9D%E7%AE%A1%E7%90%86.png" srcset="/img/loading.gif" lazyload alt="image-20220515234540596"></p>
<p>这一部分是开发登录功能的前置知识，cookie和session</p>
<p>cookie是客户端会话技术，将数据保存到客户端，以后每次请求都携带Cookie数据进行访问。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// Springboot使用cookie示例</span><br><br><span class="hljs-meta">@RequestMapping(path = &quot;/cookie/set&quot;, method = RequestMethod.GET)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-comment">// 形参传入HttpServletResponse，Springmvc会自动使用</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">setCookie</span><span class="hljs-params">(HttpServletResponse response)</span> &#123;<br>    <span class="hljs-comment">// 创建cookie</span><br>    <span class="hljs-type">Cookie</span> <span class="hljs-variable">cookie</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cookie</span>(<span class="hljs-string">&quot;code&quot;</span>, CommunityUtil.generateUUID());<br>    <span class="hljs-comment">// 设置cookie生效的范围</span><br>    cookie.setPath(<span class="hljs-string">&quot;/community/alpha&quot;</span>);<br>    <span class="hljs-comment">// 设置cookie的生存时间</span><br>    cookie.setMaxAge(<span class="hljs-number">60</span> * <span class="hljs-number">10</span>);<br>    <span class="hljs-comment">// 发送cookie</span><br>    response.addCookie(cookie);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;set cookie&quot;</span>;<br>&#125;<br><br><span class="hljs-meta">@RequestMapping(path = &quot;/cookie/get&quot;, method = RequestMethod.GET)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getCookie</span><span class="hljs-params">(<span class="hljs-meta">@CookieValue(&quot;code&quot;)</span> String code)</span> &#123;<br>    System.out.println(code);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;get cookie&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>Session是服务端会话跟踪技术：将数据保存到服务端。</p>
<p>Cookie是存储在客户端，存储在客户端的数据容易被窃取和截获，存在很多不安全的因素，存储在服务端的数据相比于客户端来说就更安全</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// Springboot使用session示例</span><br><span class="hljs-meta">@RequestMapping(path = &quot;/session/set&quot;, method = RequestMethod.GET)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">setSession</span><span class="hljs-params">(HttpSession session)</span> &#123;<br>    session.setAttribute(<span class="hljs-string">&quot;id&quot;</span>, <span class="hljs-number">1</span>);<br>    session.setAttribute(<span class="hljs-string">&quot;name&quot;</span>, <span class="hljs-string">&quot;Test&quot;</span>);<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;set session&quot;</span>;<br>&#125;<br><br><span class="hljs-meta">@RequestMapping(path = &quot;/session/get&quot;, method = RequestMethod.GET)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSession</span><span class="hljs-params">(HttpSession session)</span> &#123;<br>    System.out.println(session.getAttribute(<span class="hljs-string">&quot;id&quot;</span>));<br>    System.out.println(session.getAttribute(<span class="hljs-string">&quot;name&quot;</span>));<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;get session&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="4-生成验证码"><a href="#4-生成验证码" class="headerlink" title="4. 生成验证码"></a>4. 生成验证码</h2><p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch2%E5%8A%9F%E8%83%BD%E6%8F%8F%E8%BF%B0-%E7%94%9F%E6%88%90%E9%AA%8C%E8%AF%81%E7%A0%81.png" srcset="/img/loading.gif" lazyload alt="image-20220515234653426"></p>
<p>Kaptcha包有现成的验证码功能，本项目导入这个包来使用</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">dependency</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">groupId</span>&gt;</span>com.github.penggle<span class="hljs-tag">&lt;/<span class="hljs-name">groupId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">artifactId</span>&gt;</span>kaptcha<span class="hljs-tag">&lt;/<span class="hljs-name">artifactId</span>&gt;</span><br>    <span class="hljs-tag">&lt;<span class="hljs-name">version</span>&gt;</span>2.3.2<span class="hljs-tag">&lt;/<span class="hljs-name">version</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">dependency</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在config包下编写Kaptcha的配置文件，将其作为bean</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KaptchaConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> Producer <span class="hljs-title function_">kaptchaProducer</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-type">Properties</span> <span class="hljs-variable">properties</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Properties</span>();<br>        properties.setProperty(<span class="hljs-string">&quot;kaptcha.image.width&quot;</span>, <span class="hljs-string">&quot;100&quot;</span>);<br>        properties.setProperty(<span class="hljs-string">&quot;kaptcha.image.height&quot;</span>, <span class="hljs-string">&quot;40&quot;</span>);<br>        properties.setProperty(<span class="hljs-string">&quot;kaptcha.textproducer.font.size&quot;</span>, <span class="hljs-string">&quot;32&quot;</span>);<br>        properties.setProperty(<span class="hljs-string">&quot;kaptcha.textproducer.font.color&quot;</span>, <span class="hljs-string">&quot;0,0,0&quot;</span>);<br>        properties.setProperty(<span class="hljs-string">&quot;kaptcha.textproducer.char.string&quot;</span>, <span class="hljs-string">&quot;0123456789ABCDEFGHIJKLMNOPQRSTUVWXYAZ&quot;</span>);<br>        properties.setProperty(<span class="hljs-string">&quot;kaptcha.textproducer.char.length&quot;</span>, <span class="hljs-string">&quot;4&quot;</span>);<br>        properties.setProperty(<span class="hljs-string">&quot;kaptcha.noise.impl&quot;</span>, <span class="hljs-string">&quot;com.google.code.kaptcha.impl.NoNoise&quot;</span>);<br><br>        <span class="hljs-type">DefaultKaptcha</span> <span class="hljs-variable">kaptcha</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DefaultKaptcha</span>();<br>        <span class="hljs-type">Config</span> <span class="hljs-variable">config</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Config</span>(properties);<br>        kaptcha.setConfig(config);<br>        <span class="hljs-keyword">return</span> kaptcha;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后在LoginController表现层尝试输出下验证码图片，加入下列代码。其中比较重要的就是<strong>验证码作为敏感信息，是要存入session里</strong>的，同时注意输出图片给浏览器是用字节流的形式输出</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping(path = &quot;/kaptcha&quot;, method = RequestMethod.GET)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getKaptcha</span><span class="hljs-params">(HttpServletResponse response, HttpSession session)</span> &#123;<br>    <span class="hljs-comment">// 生成验证码</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> kaptchaProducer.createText();<br>    <span class="hljs-type">BufferedImage</span> <span class="hljs-variable">image</span> <span class="hljs-operator">=</span> kaptchaProducer.createImage(text);<br><br>    <span class="hljs-comment">// 将验证码存入session</span><br>    session.setAttribute(<span class="hljs-string">&quot;kaptcha&quot;</span>, text);<br><br>    <span class="hljs-comment">// 将图片输出给浏览器</span><br>    response.setContentType(<span class="hljs-string">&quot;image/png&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> response.getOutputStream();<br>        ImageIO.write(image, <span class="hljs-string">&quot;png&quot;</span>, os);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        logger.error(<span class="hljs-string">&quot;响应验证码失败:&quot;</span> + e.getMessage());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>随后可以访问：<a target="_blank" rel="noopener" href="http://localhost:8080/community/kaptcha">http://localhost:8080/community/kaptcha</a> 进行测试，每次刷新都会更新验证码图片。</p>
<p>下一步就是将验证码显示到登录页面中，我们希望的是点击“刷新验证码”按钮也会刷新验证码</p>
<p>在login.html中将验证码路径改为前面设置的路径<code>/kaptcha</code>，再去改刷新验证码这个超链接对应的js方法<code>refresh_kaptcha()</code>。<code>&quot;/kaptcha?p=&quot; + Math.random();</code>是因为欺骗一下浏览器，每次都是动态的，要不然每次都是静态url，浏览器会认为没变化</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">div</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;col-sm-4&quot;</span>&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">img</span> <span class="hljs-attr">th:src</span>=<span class="hljs-string">&quot;@&#123;/kaptcha&#125;&quot;</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;kaptcha&quot;</span> <span class="hljs-attr">style</span>=<span class="hljs-string">&quot;width:100px;height:40px;&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;mr-2&quot;</span>/&gt;</span><br>	<span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">href</span>=<span class="hljs-string">&quot;javascript:refresh_kaptcha();&quot;</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;font-size-12 align-bottom&quot;</span>&gt;</span>刷新验证码<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">div</span>&gt;</span><br><br>......<br><br><span class="hljs-tag">&lt;<span class="hljs-name">script</span>&gt;</span><span class="language-javascript"></span><br><span class="language-javascript">    <span class="hljs-keyword">function</span> <span class="hljs-title function_">refresh_kaptcha</span>(<span class="hljs-params"></span>) &#123;</span><br><span class="language-javascript">        <span class="hljs-keyword">var</span> path = <span class="hljs-variable constant_">CONTEXT_PATH</span> + <span class="hljs-string">&quot;/kaptcha?p=&quot;</span> + <span class="hljs-title class_">Math</span>.<span class="hljs-title function_">random</span>();</span><br><span class="language-javascript">        $(<span class="hljs-string">&quot;#kaptcha&quot;</span>).<span class="hljs-title function_">attr</span>(<span class="hljs-string">&quot;src&quot;</span>, path);</span><br><span class="language-javascript">    &#125;</span><br><span class="language-javascript"></span><span class="hljs-tag">&lt;/<span class="hljs-name">script</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>上面的CONTEXT_PATH是因为如果每次都要写community会比较烦，可以去global.js里配置一下CONTEXT_PATH</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs js"><span class="hljs-keyword">var</span> <span class="hljs-variable constant_">CONTEXT_PATH</span> = <span class="hljs-string">&quot;/community&quot;</span><br></code></pre></td></tr></table></figure>

<p>接下来可以进行最终的测试，访问<a target="_blank" rel="noopener" href="http://localhost:8080/community/login%EF%BC%8C%E7%82%B9%E5%87%BB%E2%80%9C%E5%88%B7%E6%96%B0%E9%AA%8C%E8%AF%81%E7%A0%81%E2%80%9D">http://localhost:8080/community/login，点击“刷新验证码”</a></p>
<h2 id="5-开发登录、退出功能"><a href="#5-开发登录、退出功能" class="headerlink" title="5. 开发登录、退出功能"></a>5. 开发登录、退出功能</h2><p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch2%E5%8A%9F%E8%83%BD%E6%8F%8F%E8%BF%B0-%E5%BC%80%E5%8F%91%E7%99%BB%E5%BD%95%E3%80%81%E9%80%80%E5%87%BA%E5%8A%9F%E8%83%BD.png" srcset="/img/loading.gif" lazyload alt="image-20220515234850436"></p>
<h3 id="数据层"><a href="#数据层" class="headerlink" title="数据层"></a>数据层</h3><p>登录验证功能额外需要一个表来记录登录凭证，这个本身其实是可以用Session来使用，相当于记录用户登录身份，此处没有用Session，而是用Cookie，使用了这个登录凭证来记录，用户登录成功之后，服务端生成一个凭证发给客户端，客户端下次访问时将凭证发给服务端，服务端看用户凭证没问题，也没过期，就让他直接登录，不用重新登录</p>
<figure class="highlight sql"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><code class="hljs sql"><span class="hljs-keyword">create</span> <span class="hljs-keyword">table</span> login_ticket<br>(<br>    id      <span class="hljs-type">int</span> auto_increment <span class="hljs-keyword">primary</span> key,<br>    user_id <span class="hljs-type">int</span>           <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,<br>    ticket  <span class="hljs-type">varchar</span>(<span class="hljs-number">45</span>)   <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span>,<br>    status  <span class="hljs-type">int</span> <span class="hljs-keyword">default</span> <span class="hljs-number">0</span> <span class="hljs-keyword">null</span> comment <span class="hljs-string">&#x27;0-有效; 1-无效;&#x27;</span>,<br>    expired <span class="hljs-type">timestamp</span>     <span class="hljs-keyword">not</span> <span class="hljs-keyword">null</span><br>);<br></code></pre></td></tr></table></figure>

<p>因此首先在entity包下创建该实体类LoginTicket</p>
<p>将对应字段封装起来并创建get set方法</p>
<p>随后在dao包下创建数据访问接口 并封装好增加、查询、修改方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">LoginTicketMapper</span> &#123;<br>    <span class="hljs-meta">@Insert(&#123;</span><br><span class="hljs-meta">            &quot;insert into login_ticket(user_id,ticket,status,expired) &quot;,</span><br><span class="hljs-meta">            &quot;values(#&#123;userId&#125;,#&#123;ticket&#125;,#&#123;status&#125;,#&#123;expired&#125;)&quot;</span><br><span class="hljs-meta">    &#125;)</span><br>    <span class="hljs-meta">@Options(useGeneratedKeys = true, keyProperty = &quot;id&quot;)</span>  <span class="hljs-comment">// 主键自动生成，注入给id属性</span><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">insertLoginTicket</span><span class="hljs-params">(LoginTicket loginTicket)</span>;<br><br>    <span class="hljs-meta">@Select(&#123;</span><br><span class="hljs-meta">            &quot;select id,user_id,ticket,status,expired &quot;,</span><br><span class="hljs-meta">            &quot;from login_ticket where ticket=#&#123;ticket&#125;&quot;</span><br><span class="hljs-meta">    &#125;)</span><br>    LoginTicket <span class="hljs-title function_">selectByTicket</span><span class="hljs-params">(String ticket)</span>;<br><br>    <span class="hljs-meta">@Update(&#123;</span><br><span class="hljs-meta">            &quot;&lt;script&gt;&quot;,</span><br><span class="hljs-meta">            &quot;update login_ticket set status=#&#123;status&#125; where ticket=#&#123;ticket&#125; &quot;,</span><br><span class="hljs-meta">            &quot;&lt;if test=\&quot;ticket!=null\&quot;&gt; &quot;,</span><br><span class="hljs-meta">            &quot;and 1=1 &quot;, //演示用，没有实际价值</span><br><span class="hljs-meta">            &quot;&lt;/if&gt;&quot;,</span><br><span class="hljs-meta">            &quot;&lt;/script&gt;&quot;</span><br><span class="hljs-meta">    &#125;)</span><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">updateStatus</span><span class="hljs-params">(String ticket, <span class="hljs-type">int</span> status)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>随后严谨一点需要先测试，测试成功了再继续开发</p>
<h3 id="业务层-2"><a href="#业务层-2" class="headerlink" title="业务层"></a>业务层</h3><p>随后在UserService里继续开发，毕竟登录也算是用户的行为</p>
<p>登录的返回情况有很多种，大分类就是成功和失败，但失败了可能是账号不存在、账号未激活、密码错误等情况，所以我们返回一个map，用来记录多种信息。函数参数有用户名、密码、希望过期的时间</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">login</span><span class="hljs-params">(String username, String password, <span class="hljs-type">int</span> expiredSeconds)</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>随后开始编写此函数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 用户登录以及登录凭证</span><br><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">login</span><span class="hljs-params">(String username, String password, <span class="hljs-type">int</span> expiredSeconds)</span> &#123;<br>    Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-comment">// 空值处理</span><br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(username)) &#123; <span class="hljs-comment">// commons.lang3中非常好用的判断空值</span><br>        map.put(<span class="hljs-string">&quot;usernameMsg&quot;</span>, <span class="hljs-string">&quot;账号不能为空!&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(password)) &#123;<br>        map.put(<span class="hljs-string">&quot;passwordMsg&quot;</span>, <span class="hljs-string">&quot;密码不能为空!&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br><br>    <span class="hljs-comment">// 验证账号</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectByName(username);  <span class="hljs-comment">// 根据用户名去库里查用户对象</span><br>    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>        map.put(<span class="hljs-string">&quot;usernameMsg&quot;</span>, <span class="hljs-string">&quot;该账号不存在!&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br><br>    <span class="hljs-comment">// 验证状态</span><br>    <span class="hljs-keyword">if</span> (user.getStatus() == <span class="hljs-number">0</span>) &#123;<br>        map.put(<span class="hljs-string">&quot;usernameMsg&quot;</span>, <span class="hljs-string">&quot;该账号未激活!&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br><br>    <span class="hljs-comment">// 验证密码</span><br>    password = CommunityUtil.md5(password + user.getSalt());<br>    <span class="hljs-keyword">if</span> (!user.getPassword().equals(password)) &#123;<br>        map.put(<span class="hljs-string">&quot;passwordMsg&quot;</span>, <span class="hljs-string">&quot;密码不正确!&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br><br>    <span class="hljs-comment">// 生成登录凭证</span><br>    <span class="hljs-type">LoginTicket</span> <span class="hljs-variable">loginTicket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginTicket</span>();<br>    loginTicket.setUserId(user.getId());<br>    loginTicket.setTicket(CommunityUtil.generateUUID());  <span class="hljs-comment">// 登陆凭证是一个随机字符串</span><br>    loginTicket.setStatus(<span class="hljs-number">0</span>);  <span class="hljs-comment">// 设置状态，0是有效</span><br>    loginTicket.setExpired(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis() + (<span class="hljs-type">long</span>)expiredSeconds * <span class="hljs-number">1000</span>));  <span class="hljs-comment">// 当前的时间+希望多久过期，需要转为long型，否则int会溢出</span><br>    loginTicketMapper.insertLoginTicket(loginTicket);<br><br>    map.put(<span class="hljs-string">&quot;ticket&quot;</span>, loginTicket.getTicket()); <span class="hljs-comment">// 只要向客户端发送ticket即可，其他没有必要发送</span><br>    <span class="hljs-keyword">return</span> map;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>随后再开发退出功能的业务层代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 退出功能</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logout</span><span class="hljs-params">(String ticket)</span> &#123;<br>    loginTicketMapper.updateStatus(ticket, <span class="hljs-number">1</span>);  <span class="hljs-comment">//退出就是根据ticket把状态改为1</span><br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="表现层-2"><a href="#表现层-2" class="headerlink" title="表现层"></a>表现层</h3><p>接下来就是开发表现层，逻辑也不难，当用户访问登录页面时，提交用户名、密码、验证码三个表单，交给业务层去判断处理，如果成功，就跳转到首页，不成功还是留在登录页面，并给出对应提示</p>
<p>定位到LoginController文件，继续编写表现层逻辑</p>
<p>编写login函数，虽然路径同样是”&#x2F;login”，但请求的方式不同，这样是可以让路径相同的，之前的<code>getLoginPage</code>方法请求方式是GET方法，本次要提交表单，所以使用POST方法</p>
<p>前三个参数是用户名、密码、验证码，第四个是“是否勾选记住我”选项，第五个参数是Spirngmvc的模型Model，第六个参数是Session，因为前面将验证码放到了Session里，第七个参数是因为要用到Cookie，所以要使用HttpServletResponse。本方法参数较多</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping(path = &quot;/login&quot;, method = RequestMethod.POST)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">login</span><span class="hljs-params">(String username, String password, String code, <span class="hljs-type">boolean</span> rememberme, Model model, HttpSession session, HttpServletResponse response)</span> &#123;<br></code></pre></td></tr></table></figure>

<p>首先在表现层判断验证码，不在业务层里判断验证码。随后检查账号和密码，由于业务层的<code>userService.login</code>方法需要传入一个希望失效的时间，因此我们需要根据是否勾选“记住我”选项来决定超时时间，还是放在<code>CommunityConstant</code>接口中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 默认状态的登录凭证的超时时间</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-variable">DEFAULT_EXPIRED_SECONDS</span> <span class="hljs-operator">=</span> <span class="hljs-number">3600</span> * <span class="hljs-number">12</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 记住状态的登录凭证超时时间</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-variable">REMEMBER_EXPIRED_SECONDS</span> <span class="hljs-operator">=</span> <span class="hljs-number">3600</span> * <span class="hljs-number">24</span> * <span class="hljs-number">100</span>;<br></code></pre></td></tr></table></figure>

<p>剩下的就是调用业务层login方法，返回一个map，拿这个map里的信息编写业务层逻辑，完整的代码为：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping(path = &quot;/login&quot;, method = RequestMethod.POST)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">login</span><span class="hljs-params">(String username, String password, String code, <span class="hljs-type">boolean</span> rememberme,</span><br><span class="hljs-params">                    Model model, HttpSession session, HttpServletResponse response)</span> &#123;<br>    <span class="hljs-comment">// 检查验证码</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">kaptcha</span> <span class="hljs-operator">=</span> (String) session.getAttribute(<span class="hljs-string">&quot;kaptcha&quot;</span>);<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(kaptcha) || StringUtils.isBlank(code) || !kaptcha.equalsIgnoreCase(code)) &#123; <span class="hljs-comment">// 两个有一个为空，或者验证码不等（忽略大小写）</span><br>        model.addAttribute(<span class="hljs-string">&quot;codeMsg&quot;</span>, <span class="hljs-string">&quot;验证码不正确!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/login&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 检查账号,密码</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">expiredSeconds</span> <span class="hljs-operator">=</span> rememberme ? REMEMBER_EXPIRED_SECONDS : DEFAULT_EXPIRED_SECONDS; <span class="hljs-comment">// 根据是否勾选“记住我”选项来决定超时时间</span><br>    Map&lt;String, Object&gt; map = userService.login(username, password, expiredSeconds);      <span class="hljs-comment">// 调用业务层方法返回map</span><br>    <span class="hljs-keyword">if</span> (map.containsKey(<span class="hljs-string">&quot;ticket&quot;</span>)) &#123;  <span class="hljs-comment">// map里有ticket说明登录成功了</span><br>        <span class="hljs-type">Cookie</span> <span class="hljs-variable">cookie</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cookie</span>(<span class="hljs-string">&quot;ticket&quot;</span>, map.get(<span class="hljs-string">&quot;ticket&quot;</span>).toString());         <span class="hljs-comment">// cookie的key-value都需要是String，所以调用toString</span><br>        cookie.setPath(contextPath);       <span class="hljs-comment">// cookie设置整个项目都有效，在配置文件里定义，最上面注入过</span><br>        cookie.setMaxAge(expiredSeconds);  <span class="hljs-comment">// cookie有效时间</span><br>        response.addCookie(cookie);        <span class="hljs-comment">// 给response添加cookie</span><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/index&quot;</span>;          <span class="hljs-comment">// 登录成功，重定向到首页</span><br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-comment">// 登录失败，返回登录页面，并往model里传点消息</span><br>        model.addAttribute(<span class="hljs-string">&quot;usernameMsg&quot;</span>, map.get(<span class="hljs-string">&quot;usernameMsg&quot;</span>));<br>        model.addAttribute(<span class="hljs-string">&quot;passwordMsg&quot;</span>, map.get(<span class="hljs-string">&quot;passwordMsg&quot;</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/login&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>随后再开发退出功能的表现层代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 退出功能</span><br><span class="hljs-meta">@RequestMapping(path = &quot;/logout&quot;, method = RequestMethod.GET)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">logout</span><span class="hljs-params">(<span class="hljs-meta">@CookieValue(&quot;ticket&quot;)</span> String ticket)</span> &#123; <span class="hljs-comment">// 让mvc把名为&quot;ticket&quot;的cookie传入给ticket参数</span><br>    userService.logout(ticket);  <span class="hljs-comment">// 调用业务层</span><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/login&quot;</span>;    <span class="hljs-comment">// 重定向到login，默认是get请求的链接</span><br>&#125;<br></code></pre></td></tr></table></figure>

<p>这里额外提一嘴，controller方法里多次使用了返回重定向，它们和直接返回的区别为：</p>
<p>return “&#x2F;site&#x2F;index”是返回一个模板路径，本次请求没有处理完，DispatcherServlet会将Model中的数据和对应的模板提交给模板引擎，让它继续处理完这次请求。</p>
<p>return “redirect:&#x2F;index”是重定向，表示本次请求已经处理完毕，但是没有什么合适的数据展现给客户端，建议客户端再发一次请求，访问”&#x2F;index”以获得合适的数据。</p>
<p>controller里面的login方法 为啥要用重定向呢，直接用return 视图名为啥就不行呢</p>
<p>转发解决的的一次请求内部的跳转，重定向解决的是2次请求之间的跳转。</p>
<p>HTTP协议里，请求就是指浏览器向服务器发起的一次访问，包括4个环节，建立连接、发送请求、接收请求、关闭连接。转发就是浏览器向服务器发了一次请求，服务器通过controller处理，但是它没处理完，将请求交给另外一个组件处理，还是同一个请求，没有跳出服务端，最后由第二个组件给浏览器做响应。</p>
<p>二次请求，就是浏览器向服务器发出一次请求，服务器某组件将其完整处理完了，给浏览器一个响应，并建议浏览器访问另外的组件，以刷新页面的内容。浏览器发出第二次请求，是独立的，和第一次无关的请求</p>
<h3 id="前端和测试"><a href="#前端和测试" class="headerlink" title="前端和测试"></a>前端和测试</h3><p>编写前端代码，不是重点，我就只记录个大概了</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">form</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;mt-5&quot;</span> <span class="hljs-attr">method</span>=<span class="hljs-string">&quot;post&quot;</span> <span class="hljs-attr">th:action</span>=<span class="hljs-string">&quot;@&#123;/login&#125;&quot;</span>&gt;</span> <span class="hljs-tag">&lt;/<span class="hljs-name">form</span>&gt;</span>	 声明表单提交给谁，提交方法<br>    <br>给四个表单加上name，与表现层里写的四个参数命名要相同<br>name=&quot;username&quot; name=&quot;password&quot; name=&quot;code&quot; name=&quot;rememberme&quot;<br>    <br>返回登录页面默认值的情况，希望记住用户名、密码、是否记住我，验证码就不用记住了，从request里取默认值<br>th:value=&quot;$&#123;param.username&#125;&quot; th:value=&quot;$&#123;param.password&#125;&quot; th:checked=&quot;$&#123;param.rememberme&#125;&quot;&gt;<br><br>还有关于信息提示处理的部分，懒得写了<br></code></pre></td></tr></table></figure>



<p>测试：</p>
<p>访问<a target="_blank" rel="noopener" href="http://localhost:8080/community/login%EF%BC%8C%E6%A0%B9%E6%8D%AE%E7%9B%AE%E5%89%8D%E7%9A%84%E7%94%A8%E6%88%B7%E6%95%B0%E6%8D%AE%E5%BA%93%E9%87%8C%E7%9A%84%E6%B5%8B%E8%AF%95%E7%94%A8%E6%88%B7%EF%BC%8C%E6%B5%8B%E8%AF%95%E6%9C%AC%E8%8A%82%E5%BC%80%E5%8F%91%E7%9A%84%E5%8A%9F%E8%83%BD%E3%80%82">http://localhost:8080/community/login，根据目前的用户数据库里的测试用户，测试本节开发的功能。</a></p>
<p>账号：wanyu  密码：123</p>
<p>测试内容</p>
<p>（1）首先是页面的提示，账号不存在、密码错误等</p>
<p>（2）登陆成功后，浏览器开发者工具里应该能够查到对应名为ticket的cookie，其值应该和数据库表login_ticket的值相同，对应的user_id应该是wanyu的user_id，status应该为0，如果勾选了记住我，失效时间应该是1个月后</p>
<p>（3）退出登陆后，数据库表login_ticket对应的ticket记录其status应该为1，表示失效了</p>
<h3 id="忘记密码"><a href="#忘记密码" class="headerlink" title="忘记密码"></a>忘记密码</h3><p>这是作为课后作业的一个功能，将它补充完整。涉及到的前端文件全部用参考答案里的对应前端文件替换掉</p>
<p>首先在表现层加入忘记密码的页面请求，LoginController中加入：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 忘记密码页面</span><br><span class="hljs-meta">@RequestMapping(path = &quot;/forget&quot;, method = RequestMethod.GET)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getForgetPage</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/forget&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch2%E5%8A%9F%E8%83%BD%E6%8F%8F%E8%BF%B0-%E5%BF%98%E8%AE%B0%E5%AF%86%E7%A0%81%E9%A1%B5%E9%9D%A2.png" srcset="/img/loading.gif" lazyload alt="image-20220516135730640"></p>
<p>然后按照三层架构进行开发，数据访问层不用更改啥，业务层的逻辑是根据传入的邮箱和新密码实现重置密码功能，验证方法是，向邮箱发送验证码</p>
<p>先编写业务层代码：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 根据传入的名字查找用户</span><br><span class="hljs-keyword">public</span> User <span class="hljs-title function_">findUserByName</span><span class="hljs-params">(String username)</span> &#123;<br>    <span class="hljs-keyword">return</span> userMapper.selectByName(username);<br>&#125;<br><br><span class="hljs-comment">// 忘记密码-重置密码</span><br><span class="hljs-comment">// 根据传入的邮箱和新密码实现重置密码功能，验证方法是，向邮箱发送验证码</span><br><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">resetPassword</span><span class="hljs-params">(String email, String password)</span> &#123;<br>    Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-comment">// 空值处理</span><br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(email)) &#123;<br>        map.put(<span class="hljs-string">&quot;emailMsg&quot;</span>, <span class="hljs-string">&quot;邮箱不能为空!&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(password)) &#123;<br>        map.put(<span class="hljs-string">&quot;passwordMsg&quot;</span>, <span class="hljs-string">&quot;密码不能为空!&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br><br>    <span class="hljs-comment">// 验证邮箱</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectByEmail(email);<br>    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>        map.put(<span class="hljs-string">&quot;emailMsg&quot;</span>, <span class="hljs-string">&quot;该邮箱尚未注册!&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br><br>    <span class="hljs-comment">// 重置密码</span><br>    password = CommunityUtil.md5(password + user.getSalt());<br>    userMapper.updatePassword(user.getId(), password);<br><br>    map.put(<span class="hljs-string">&quot;user&quot;</span>, user);<br>    <span class="hljs-keyword">return</span> map;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>再编写表现层代码：</p>
<p>获取验证码环节需要注入之前编写的邮箱类MailClient，还需要使用TemplateEngine模板引擎类。还有JSON字符串转换的工具类（这部分第二章课程里没提到，在后续课程里，此处先在CommunityUtil里加上）。此部分的验证码还是保存在session里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 获取验证码</span><br><span class="hljs-meta">@RequestMapping(path = &quot;/forget/code&quot;, method = RequestMethod.GET)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getForgetCode</span><span class="hljs-params">(String email, HttpSession session)</span> &#123;<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(email)) &#123;<br>        <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;邮箱不能为空！&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 发送邮件</span><br>    <span class="hljs-type">Context</span> <span class="hljs-variable">context</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Context</span>();<br>    context.setVariable(<span class="hljs-string">&quot;email&quot;</span>, email);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> CommunityUtil.generateUUID().substring(<span class="hljs-number">0</span>, <span class="hljs-number">4</span>);<br>    context.setVariable(<span class="hljs-string">&quot;verifyCode&quot;</span>, code);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> templateEngine.process(<span class="hljs-string">&quot;/mail/forget&quot;</span>, context);<br>    mailClient.sendMail(email, <span class="hljs-string">&quot;找回密码&quot;</span>, content);<br><br>    <span class="hljs-comment">// 保存验证码</span><br>    session.setAttribute(<span class="hljs-string">&quot;verifyCode&quot;</span>, code);<br><br>    <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">0</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来就是编写用户点击重置密码按钮发送的请求，首先要从Session里获取验证码，并对比用户填写的验证码。验证码正确则是调用业务层方法重置密码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 重置密码</span><br><span class="hljs-meta">@RequestMapping(path = &quot;/forget/password&quot;, method = RequestMethod.POST)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">resetPassword</span><span class="hljs-params">(String email, String verifyCode, String password, Model model, HttpSession session)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">code</span> <span class="hljs-operator">=</span> (String) session.getAttribute(<span class="hljs-string">&quot;verifyCode&quot;</span>);<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(verifyCode) || StringUtils.isBlank(code) || !code.equalsIgnoreCase(verifyCode)) &#123;<br>        model.addAttribute(<span class="hljs-string">&quot;codeMsg&quot;</span>, <span class="hljs-string">&quot;验证码错误!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/forget&quot;</span>;<br>    &#125;<br><br>    Map&lt;String, Object&gt; map = userService.resetPassword(email, password);<br>    <span class="hljs-keyword">if</span> (map.containsKey(<span class="hljs-string">&quot;user&quot;</span>)) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/login&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        model.addAttribute(<span class="hljs-string">&quot;emailMsg&quot;</span>, map.get(<span class="hljs-string">&quot;emailMsg&quot;</span>));<br>        model.addAttribute(<span class="hljs-string">&quot;passwordMsg&quot;</span>, map.get(<span class="hljs-string">&quot;passwordMsg&quot;</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/forget&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>不同于之前激活账号成功是返回一个单独的网页 &#x2F;site&#x2F;operate-result</p>
<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/%E5%BC%80%E5%8F%91%E6%B3%A8%E5%86%8C%E5%8A%9F%E8%83%BD-%E6%BF%80%E6%B4%BB%E6%B3%A8%E5%86%8C%E8%B4%A6%E5%8F%B7-%E9%87%8D%E5%A4%8D%E6%BF%80%E6%B4%BB.png" srcset="/img/loading.gif" lazyload alt="image-20220419230640666"></p>
<p>此处重置密码的提示使用js作为提示框，响应的前端文件forget.js之前也放入到工程里</p>
<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/%E5%BF%98%E8%AE%B0%E5%AF%86%E7%A0%81-%E9%AA%8C%E8%AF%81%E7%A0%81%E5%8F%91%E9%80%81%E6%88%90%E5%8A%9F%E6%8F%90%E7%A4%BA.png" srcset="/img/loading.gif" lazyload alt="image-20220516143511548"></p>
<p>至此忘记密码功能已经编写完成，后面可以自己测试</p>
<h2 id="6-显示登录信息"><a href="#6-显示登录信息" class="headerlink" title="6. 显示登录信息"></a>6. 显示登录信息</h2><blockquote>
<p>这一部分需要用到拦截器Interceptor的知识，前置知识笔记在Springmvc笔记里，同 Web开发中的 Filter 过滤器一样，对某一个功能前置加些功能，后置加些功能，显然是面向切面编程——AOP 的具体实现（底层是java的动态代理）</p>
</blockquote>
<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch2%E5%8A%9F%E8%83%BD%E6%8F%8F%E8%BF%B0-%E6%98%BE%E7%A4%BA%E7%99%BB%E5%BD%95%E4%BF%A1%E6%81%AF.png" srcset="/img/loading.gif" lazyload alt="image-20220515235012651"></p>
<h3 id="拦截器逻辑"><a href="#拦截器逻辑" class="headerlink" title="拦截器逻辑"></a>拦截器逻辑</h3><p>首先根据前文的cookie梳理一下这个显示登录信息的逻辑：</p>
<p>浏览器第一次登录成功时，服务器会发送一个cookie存在浏览器本地，后来浏览器每次登录网站，即请求时都会把cookie带上，如图中的第一个红色箭头，服务器就会拿着这个cookie去前文的login_ticket表里去查找这个cookie，找到之后，表里关联了用户是谁，所以就能查找用户是谁，知道用户是谁就可以在模板引擎上展示和这个用户有关的信息了。</p>
<p>而且这个操作是<strong>每次请求和响应服务器都要做</strong>的，就是说每次都要去查浏览器请求带过来的cookie，然后查到用户，在页面上显示出来。这样的操作应该使用拦截器，让mvc自动每次都做，而不是开发多次</p>
<p>这里也能进一步理解之前为什么要cookie而不是直接存用户名在浏览器和服务器上，因为用户名或者密码这种都是敏感信息，而存一个cookie就没那么敏感。</p>
<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/%E6%98%BE%E7%A4%BA%E7%99%BB%E5%BD%95%E4%BF%A1%E6%81%AF-%E6%98%BE%E7%A4%BA%E7%99%BB%E5%BD%95%E4%BF%A1%E6%81%AF%E9%80%BB%E8%BE%91.png" srcset="/img/loading.gif" lazyload alt="image-20220515135957471"></p>
<p>下面就是把上面的逻辑用代码开发出来</p>
<h3 id="自定义拦截器类"><a href="#自定义拦截器类" class="headerlink" title="自定义拦截器类"></a>自定义拦截器类</h3><p>在controller包下建立interceptor包，建立自定义拦截器LoginTicketInterceptor</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginTicketInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;&#125;<br></code></pre></td></tr></table></figure>

<p>显然是在每次的controller方法之前都要查找登录信息（即找到用户信息），所以要重写<code>preHandle</code>方法。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    ...<br>    <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>由于之后要多次从HttpServletRequest中获取cookie，在这里把它封装成工具的静态方法，在util包下创建CookieUtil类，用于获取cookie</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CookieUtil</span> &#123;<br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getValue</span><span class="hljs-params">(HttpServletRequest request, String name)</span> &#123;<br>        <span class="hljs-keyword">if</span> (request == <span class="hljs-literal">null</span> || name == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;参数为空!&quot;</span>);<br>        &#125;<br><br>        Cookie[] cookies = request.getCookies();<br>        <span class="hljs-keyword">if</span> (cookies != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (Cookie cookie : cookies) &#123;<br>                <span class="hljs-keyword">if</span> (cookie.getName().equals(name)) &#123;<br>                    <span class="hljs-keyword">return</span> cookie.getValue();<br>                &#125;<br>            &#125;<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>接下来继续编写自定义拦截器的preHandle方法，先从cookie中查找名为“ticket”的用户登录凭证，再调用业务层方法根据这个ticket（先判断是否有效）找到用户。</p>
<p>此时有一个问题就是服务器是一对多的，有多个用户回来请求访问，服务器需要使用多个线程去响应浏览器的请求，这就要注意线程隔离问题，本来如果是把信息放在Session里，Session对象就是线程隔离的，但现在不想用Session对象，在util包下自定义HostHolder类，让他去持有用户信息，用于代替session对象。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 持有用户信息,用于代替session对象.</span><br><span class="hljs-comment"> */</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">HostHolder</span> &#123;<br><br>    <span class="hljs-keyword">private</span> ThreadLocal&lt;User&gt; users = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ThreadLocal</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">setUser</span><span class="hljs-params">(User user)</span> &#123;<br>        users.set(user);  <span class="hljs-comment">// 调用ThreadLocal的set方法，它是根据当前线程把值放到一个map里，不同的线程有不同的map</span><br>    &#125;<br><br>    <span class="hljs-keyword">public</span> User <span class="hljs-title function_">getUser</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> users.get();  <span class="hljs-comment">// 调用ThreadLocal的get方法，取也是根据当前线程取</span><br>    &#125;<br><br>    <span class="hljs-comment">// 请求结束后就把所有的map清理掉，要不然光存不清理，占用资源</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clear</span><span class="hljs-params">()</span> &#123;<br>        users.remove();<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>至此，完整的preHandle方法就开发结束</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Override</span><br> <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>     <span class="hljs-comment">// 从cookie中获取凭证</span><br>     <span class="hljs-type">String</span> <span class="hljs-variable">ticket</span> <span class="hljs-operator">=</span> CookieUtil.getValue(request, <span class="hljs-string">&quot;ticket&quot;</span>);<br><br>     <span class="hljs-keyword">if</span> (ticket != <span class="hljs-literal">null</span>) &#123;<br>         <span class="hljs-comment">// 查询凭证</span><br>         <span class="hljs-type">LoginTicket</span> <span class="hljs-variable">loginTicket</span> <span class="hljs-operator">=</span> userService.findLoginTicket(ticket);<br>         <span class="hljs-comment">// 检查凭证是否有效（不为空、状态有效、时间为过期）</span><br>         <span class="hljs-keyword">if</span> (loginTicket != <span class="hljs-literal">null</span> &amp;&amp; loginTicket.getStatus() == <span class="hljs-number">0</span> &amp;&amp; loginTicket.getExpired().after(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>())) &#123;<br>             <span class="hljs-comment">// 根据凭证查询用户</span><br>             <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findUserById(loginTicket.getUserId());<br>             <span class="hljs-comment">// 在本次请求中持有用户</span><br>             hostHolder.setUser(user);<br>         &#125;<br>     &#125;<br><br>     <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br> &#125;<br></code></pre></td></tr></table></figure>

<p>后面我们需要在模板引擎渲染视图之前，用这个取到的用户对象，把对象存到modelAndView里，再来渲染页面，所以这里要重写拦截器的postHandle方法，该方法是在controller方法之后，渲染页面之前调用的。</p>
<p>postHandle方法内部很简单，获取当前线程里的用户然后添加进modelAndView就行</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> hostHolder.getUser(); <span class="hljs-comment">// 从当前线程得到用户</span><br>    <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span> &amp;&amp; modelAndView != <span class="hljs-literal">null</span>) &#123;<br>        modelAndView.addObject(<span class="hljs-string">&quot;loginUser&quot;</span>, user);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>在请求结束之后，我们需要将持有用户信息的对象HostHolder清空，要不然光存不清理，占用资源。这个方法应该写在渲染页面结束之后，所以要重写afterCompletion方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Override</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">afterCompletion</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, Exception ex)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>    hostHolder.clear();<br>&#125;<br></code></pre></td></tr></table></figure>

<p>至此，自定义的拦截器类以及方法已经写完，下一步是将他注册到springmvc里</p>
<h3 id="配置拦截器"><a href="#配置拦截器" class="headerlink" title="配置拦截器"></a>配置拦截器</h3><p>在config包里创建WebMvcConfig类，实现WebMvcConfigurer接口，加上@Configuration注解，类里注入自定义的拦截器类，并将其加入到mvc的拦截器列表中</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> LoginTicketInterceptor loginTicketInterceptor;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>        registry.addInterceptor(loginTicketInterceptor)<br>                .excludePathPatterns(<span class="hljs-string">&quot;/**/*.css&quot;</span>, <span class="hljs-string">&quot;/**/*.js&quot;</span>, <span class="hljs-string">&quot;/**/*.png&quot;</span>, <span class="hljs-string">&quot;/**/*.jpg&quot;</span>, <span class="hljs-string">&quot;/**/*.jpeg&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<h3 id="前端和测试-1"><a href="#前端和测试-1" class="headerlink" title="前端和测试"></a>前端和测试</h3><p>下一步就是让模板引擎去根据登录信息渲染页面，这一部分看对应视频的48：35内容，不记录了，总之就是让index.html根据登录信息显示不同的内容</p>
<p>运行程序，未登录前，index.html头部显示如下</p>
<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/%E6%98%BE%E7%A4%BA%E7%99%BB%E9%99%86%E4%BF%A1%E6%81%AF-%E6%9C%AA%E7%99%BB%E5%BD%95%E5%89%8D%E7%9A%84index%E9%A1%B5%E9%9D%A2.png" srcset="/img/loading.gif" lazyload alt="image-20220515151932780"></p>
<p>账号wanyu，密码123，登陆后，index.html头部显示如下</p>
<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/%E6%98%BE%E7%A4%BA%E7%99%BB%E9%99%86%E4%BF%A1%E6%81%AF-%E7%99%BB%E5%BD%95%E5%90%8E%E7%9A%84index%E9%A1%B5%E9%9D%A2.png" srcset="/img/loading.gif" lazyload alt="image-20220515152105181"></p>
<p>退出登录后，返回未登陆前的页面（退出登陆后登陆凭证的状态设为了1，表示无效）</p>
<h2 id="7-开发账号设置"><a href="#7-开发账号设置" class="headerlink" title="7. 开发账号设置"></a>7. 开发账号设置</h2><p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch2%E5%8A%9F%E8%83%BD%E6%8F%8F%E8%BF%B0-%E8%B4%A6%E5%8F%B7%E8%AE%BE%E7%BD%AE.png" srcset="/img/loading.gif" lazyload alt="image-20220515235313189"></p>
<p>用户登陆之后，需要对自己的账户可以进行设置，此处实现上传头像和修改密码两个功能</p>
<h3 id="访问账号设置页面"><a href="#访问账号设置页面" class="headerlink" title="访问账号设置页面"></a>访问账号设置页面</h3><p>在controller包里创建UserController类，这是属于用户的表现层，写在现有的controller类里不合适，编写基本的返回页面功能</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br>    <br>    <span class="hljs-meta">@RequestMapping(path = &quot;/setting&quot;, method = RequestMethod.GET)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSettingPage</span><span class="hljs-params">()</span>&#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/setting&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>随后修改前端文件，主要是将setting.html改为thymeleaf模板，在index.html中将账号设置改为返回页面</p>
<figure class="highlight html"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs html"><span class="hljs-tag">&lt;<span class="hljs-name">a</span> <span class="hljs-attr">class</span>=<span class="hljs-string">&quot;dropdown-item text-center&quot;</span> <span class="hljs-attr">th:href</span>=<span class="hljs-string">&quot;@&#123;/user/setting&#125;&quot;</span>&gt;</span>账号设置<span class="hljs-tag">&lt;/<span class="hljs-name">a</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>随后就可以进行测试了，访问index登录后，进到账号设置页面，看是否能够进入成功</p>
<h3 id="上传图像"><a href="#上传图像" class="headerlink" title="上传图像"></a>上传图像</h3><p>上传文件是本节的核心功能，最好是学过基本的上传文件步骤再来做这个开发</p>
<p>第一步自然是设置图像上传位置，在项目配置文件里加入</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-attr">community.path.upload</span>=<span class="hljs-string">D:/codework/Java/IDEA/Other/Community_upload</span><br></code></pre></td></tr></table></figure>

<p>随后依然是三层架构的开发。</p>
<h4 id="数据层-1"><a href="#数据层-1" class="headerlink" title="数据层"></a>数据层</h4><p>无</p>
<h4 id="业务层-3"><a href="#业务层-3" class="headerlink" title="业务层"></a>业务层</h4><p>业务层的改变也很小，只需要把用户表里的图像url给改了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 更改用户头像url</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">updateHeader</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String headerUrl)</span> &#123;<br>    <span class="hljs-keyword">return</span> userMapper.updateHeader(userId, headerUrl);<br>&#125;<br></code></pre></td></tr></table></figure>



<h4 id="表现层-3"><a href="#表现层-3" class="headerlink" title="表现层"></a>表现层</h4><p>主要在表现层使用Springmvc的 MultipartFile 处理上传文件</p>
<p>在处理前注入：本项目域名、上传地址、项目名、业务层对象、当前用户</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/user&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">UserController</span> &#123;<br>    <span class="hljs-meta">@Value(&quot;$&#123;community.path.upload&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String uploadPath;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;community.path.domain&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String domain;<br><br>    <span class="hljs-meta">@Value(&quot;$&#123;server.servlet.context-path&#125;&quot;)</span><br>    <span class="hljs-keyword">private</span> String contextPath;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HostHolder hostHolder;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>上传文件是使用Springmvc提供的MultipartFile，他要求请求方式必须是POST，同时为了添加一些信息，也将Model作为参数。剩下的逻辑看注释即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping(path = &quot;/upload&quot;, method = RequestMethod.POST)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadHeader</span><span class="hljs-params">(MultipartFile headerImage, Model model)</span> &#123;<br>        <span class="hljs-keyword">if</span> (headerImage == <span class="hljs-literal">null</span>) &#123;<br>            model.addAttribute(<span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;您还没有选择图片!&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/setting&quot;</span>;  <span class="hljs-comment">// 没上传还是回到设置页面</span><br>        &#125;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">fileName</span> <span class="hljs-operator">=</span> headerImage.getOriginalFilename();              <span class="hljs-comment">// 先得到原始文件名</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">suffix</span> <span class="hljs-operator">=</span> fileName.substring(fileName.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>)); <span class="hljs-comment">// 再根据原始文件名得到文件类型</span><br>        <span class="hljs-keyword">if</span> (StringUtils.isBlank(suffix)) &#123;  <span class="hljs-comment">// 文件类型是空的，commons.lang3中的判断空值</span><br>            model.addAttribute(<span class="hljs-string">&quot;error&quot;</span>, <span class="hljs-string">&quot;文件的格式不正确!&quot;</span>);<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/setting&quot;</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 生成随机文件名，不能用上传的文件名，极容易重复，比如123.png</span><br>        fileName = CommunityUtil.generateUUID() + suffix;<br>        <span class="hljs-comment">// 确定文件存放的路径</span><br>        <span class="hljs-type">File</span> <span class="hljs-variable">dest</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">File</span>(uploadPath + <span class="hljs-string">&quot;/&quot;</span> + fileName);<br>        <span class="hljs-keyword">try</span> &#123;<br>            <span class="hljs-comment">// 存储文件，transferTo就是mvc提供的上传文件方法</span><br>            headerImage.transferTo(dest);<br>        &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>            log.error(<span class="hljs-string">&quot;上传文件失败: &quot;</span> + e.getMessage());<br>            <span class="hljs-comment">// 以后会统一处理异常，现在暂时抛出</span><br>            <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;上传文件失败,服务器发生异常!&quot;</span>, e);<br>        &#125;<br><br>        <span class="hljs-comment">// 更新当前用户的头像的路径(要web访问路径，不是磁盘路径)，后面会写如何根据web路径去加载头像图片</span><br>        <span class="hljs-comment">// http://localhost:8080/community/user/header/xxx.png</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> hostHolder.getUser();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">headerUrl</span> <span class="hljs-operator">=</span> domain + contextPath + <span class="hljs-string">&quot;/user/header/&quot;</span> + fileName;<br>        userService.updateHeader(user.getId(), headerUrl);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/index&quot;</span>; <span class="hljs-comment">// 上传成功后回到首页</span><br>    &#125;<br></code></pre></td></tr></table></figure>

<p>逻辑上需要注意的是，我们不能直接从服务器上的路径读取文件到浏览器上，而是有一个转换的过程，这就是下面的获取头像。通过字节流读取服务器磁盘路径上的图片，再通过字节流写入到response响应中</p>
<h3 id="获取头像"><a href="#获取头像" class="headerlink" title="获取头像"></a>获取头像</h3><p>获取头像就是根据之前上传头像更新的web访问路径，去加载头像图片</p>
<p>这个方法的返回值定义为void，因为只是加载图片，是以流的形式加载，不需要返回东西</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping(path = &quot;/header/&#123;fileName&#125;&quot;, method = RequestMethod.GET)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getHeader</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;fileName&quot;)</span> String fileName, HttpServletResponse response)</span> &#123;<br>    <span class="hljs-comment">// 服务器存放路径</span><br>    fileName = uploadPath + <span class="hljs-string">&quot;/&quot;</span> + fileName;<br>    <span class="hljs-comment">// 文件后缀</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">suffix</span> <span class="hljs-operator">=</span> fileName.substring(fileName.lastIndexOf(<span class="hljs-string">&quot;.&quot;</span>));<br>    <span class="hljs-comment">// 响应图片</span><br>    response.setContentType(<span class="hljs-string">&quot;image/&quot;</span> + suffix);<br>    <span class="hljs-keyword">try</span> (   <span class="hljs-comment">// mvc会自动关闭response的输出流，但输入流得我们自己关闭，这里直接一起放到try的小括号里，jdk7的语法，会自动关闭流。</span><br>            <span class="hljs-type">FileInputStream</span> <span class="hljs-variable">fis</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">FileInputStream</span>(fileName);  <span class="hljs-comment">// 先创建文件输入流，读取图片</span><br>            <span class="hljs-type">OutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> response.getOutputStream();         <span class="hljs-comment">// 再创建文件输出流，往response里输出字节流</span><br>    ) &#123;<br>        <span class="hljs-type">byte</span>[] buffer = <span class="hljs-keyword">new</span> <span class="hljs-title class_">byte</span>[<span class="hljs-number">1024</span>];     <span class="hljs-comment">// 字节流输出缓冲区</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">b</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span>;<br>        <span class="hljs-keyword">while</span> ((b = fis.read(buffer)) != -<span class="hljs-number">1</span>) &#123;<br>            os.write(buffer, <span class="hljs-number">0</span>, b);<br>        &#125;<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        log.error(<span class="hljs-string">&quot;读取头像失败: &quot;</span> + e.getMessage());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="前端和测试-2"><a href="#前端和测试-2" class="headerlink" title="前端和测试"></a>前端和测试</h3><p>对应视频的37：30看前端怎么写的，此处略过。</p>
<p>测试很简单，登录进去，账号设置，上传图片即可，上传成功会回到首页并更新头像</p>
<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/%E5%BC%80%E5%8F%91%E8%B4%A6%E5%8F%B7%E8%AE%BE%E7%BD%AE-%E4%B8%8A%E4%BC%A0%E5%A4%B4%E5%83%8F%E5%9B%BE%E7%89%87%E6%88%90%E5%8A%9F.png" srcset="/img/loading.gif" lazyload alt="image-20220515220000964"></p>
<p>这个时候上传文件路径里应该有上传的图片，用户数据表里会更新头像图片路径</p>
<h3 id="修改密码"><a href="#修改密码" class="headerlink" title="修改密码"></a>修改密码</h3><p>这部分功能是课后作业，逻辑上比较简单，也没有新东西，直接贴代码了</p>
<p>业务层：UserService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 修改密码</span><br><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">updatePassword</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String oldPassword, String newPassword)</span> &#123;<br>    Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br><br>    <span class="hljs-comment">// 空值处理</span><br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(oldPassword)) &#123;<br>        map.put(<span class="hljs-string">&quot;oldPasswordMsg&quot;</span>, <span class="hljs-string">&quot;原密码不能为空!&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(newPassword)) &#123;<br>        map.put(<span class="hljs-string">&quot;newPasswordMsg&quot;</span>, <span class="hljs-string">&quot;新密码不能为空!&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br><br>    <span class="hljs-comment">// 验证原始密码</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(userId);<br>    oldPassword = CommunityUtil.md5(oldPassword + user.getSalt());<br>    <span class="hljs-keyword">if</span> (!user.getPassword().equals(oldPassword)) &#123;<br>        map.put(<span class="hljs-string">&quot;oldPasswordMsg&quot;</span>, <span class="hljs-string">&quot;原密码输入有误!&quot;</span>);<br>        <span class="hljs-keyword">return</span> map;<br>    &#125;<br><br>    <span class="hljs-comment">// 更新密码</span><br>    newPassword = CommunityUtil.md5(newPassword + user.getSalt());<br>    userMapper.updatePassword(userId, newPassword);<br><br>    <span class="hljs-keyword">return</span> map;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>表现层：UserController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 修改密码</span><br><span class="hljs-meta">@RequestMapping(path = &quot;/updatePassword&quot;, method = RequestMethod.POST)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">updatePassword</span><span class="hljs-params">(String oldPassword, String newPassword, Model model)</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> hostHolder.getUser();<br>    Map&lt;String, Object&gt; map = userService.updatePassword(user.getId(), oldPassword, newPassword);<br>    <span class="hljs-keyword">if</span> (map == <span class="hljs-literal">null</span> || map.isEmpty()) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/logout&quot;</span>;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        model.addAttribute(<span class="hljs-string">&quot;oldPasswordMsg&quot;</span>, map.get(<span class="hljs-string">&quot;oldPasswordMsg&quot;</span>));<br>        model.addAttribute(<span class="hljs-string">&quot;newPasswordMsg&quot;</span>, map.get(<span class="hljs-string">&quot;newPasswordMsg&quot;</span>));<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/setting&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h2 id="8-检查登陆状态"><a href="#8-检查登陆状态" class="headerlink" title="8. 检查登陆状态"></a>8. 检查登陆状态</h2><p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch2%E5%8A%9F%E8%83%BD%E6%8F%8F%E8%BF%B0-%E6%A3%80%E6%9F%A5%E7%99%BB%E5%BD%95%E7%8A%B6%E6%80%81.png" srcset="/img/loading.gif" lazyload alt="image-20220515235356138"></p>
<p>之前显示登陆信息一节利用拦截器区分了登录状态，未登录显示首页，有注册、登录按钮，登陆后显示首页、消息和头像等信息，但也只是根据登陆状态判断是否显示这些按钮，事实上我们还应该从根本解决问题，根据登陆状态去判断哪些请求可以访问，哪些请求不会访问。</p>
<p>比如在未登录状态下，我知道账号设置的url是<code>http://localhost:8080/community/user/setting</code>，那我就可以直接访问了，这显示不合理的，会造成很多安全问题。所以需要检查登陆状态，使用拦截器区分哪些请求在登录状态下才可以响应，哪些请求未登录时是不能响应的</p>
<p>这里换一种实现方式，不在拦截器配置里用<code>excludePathPatterns</code>或者<code>addPathPatterns</code>了，而是自定义一个注解@LoginRequired，加了该注解的请求，是需要登陆状态才让服务器响应的，没有加该注解的请求，未登录状态服务器也可以响应请求</p>
<h3 id="新建自定义注解"><a href="#新建自定义注解" class="headerlink" title="新建自定义注解"></a>新建自定义注解</h3><p>新建annotation包，创建注解@LoginRequired</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Target(ElementType.METHOD)</span>  <span class="hljs-comment">// 元注解@Target表明自定义注解的作用范围，ElementType.METHOD表示是作用在方法上的</span><br><span class="hljs-meta">@Retention(RetentionPolicy.RUNTIME)</span> <span class="hljs-comment">// 元注解@Retention表明自定义注解的有效时间，RetentionPolicy.RUNTIME表示是运行期间有效</span><br><span class="hljs-keyword">public</span> <span class="hljs-meta">@interface</span> LoginRequired &#123;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>那么目前的请求方法里，有以下需要登录后才能让响应的请求，分别给他们加上注解@LoginRequired：</p>
<p>（1）返回账号设置页面的请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@LoginRequired</span><br><span class="hljs-meta">@RequestMapping(path = &quot;/setting&quot;, method = RequestMethod.GET)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getSettingPage</span><span class="hljs-params">()</span>&#123;&#125;<br></code></pre></td></tr></table></figure>

<p>（2）上传头像图片的请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@LoginRequired</span><br><span class="hljs-meta">@RequestMapping(path = &quot;/upload&quot;, method = RequestMethod.POST)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">uploadHeader</span><span class="hljs-params">(MultipartFile headerImage, Model model)</span> &#123;&#125;<br></code></pre></td></tr></table></figure>

<p>注意读取头像图片的请求是不用登录状态的，因为我在首页未登录时候也可以查看别人的头像</p>
<h3 id="自定义拦截器"><a href="#自定义拦截器" class="headerlink" title="自定义拦截器"></a>自定义拦截器</h3><p>下面就要编写一个拦截器能够拦截那些加了@LoginRequired注解的请求，只有登陆状态才能响应请求，编写LoginRequiredInterceptor文件，重写preHandle方法，因为肯定是在请求之前拦截，如何判断是否是登陆状态，注入HostHolder看是否能够获取到对象即可，能够获取到说明登录成功，其他的逻辑见注释</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LoginRequiredInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HostHolder hostHolder; <span class="hljs-comment">// 根据HostHolder能否获取到对象来判断用户是否登录成功</span><br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">preHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-comment">// 首先判断拦截的对象Object handler是不是一个方法，我们这里只拦截方法，HandlerMethod是mvc提供的代表方法的对象</span><br>        <span class="hljs-keyword">if</span> (handler <span class="hljs-keyword">instanceof</span> HandlerMethod) &#123;<br>            <span class="hljs-comment">// 既然是方法，就把他转成方法，更好的调用api，而不是用一开始的普通对象Object handler</span><br>            <span class="hljs-type">HandlerMethod</span> <span class="hljs-variable">handlerMethod</span> <span class="hljs-operator">=</span> (HandlerMethod) handler;<br>            <span class="hljs-type">Method</span> <span class="hljs-variable">method</span> <span class="hljs-operator">=</span> handlerMethod.getMethod(); <span class="hljs-comment">// 这个代表方法的对象，能够获取到被拦截的具体是什么方法</span><br>            <span class="hljs-type">LoginRequired</span> <span class="hljs-variable">loginRequired</span> <span class="hljs-operator">=</span> method.getAnnotation(LoginRequired.class); <span class="hljs-comment">// 尝试去获取被拦截方法的注解，此处只获取我们所需要的@LoginRequired</span><br>            <span class="hljs-comment">// 如果loginRequired不为空，说明被拦截方法加了@LoginRequired注解，并且没获取到登录的用户，即用户登录没成功，那就拦截这个请求</span><br>            <span class="hljs-keyword">if</span> (loginRequired != <span class="hljs-literal">null</span> &amp;&amp; hostHolder.getUser() == <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-comment">// 拒绝之后得告诉他去哪，此处直接重定向至登录页面，意思就是像访问这个就去登陆</span><br>                response.sendRedirect(request.getContextPath() + <span class="hljs-string">&quot;/login&quot;</span>);  <span class="hljs-comment">// 注意response重定向的写法，这里不能直接用mvc的return &quot;redirect:...&quot;;</span><br>                <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>; <span class="hljs-comment">// 返回false，即为拒绝后续的请求，即拦截请求</span><br>            &#125;<br>        &#125;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">true</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="配置拦截器-1"><a href="#配置拦截器-1" class="headerlink" title="配置拦截器"></a>配置拦截器</h3><p>将自定义的拦截器配置到mvc里，和之前的拦截器一样，我们希望他不要拦截静态资源浪费时间，而是拦截所有的动态请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">WebMvcConfig</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">WebMvcConfigurer</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> LoginTicketInterceptor loginTicketInterceptor;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> LoginRequiredInterceptor loginRequiredInterceptor;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">addInterceptors</span><span class="hljs-params">(InterceptorRegistry registry)</span> &#123;<br>        registry.addInterceptor(loginTicketInterceptor)<br>                .excludePathPatterns(<span class="hljs-string">&quot;/**/*.css&quot;</span>, <span class="hljs-string">&quot;/**/*.js&quot;</span>, <span class="hljs-string">&quot;/**/*.png&quot;</span>, <span class="hljs-string">&quot;/**/*.jpg&quot;</span>, <span class="hljs-string">&quot;/**/*.jpeg&quot;</span>);<br><br>        registry.addInterceptor(loginRequiredInterceptor)<br>                .excludePathPatterns(<span class="hljs-string">&quot;/**/*.css&quot;</span>, <span class="hljs-string">&quot;/**/*.js&quot;</span>, <span class="hljs-string">&quot;/**/*.png&quot;</span>, <span class="hljs-string">&quot;/**/*.jpg&quot;</span>, <span class="hljs-string">&quot;/**/*.jpeg&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="测试"><a href="#测试" class="headerlink" title="测试"></a>测试</h3><p>现在未登录状态下，去访问账号设置的url<code>http://localhost:8080/community/user/setting</code>，会重定向到登陆页面，这样才是安全合理的</p>
<h1 id="三、SpringBoot进阶：开发社区核心功能"><a href="#三、SpringBoot进阶：开发社区核心功能" class="headerlink" title="三、SpringBoot进阶：开发社区核心功能"></a>三、SpringBoot进阶：开发社区核心功能</h1><h2 id="1-过滤敏感词"><a href="#1-过滤敏感词" class="headerlink" title="1. 过滤敏感词"></a>1. 过滤敏感词</h2><p>本节使用前缀树Trie过滤敏感词</p>
<p>首先在resources文件夹下创建敏感词文件sensitive-words.txt，编写敏感词，一个词一行</p>
<p>后面编写敏感词过滤器工具类，这部分涉及到很多前缀树的数据结构知识，不做过多的说明，代码也不贴了，去项目工程文件里看就可以，基本就是常见的前缀树操作。不过敏感词的匹配和替换用到了三个指针的思想，那段代码以前没写过，有一定的难度，有空可以自己再写写画画</p>
<p>测试环节在test里进行过测试，可以实现过滤敏感词的功能</p>
<p>更新：这部分代码可能有bug，详细见牛客对应课程讨论区</p>
<h2 id="2-发布帖子"><a href="#2-发布帖子" class="headerlink" title="2. 发布帖子"></a>2. 发布帖子</h2><p>AJAX（Asynchronous JavaScript and XML），异步的JavaScript与XML，不是一门新技术，只是一个新的术语。使用AJAX，网页能够将增量更新呈现在页面上，而不需要刷新整个页面。虽然X代表XML，但目前JSON的使用比XML更加普遍</p>
<p>本项目使用js框架jQuery来发送AJAX请求</p>
<p>首先在CommunityUtil类里编写JSON格式字符串处理的代码，后面会经常用到，这里引入一个新的依赖，fastjson，它的效率更高</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 参数：编码、提示信息、业务数据map</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getJSONString</span><span class="hljs-params">(<span class="hljs-type">int</span> code, String msg, Map&lt;String, Object&gt; map)</span> &#123;<br>    <span class="hljs-type">JSONObject</span> <span class="hljs-variable">json</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">JSONObject</span>();<br>    json.put(<span class="hljs-string">&quot;code&quot;</span>, code);<br>    json.put(<span class="hljs-string">&quot;msg&quot;</span>, msg);<br>    <span class="hljs-keyword">if</span> (map != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">for</span> (String key : map.keySet()) &#123;<br>            json.put(key, map.get(key));<br>        &#125;<br>    &#125;<br>    <span class="hljs-keyword">return</span> json.toJSONString();<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getJSONString</span><span class="hljs-params">(<span class="hljs-type">int</span> code, String msg)</span> &#123;<br>    <span class="hljs-keyword">return</span> getJSONString(code, msg, <span class="hljs-literal">null</span>);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getJSONString</span><span class="hljs-params">(<span class="hljs-type">int</span> code)</span> &#123;<br>    <span class="hljs-keyword">return</span> getJSONString(code, <span class="hljs-literal">null</span>, <span class="hljs-literal">null</span>);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>下面就是按照三层架构去编写发布帖子功能</p>
<p>（1）数据访问层</p>
<p>在DiscussPostMapper写一个增加帖子的方法，并在对应的mapper.xml文件编写sql语句</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 增加帖子的方法</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">insertDiscussPost</span><span class="hljs-params">(DiscussPost discussPost)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insertDiscussPost&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;DiscussPost&quot;</span>&gt;</span><br>    insert into discuss_post(<span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;insertFields&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>)<br>    values(#&#123;userId&#125;,#&#123;title&#125;,#&#123;content&#125;,#&#123;type&#125;,#&#123;status&#125;,#&#123;createTime&#125;,#&#123;commentCount&#125;,#&#123;score&#125;)<br><span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>（2）业务层</p>
<p>在DiscussPostService写业务层增加帖子的代码，这里用到前一个小节的敏感词过滤方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">addDiscussPost</span><span class="hljs-params">(DiscussPost post)</span> &#123;<br>    <span class="hljs-keyword">if</span> (post == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;参数不能为空!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 转义HTML标记 如&lt;font&gt;等类似的标签，HtmlUtils是mvc提供的工具</span><br>    <span class="hljs-comment">// DiscussPost对象里只有Title和Content需要处理</span><br>    post.setTitle(HtmlUtils.htmlEscape(post.getTitle()));<br>    post.setContent(HtmlUtils.htmlEscape(post.getContent()));<br>    <span class="hljs-comment">// 过滤敏感词</span><br>    post.setTitle(sensitiveFilter.filter(post.getTitle()));<br>    post.setContent(sensitiveFilter.filter(post.getContent()));<br><br>    <span class="hljs-keyword">return</span> discussPostMapper.insertDiscussPost(post);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（3）表现层</p>
<p>这里新建一个DiscussPostController用于专门处理有关帖子的请求</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/discuss&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">DiscussPostController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DiscussPostService discussPostService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HostHolder hostHolder;<br><br>    <span class="hljs-meta">@RequestMapping(path = &quot;/add&quot;, method = RequestMethod.POST)</span><br>    <span class="hljs-meta">@ResponseBody</span>  <span class="hljs-comment">// 异步请求，返回JSON字符串，不是返回网页</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addDiscussPost</span><span class="hljs-params">(String title, String content)</span> &#123; <span class="hljs-comment">// 页面上只需要传入标题和内容，剩下的信息都是自动获取的</span><br>        <span class="hljs-comment">// 首先判断用户登录</span><br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> hostHolder.getUser();<br>        <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">403</span>, <span class="hljs-string">&quot;你还没有登录哦!&quot;</span>);<br>        &#125;<br><br>        <span class="hljs-type">DiscussPost</span> <span class="hljs-variable">post</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">DiscussPost</span>();<br>        post.setUserId(user.getId());<br>        post.setTitle(title);<br>        post.setContent(content);<br>        post.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        discussPostService.addDiscussPost(post);<br><br>        <span class="hljs-comment">// 报错的情况,将来统一处理</span><br>        <span class="hljs-comment">// ...</span><br>        <br>        <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;发布成功!&quot;</span>);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（4）前端</p>
<p>主要是编写用于发送异步请求的ajax，index.js</p>
<figure class="highlight js"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs js">$(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>	$(<span class="hljs-string">&quot;#publishBtn&quot;</span>).<span class="hljs-title function_">click</span>(publish);<br>&#125;);<br><br><span class="hljs-keyword">function</span> <span class="hljs-title function_">publish</span>(<span class="hljs-params"></span>) &#123;<br>	$(<span class="hljs-string">&quot;#publishModal&quot;</span>).<span class="hljs-title function_">modal</span>(<span class="hljs-string">&quot;hide&quot;</span>);<br><br>	<span class="hljs-comment">// 获取标题和内容</span><br>	<span class="hljs-keyword">var</span> title = $(<span class="hljs-string">&quot;#recipient-name&quot;</span>).<span class="hljs-title function_">val</span>();<br>	<span class="hljs-keyword">var</span> content = $(<span class="hljs-string">&quot;#message-text&quot;</span>).<span class="hljs-title function_">val</span>();<br>	<span class="hljs-comment">// 发送异步请求(POST)</span><br>	$.<span class="hljs-title function_">post</span>(<br>	    <span class="hljs-variable constant_">CONTEXT_PATH</span> + <span class="hljs-string">&quot;/discuss/add&quot;</span>,<br>	    &#123;<span class="hljs-string">&quot;title&quot;</span>:title,<span class="hljs-string">&quot;content&quot;</span>:content&#125;,<br>	    <span class="hljs-keyword">function</span>(<span class="hljs-params">data</span>) &#123;<br>	        data = $.<span class="hljs-title function_">parseJSON</span>(data);<br>	        <span class="hljs-comment">// 在提示框中显示返回消息</span><br>	        $(<span class="hljs-string">&quot;#hintBody&quot;</span>).<span class="hljs-title function_">text</span>(data.<span class="hljs-property">msg</span>);<br>	        <span class="hljs-comment">// 显示提示框</span><br>            $(<span class="hljs-string">&quot;#hintModal&quot;</span>).<span class="hljs-title function_">modal</span>(<span class="hljs-string">&quot;show&quot;</span>);<br>            <span class="hljs-comment">// 2秒后,自动隐藏提示框</span><br>            <span class="hljs-built_in">setTimeout</span>(<span class="hljs-keyword">function</span>(<span class="hljs-params"></span>)&#123;<br>                $(<span class="hljs-string">&quot;#hintModal&quot;</span>).<span class="hljs-title function_">modal</span>(<span class="hljs-string">&quot;hide&quot;</span>);<br>                <span class="hljs-comment">// 刷新页面</span><br>                <span class="hljs-keyword">if</span>(data.<span class="hljs-property">code</span> == <span class="hljs-number">0</span>) &#123;<br>                    <span class="hljs-variable language_">window</span>.<span class="hljs-property">location</span>.<span class="hljs-title function_">reload</span>();<br>                &#125;<br>            &#125;, <span class="hljs-number">2000</span>);<br>	    &#125;<br>	);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（5）测试</p>
<p>分别发布正常的帖子，和带html标签、敏感词的帖子进行测试。</p>
<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch3-%E5%8F%91%E5%B8%83%E5%B8%96%E5%AD%90-%E5%8F%91%E5%B8%83%E6%88%90%E5%8A%9F%E9%A6%96%E9%A1%B5.png" srcset="/img/loading.gif" lazyload alt="image-20220519165255013"></p>
<h2 id="3-帖子详情"><a href="#3-帖子详情" class="headerlink" title="3. 帖子详情"></a>3. 帖子详情</h2><p>查看每个发布帖子的详情页面，按照三层架构开发即可</p>
<p>（1）数据访问层，DiscussPostMapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><code class="hljs Java">DiscussPost <span class="hljs-title function_">selectDiscussPostById</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectDiscussPostById&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;DiscussPost&quot;</span>&gt;</span><br>    select <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;selectFields&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>    from discuss_post<br>    where id = #&#123;id&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>（2）业务层，DiscussPostService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> DiscussPost <span class="hljs-title function_">findDiscussPostById</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>    <span class="hljs-keyword">return</span> discussPostMapper.selectDiscussPostById(id);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（3）表现层，DiscussPostController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping(path = &quot;/detail/&#123;discussPostId&#125;&quot;, method = RequestMethod.GET)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDiscussPost</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;discussPostId&quot;)</span> <span class="hljs-type">int</span> discussPostId, Model model)</span> &#123;<br>    <span class="hljs-comment">// 帖子</span><br>    <span class="hljs-type">DiscussPost</span> <span class="hljs-variable">post</span> <span class="hljs-operator">=</span> discussPostService.findDiscussPostById(discussPostId);<br>    model.addAttribute(<span class="hljs-string">&quot;post&quot;</span>, post);<br>    <span class="hljs-comment">// 作者信息，肯定是不希望只展示用户id的，根据帖子的userId把作者的信息展示出来</span><br>    <span class="hljs-comment">// 两种办法：在sql语句中使用关联查询查一下用户表，效率高，代码稍微麻烦点； 如下所示，调用一下userService的业务层去查信息</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findUserById(post.getUserId());<br>    model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>, user);<br><br>    <span class="hljs-comment">// ... 后续功能待补充</span><br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/discuss-detail&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（4）前端</p>
<p>更改index.html和discuss-detail.html</p>
<p>（5）测试</p>
<h2 id="4-事务管理"><a href="#4-事务管理" class="headerlink" title="4. 事务管理"></a>4. 事务管理</h2><p>此部分为前置知识，不涉及项目具体开发</p>
<h2 id="5-显示评论"><a href="#5-显示评论" class="headerlink" title="5. 显示评论"></a>5. 显示评论</h2><p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch3-%E6%98%BE%E7%A4%BA%E8%AF%84%E8%AE%BA-%E9%A1%B5%E9%9D%A2.png" srcset="/img/loading.gif" lazyload alt="image-20220519195144399"></p>
<p>依然是按照三层架构进行开发</p>
<p>（1）数据访问层</p>
<p>先创建comment的实体</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Comment</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> userId;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> entityType;   <span class="hljs-comment">// 评论目标的类别</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> entityId;     <span class="hljs-comment">// 目标类别的id</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> targetId;     <span class="hljs-comment">// 给哪个id进行评论（回复）</span><br>    <span class="hljs-keyword">private</span> String content;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> status;<br>    <span class="hljs-keyword">private</span> Date createTime;  <br>    <br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>再创建数据访问层CommentMapper以及对应的mapper.xml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">CommentMapper</span> &#123;<br>    <span class="hljs-comment">// 根据评论目标类别与目标id完成分页查询</span><br>    List&lt;Comment&gt; <span class="hljs-title function_">selectCommentsByEntity</span><span class="hljs-params">(<span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId, <span class="hljs-type">int</span> offset, <span class="hljs-type">int</span> limit)</span>;<br><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">selectCountByEntity</span><span class="hljs-params">(<span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectFields&quot;</span>&gt;</span><br>    id, user_id, entity_type, entity_id, target_id, content, status, create_time<br><span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectCommentsByEntity&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;Comment&quot;</span>&gt;</span><br>    select <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;selectFields&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>    from comment<br>    where status = 0<br>    and entity_type = #&#123;entityType&#125;<br>    and entity_id = #&#123;entityId&#125;<br>    order by create_time asc<br>    limit #&#123;offset&#125;, #&#123;limit&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectCountByEntity&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;int&quot;</span>&gt;</span><br>    select count(id)<br>    from comment<br>    where status = 0<br>    and entity_type = #&#123;entityType&#125;<br>    and entity_id = #&#123;entityId&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>（2）业务层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommentService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CommentMapper commentMapper;<br><br>    <span class="hljs-comment">// 根据评论目标类别与目标id完成分页查询</span><br>    <span class="hljs-keyword">public</span> List&lt;Comment&gt; <span class="hljs-title function_">findCommentsByEntity</span><span class="hljs-params">(<span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId, <span class="hljs-type">int</span> offset, <span class="hljs-type">int</span> limit)</span> &#123;<br>        <span class="hljs-keyword">return</span> commentMapper.selectCommentsByEntity(entityType, entityId, offset, limit);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findCommentCount</span><span class="hljs-params">(<span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId)</span> &#123;<br>        <span class="hljs-keyword">return</span> commentMapper.selectCountByEntity(entityType, entityId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（3）表现层</p>
<p>由于是在帖子详情页面下面加载评论，在之前开发的表现层文件继续开发，DiscussPostController，逻辑和细节见注释</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping(path = &quot;/detail/&#123;discussPostId&#125;&quot;, method = RequestMethod.GET)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDiscussPost</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;discussPostId&quot;)</span> <span class="hljs-type">int</span> discussPostId, Model model, Page page)</span> &#123;<br>    <span class="hljs-comment">// 帖子</span><br>    <span class="hljs-type">DiscussPost</span> <span class="hljs-variable">post</span> <span class="hljs-operator">=</span> discussPostService.findDiscussPostById(discussPostId);<br>    model.addAttribute(<span class="hljs-string">&quot;post&quot;</span>, post);<br>    <span class="hljs-comment">// 作者信息，肯定是不希望只展示用户id的，根据帖子的userId把作者的信息展示出来</span><br>    <span class="hljs-comment">// 两种办法：在sql语句中使用关联查询查一下用户表，效率高，代码稍微麻烦点； 如下所示，调用一下userService的业务层去查信息</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findUserById(post.getUserId());<br>    model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>, user);<br><br>    <span class="hljs-comment">// 评论分页信息</span><br>    page.setLimit(<span class="hljs-number">5</span>);<br>    page.setPath(<span class="hljs-string">&quot;/discuss/detail/&quot;</span> + discussPostId);<br>    page.setRows(post.getCommentCount());<br><br>    <span class="hljs-comment">// 评论: 给帖子的评论</span><br>    <span class="hljs-comment">// 回复: 给评论的评论</span><br>    <span class="hljs-comment">// 评论列表</span><br>    List&lt;Comment&gt; commentList = commentService.findCommentsByEntity(<br>            ENTITY_TYPE_POST, post.getId(), page.getOffset(), page.getLimit());<br><br>    <span class="hljs-comment">// 评论VO（View Object）列表：显示对象的列表，我们除了希望展示评论，</span><br>    <span class="hljs-comment">// comment表还关联了一些用户id，我们希望根据这些id查找到用户的信息并展示出来</span><br>    List&lt;Map&lt;String, Object&gt;&gt; commentVoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">if</span> (commentList != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">for</span> (Comment comment : commentList) &#123;<br>            <span class="hljs-comment">// 每个评论的VO（显示对象）</span><br>            Map&lt;String, Object&gt; commentVo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>            <span class="hljs-comment">// 往显示对象里添加评论</span><br>            commentVo.put(<span class="hljs-string">&quot;comment&quot;</span>, comment);<br>            <span class="hljs-comment">// 往显示对象里添加作者</span><br>            commentVo.put(<span class="hljs-string">&quot;user&quot;</span>, userService.findUserById(comment.getUserId()));<br><br>            <span class="hljs-comment">// 往显示对象里添加回复列表（嵌套）</span><br>            <span class="hljs-comment">// 回复列表，处理同上</span><br>            List&lt;Comment&gt; replyList = commentService.findCommentsByEntity(<br>                    ENTITY_TYPE_COMMENT, comment.getId(), <span class="hljs-number">0</span>, Integer.MAX_VALUE); <span class="hljs-comment">//</span><br>            <span class="hljs-comment">// 回复的VO列表</span><br>            List&lt;Map&lt;String, Object&gt;&gt; replyVoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>            <span class="hljs-keyword">if</span> (replyList != <span class="hljs-literal">null</span>) &#123;<br>                <span class="hljs-keyword">for</span> (Comment reply : replyList) &#123;<br>                    Map&lt;String, Object&gt; replyVo = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>                    <span class="hljs-comment">// 回复</span><br>                    replyVo.put(<span class="hljs-string">&quot;reply&quot;</span>, reply);<br>                    <span class="hljs-comment">// 作者</span><br>                    replyVo.put(<span class="hljs-string">&quot;user&quot;</span>, userService.findUserById(reply.getUserId()));<br>                    <span class="hljs-comment">// 回复目标（回复才要处理回复目标，评论没有目标）</span><br>                    <span class="hljs-type">User</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> reply.getTargetId() == <span class="hljs-number">0</span> ? <span class="hljs-literal">null</span> : userService.findUserById(reply.getTargetId());<br>                    replyVo.put(<span class="hljs-string">&quot;target&quot;</span>, target);<br><br>                    replyVoList.add(replyVo);<br>                &#125;<br>            &#125;<br>            commentVo.put(<span class="hljs-string">&quot;replys&quot;</span>, replyVoList);<br><br>            <span class="hljs-comment">// 回复数量，用于在页面上显示</span><br>            <span class="hljs-type">int</span> <span class="hljs-variable">replyCount</span> <span class="hljs-operator">=</span> commentService.findCommentCount(ENTITY_TYPE_COMMENT, comment.getId());<br>            commentVo.put(<span class="hljs-string">&quot;replyCount&quot;</span>, replyCount);<br><br>            commentVoList.add(commentVo);<br>        &#125;<br>    &#125;<br><br>    model.addAttribute(<span class="hljs-string">&quot;comments&quot;</span>, commentVoList);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/discuss-detail&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（4）前端</p>
<p>前端页面要调的东西比较多，不详细写了。替换代码里的index.html 和 discuss-detail.html</p>
<p>（5）测试</p>
<p>访问首页的帖子进行测试</p>
<h2 id="6-添加评论"><a href="#6-添加评论" class="headerlink" title="6. 添加评论"></a>6. 添加评论</h2><p>三层架构开发</p>
<p>（1）数据层</p>
<p>增加评论数据，CommentMapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 添加评论</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">insertComment</span><span class="hljs-params">(Comment comment)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insertComment&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;Comment&quot;</span>&gt;</span><br>    insert into comment(<span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;insertFields&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>)<br>    values(#&#123;userId&#125;,#&#123;entityType&#125;,#&#123;entityId&#125;,#&#123;targetId&#125;,#&#123;content&#125;,#&#123;status&#125;,#&#123;createTime&#125;)<br><span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>更新帖子的评论数量，DiscussPostMapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 更新帖子的评论数量</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">updateCommentCount</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-type">int</span> commentCount)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;updateCommentCount&quot;</span>&gt;</span><br>    update discuss_post set comment_count = #&#123;commentCount&#125; where id = #&#123;id&#125;<br><span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br></code></pre></td></tr></table></figure>



<p>（2）业务层</p>
<p>处理添加评论的业务，先增加评论，需要用到事务管理。CommentService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 增加评论，需要进行事务管理</span><br><span class="hljs-meta">@Transactional(isolation = Isolation.READ_COMMITTED, propagation = Propagation.REQUIRED)</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">addComment</span><span class="hljs-params">(Comment comment)</span> &#123;<br>    <span class="hljs-keyword">if</span> (comment == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">IllegalArgumentException</span>(<span class="hljs-string">&quot;参数不能为空!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 添加评论，过滤html标签、敏感词</span><br>    comment.setContent(HtmlUtils.htmlEscape(comment.getContent()));<br>    comment.setContent(sensitiveFilter.filter(comment.getContent()));<br>    <span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> commentMapper.insertComment(comment);<br><br>    <span class="hljs-comment">// 更新帖子的评论数量，评论的回复数量不用更新</span><br>    <span class="hljs-keyword">if</span> (comment.getEntityType() == ENTITY_TYPE_POST) &#123;<br>        <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> commentMapper.selectCountByEntity(comment.getEntityType(), comment.getEntityId());<br>        discussPostService.updateCommentCount(comment.getEntityId(), count);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> rows;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>再更新帖子的评论数量，DiscussPostService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 更新帖子的评论数量</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">updateCommentCount</span><span class="hljs-params">(<span class="hljs-type">int</span> id, <span class="hljs-type">int</span> commentCount)</span> &#123;<br>    <span class="hljs-keyword">return</span> discussPostMapper.updateCommentCount(id, commentCount);<br>&#125;<br></code></pre></td></tr></table></figure>



<p>（3）表现层</p>
<p>处理添加评论数据的请求。设置添加评论的表单。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/comment&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommentController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CommentService commentService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HostHolder hostHolder;<br><br>    <span class="hljs-comment">// 增加完评论后，我们希望它能回到当前帖子页面，所以需要传进来帖子id</span><br>    <span class="hljs-meta">@RequestMapping(path = &quot;/add/&#123;discussPostId&#125;&quot;, method = RequestMethod.POST)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addComment</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;discussPostId&quot;)</span> <span class="hljs-type">int</span> discussPostId, Comment comment)</span> &#123;<br>        comment.setUserId(hostHolder.getUser().getId()); <span class="hljs-comment">// 需要得到当前用户的id</span><br>        comment.setStatus(<span class="hljs-number">0</span>);<br>        comment.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        commentService.addComment(comment);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/discuss/detail/&quot;</span> + discussPostId;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>（4）前端和测试</p>
<p>更改discuss-detail.html</p>
<p>进行测试</p>
<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch3-%E6%B7%BB%E5%8A%A0%E8%AF%84%E8%AE%BA-%E6%B5%8B%E8%AF%95.png" srcset="/img/loading.gif" lazyload alt="image-20220520144012868"></p>
<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch3-%E6%B7%BB%E5%8A%A0%E5%9B%9E%E5%A4%8D-%E6%B5%8B%E8%AF%95.png" srcset="/img/loading.gif" lazyload alt="image-20220520144226604"></p>
<h2 id="7-私信列表"><a href="#7-私信列表" class="headerlink" title="7. 私信列表"></a>7. 私信列表</h2><p>私信列表：查询当前用户的会话列表，每个会话只显示一条最新的私信，支持分页显示。</p>
<p>私信详情：查询某个会话所包含的私信，支持分页显示</p>
<p>（1）数据层</p>
<p>封装消息的实体类</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Message</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> id;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> fromId;             <span class="hljs-comment">// from_id为1表示是系统通知</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> toId;<br>    <span class="hljs-keyword">private</span> String conversationId;  <span class="hljs-comment">// 表示从谁到谁的会话，默认id小放在前面</span><br>    <span class="hljs-keyword">private</span> String content;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> status;             <span class="hljs-comment">// 0-未读;1-已读;2-删除</span><br>    <span class="hljs-keyword">private</span> Date createTime;<br><br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>mapper类及其sql语句，MessageMapper。这里的sql语句都值得反复理解，比较复杂</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MessageMapper</span> &#123;<br><br>    <span class="hljs-comment">// 查询当前用户的所有会话列表,针对每个会话只返回一条最新的私信。这里的sql语句注意理解</span><br>    List&lt;Message&gt; <span class="hljs-title function_">selectConversations</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> offset, <span class="hljs-type">int</span> limit)</span>;<br><br>    <span class="hljs-comment">// 查询当前用户的所有会话数量。这里的sql语句注意理解</span><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">selectConversationCount</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span>;<br><br>    <span class="hljs-comment">// 查询某个会话所包含的私信列表。这里的sql语句注意理解</span><br>    List&lt;Message&gt; <span class="hljs-title function_">selectLetters</span><span class="hljs-params">(String conversationId, <span class="hljs-type">int</span> offset, <span class="hljs-type">int</span> limit)</span>;<br><br>    <span class="hljs-comment">// 查询某个会话所包含的私信数量。这里的sql语句注意理解</span><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">selectLetterCount</span><span class="hljs-params">(String conversationId)</span>;<br><br>    <span class="hljs-comment">// 查询未读私信的数量。这里的sql语句注意理解</span><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">selectLetterUnreadCount</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String conversationId)</span>;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">mapper</span> <span class="hljs-attr">namespace</span>=<span class="hljs-string">&quot;com.wanyu.community.dao.MessageMapper&quot;</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">sql</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectFields&quot;</span>&gt;</span><br>        id, from_id, to_id, conversation_id, content, status, create_time<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">sql</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectConversations&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;Message&quot;</span>&gt;</span><br>        select <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;selectFields&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>        from message<br>        where id in (<br>            select max(id) from message<br>            where status != 2<br>            and from_id != 1<br>            and (from_id = #&#123;userId&#125; or to_id = #&#123;userId&#125;)<br>            group by conversation_id<br>        )<br>        order by id desc<br>        limit #&#123;offset&#125;, #&#123;limit&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectConversationCount&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;int&quot;</span>&gt;</span><br>        select count(m.maxid) from (<br>            select max(id) as maxid from message<br>            where status != 2<br>            and from_id != 1<br>            and (from_id = #&#123;userId&#125; or to_id = #&#123;userId&#125;)<br>            group by conversation_id<br>        ) as m<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectLetters&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;Message&quot;</span>&gt;</span><br>        select <span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;selectFields&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span><br>        from message<br>        where status != 2<br>        and from_id != 1<br>        and conversation_id = #&#123;conversationId&#125;<br>        order by id desc<br>        limit #&#123;offset&#125;, #&#123;limit&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectLetterCount&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;int&quot;</span>&gt;</span><br>        select count(id)<br>        from message<br>        where status != 2<br>        and from_id != 1<br>        and conversation_id = #&#123;conversationId&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br><br>    <span class="hljs-tag">&lt;<span class="hljs-name">select</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;selectLetterUnreadCount&quot;</span> <span class="hljs-attr">resultType</span>=<span class="hljs-string">&quot;int&quot;</span>&gt;</span><br>        select count(id)<br>        from message<br>        where status = 0<br>        and from_id != 1<br>        and to_id = #&#123;userId&#125;<br>        <span class="hljs-tag">&lt;<span class="hljs-name">if</span> <span class="hljs-attr">test</span>=<span class="hljs-string">&quot;conversationId!=null&quot;</span>&gt;</span><br>            and conversation_id = #&#123;conversationId&#125;<br>        <span class="hljs-tag">&lt;/<span class="hljs-name">if</span>&gt;</span><br>    <span class="hljs-tag">&lt;/<span class="hljs-name">select</span>&gt;</span><br>    <br><span class="hljs-tag">&lt;/<span class="hljs-name">mapper</span>&gt;</span><br></code></pre></td></tr></table></figure>

<p>在进行业务层开发之前可以先进行一下测试</p>
<p>（2）业务层</p>
<p>就是调用数据访问层，没有其他特殊的业务逻辑</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageService</span> &#123;<br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MessageMapper messageMapper;<br><br>    <span class="hljs-keyword">public</span> List&lt;Message&gt; <span class="hljs-title function_">findConversations</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> offset, <span class="hljs-type">int</span> limit)</span> &#123;<br>        <span class="hljs-keyword">return</span> messageMapper.selectConversations(userId, offset, limit);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findConversationCount</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> &#123;<br>        <span class="hljs-keyword">return</span> messageMapper.selectConversationCount(userId);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> List&lt;Message&gt; <span class="hljs-title function_">findLetters</span><span class="hljs-params">(String conversationId, <span class="hljs-type">int</span> offset, <span class="hljs-type">int</span> limit)</span> &#123;<br>        <span class="hljs-keyword">return</span> messageMapper.selectLetters(conversationId, offset, limit);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findLetterCount</span><span class="hljs-params">(String conversationId)</span> &#123;<br>        <span class="hljs-keyword">return</span> messageMapper.selectLetterCount(conversationId);<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findLetterUnreadCount</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String conversationId)</span> &#123;<br>        <span class="hljs-keyword">return</span> messageMapper.selectLetterUnreadCount(userId, conversationId);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>（3）表现层</p>
<p>私信列表</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MessageService messageService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HostHolder hostHolder;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> UserService userService;<br><br>    <span class="hljs-comment">// 私信列表</span><br>    <span class="hljs-meta">@RequestMapping(path = &quot;/letter/list&quot;, method = RequestMethod.GET)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getLetterList</span><span class="hljs-params">(Model model, Page page)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> hostHolder.getUser();<br>        <span class="hljs-comment">// 分页信息</span><br>        page.setLimit(<span class="hljs-number">5</span>);<br>        page.setPath(<span class="hljs-string">&quot;/letter/list&quot;</span>);<br>        page.setRows(messageService.findConversationCount(user.getId()));<br><br>        <span class="hljs-comment">// 会话列表</span><br>        List&lt;Message&gt; conversationList = messageService.findConversations(<br>                user.getId(), page.getOffset(), page.getLimit());<br><br>        List&lt;Map&lt;String, Object&gt;&gt; conversations = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">if</span> (conversationList != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (Message message : conversationList) &#123;<br>                Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>                map.put(<span class="hljs-string">&quot;conversation&quot;</span>, message); <span class="hljs-comment">// 放消息内容</span><br>                map.put(<span class="hljs-string">&quot;letterCount&quot;</span>, messageService.findLetterCount(message.getConversationId())); <span class="hljs-comment">// 放消息数量</span><br>                map.put(<span class="hljs-string">&quot;unreadCount&quot;</span>, messageService.findLetterUnreadCount(user.getId(), message.getConversationId()));  <span class="hljs-comment">// 放未读消息数量</span><br>                <span class="hljs-type">int</span> <span class="hljs-variable">targetId</span> <span class="hljs-operator">=</span> user.getId() == message.getFromId() ? message.getToId() : message.getFromId(); <span class="hljs-comment">// 找到和当前用户对话的userId</span><br>                map.put(<span class="hljs-string">&quot;target&quot;</span>, userService.findUserById(targetId));  <span class="hljs-comment">// 放对话的用户信息</span><br><br>                conversations.add(map);<br>            &#125;<br>        &#125;<br>        model.addAttribute(<span class="hljs-string">&quot;conversations&quot;</span>, conversations);<br><br>        <span class="hljs-comment">// 查询所有的未读消息数量</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">letterUnreadCount</span> <span class="hljs-operator">=</span> messageService.findLetterUnreadCount(user.getId(), <span class="hljs-literal">null</span>);<br>        model.addAttribute(<span class="hljs-string">&quot;letterUnreadCount&quot;</span>, letterUnreadCount);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/letter&quot;</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>私信详情</p>
<p>（4）前端测试</p>
<p>替换index.html、letter.html、</p>
<p>测试账号：aaa ，密码：aaa</p>
<p>查看私信列表和详情</p>
<h2 id="8-发送私信"><a href="#8-发送私信" class="headerlink" title="8. 发送私信"></a>8. 发送私信</h2><p>（1）数据访问层，MessageMapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 新增消息</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">insertMessage</span><span class="hljs-params">(Message message)</span>;<br><br><span class="hljs-comment">// 修改消息的状态</span><br><span class="hljs-type">int</span> <span class="hljs-title function_">updateStatus</span><span class="hljs-params">(List&lt;Integer&gt; ids, <span class="hljs-type">int</span> status)</span>;<br></code></pre></td></tr></table></figure>

<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><code class="hljs xml"><span class="hljs-tag">&lt;<span class="hljs-name">insert</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;insertMessage&quot;</span> <span class="hljs-attr">parameterType</span>=<span class="hljs-string">&quot;Message&quot;</span> <span class="hljs-attr">keyProperty</span>=<span class="hljs-string">&quot;id&quot;</span>&gt;</span><br>    insert into message(<span class="hljs-tag">&lt;<span class="hljs-name">include</span> <span class="hljs-attr">refid</span>=<span class="hljs-string">&quot;insertFields&quot;</span>&gt;</span><span class="hljs-tag">&lt;/<span class="hljs-name">include</span>&gt;</span>)<br>    values(#&#123;fromId&#125;,#&#123;toId&#125;,#&#123;conversationId&#125;,#&#123;content&#125;,#&#123;status&#125;,#&#123;createTime&#125;)<br><span class="hljs-tag">&lt;/<span class="hljs-name">insert</span>&gt;</span><br><br><span class="hljs-tag">&lt;<span class="hljs-name">update</span> <span class="hljs-attr">id</span>=<span class="hljs-string">&quot;updateStatus&quot;</span>&gt;</span><br>    update message set status = #&#123;status&#125;<br>    where id in<br>    <span class="hljs-tag">&lt;<span class="hljs-name">foreach</span> <span class="hljs-attr">collection</span>=<span class="hljs-string">&quot;ids&quot;</span> <span class="hljs-attr">item</span>=<span class="hljs-string">&quot;id&quot;</span> <span class="hljs-attr">open</span>=<span class="hljs-string">&quot;(&quot;</span> <span class="hljs-attr">separator</span>=<span class="hljs-string">&quot;,&quot;</span> <span class="hljs-attr">close</span>=<span class="hljs-string">&quot;)&quot;</span>&gt;</span><br>        #&#123;id&#125;<br>    <span class="hljs-tag">&lt;/<span class="hljs-name">foreach</span>&gt;</span><br><span class="hljs-tag">&lt;/<span class="hljs-name">update</span>&gt;</span><br></code></pre></td></tr></table></figure>



<p>（2）业务层，MessageService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 添加私信，敏感词过滤</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">addMessage</span><span class="hljs-params">(Message message)</span> &#123;<br>    message.setContent(HtmlUtils.htmlEscape(message.getContent()));<br>    message.setContent(sensitiveFilter.filter(message.getContent()));<br>    <span class="hljs-keyword">return</span> messageMapper.insertMessage(message);<br>&#125;<br><br><span class="hljs-comment">// 把消息变为已读</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">readMessage</span><span class="hljs-params">(List&lt;Integer&gt; ids)</span> &#123;<br>    <span class="hljs-keyword">return</span> messageMapper.updateStatus(ids, <span class="hljs-number">1</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<p>（3）表现层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 发送私信</span><br><span class="hljs-meta">@RequestMapping(path = &quot;/letter/send&quot;, method = RequestMethod.POST)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">sendLetter</span><span class="hljs-params">(String toName, String content)</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> userService.findUserByName(toName);<br>    <span class="hljs-keyword">if</span> (target == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;目标用户不存在!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>();<br>    message.setFromId(hostHolder.getUser().getId());<br>    message.setToId(target.getId());<br>    <span class="hljs-keyword">if</span> (message.getFromId() &lt; message.getToId()) &#123;<br>        message.setConversationId(message.getFromId() + <span class="hljs-string">&quot;_&quot;</span> + message.getToId());<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        message.setConversationId(message.getToId() + <span class="hljs-string">&quot;_&quot;</span> + message.getFromId());<br>    &#125;<br>    message.setContent(content);<br>    message.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>    messageService.addMessage(message);<br><br>    <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">0</span>);<br>&#125;<br><br><span class="hljs-comment">// 获得未读的消息id</span><br><span class="hljs-keyword">private</span> List&lt;Integer&gt; <span class="hljs-title function_">getLetterIds</span><span class="hljs-params">(List&lt;Message&gt; letterList)</span> &#123;<br>    List&lt;Integer&gt; ids = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br><br>    <span class="hljs-keyword">if</span> (letterList != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">for</span> (Message message : letterList) &#123;<br>            <span class="hljs-keyword">if</span> (hostHolder.getUser().getId() == message.getToId() &amp;&amp; message.getStatus() == <span class="hljs-number">0</span>) &#123; <span class="hljs-comment">// 判断时接收者的身份，并且消息是未读的</span><br>                ids.add(message.getId());<br>            &#125;<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> ids;<br>&#125;<br><br><span class="hljs-comment">// 更新getLetterDetail，设置已读</span><br><span class="hljs-comment">// 私信详情</span><br><span class="hljs-meta">@RequestMapping(path = &quot;/letter/detail/&#123;conversationId&#125;&quot;, method = RequestMethod.GET)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getLetterDetail</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;conversationId&quot;)</span> String conversationId, Page page, Model model)</span> &#123;<br>	<span class="hljs-comment">// ...</span><br>    <br>    <span class="hljs-comment">// 设置已读</span><br>    List&lt;Integer&gt; ids = getLetterIds(letterList);<br>    <span class="hljs-keyword">if</span> (!ids.isEmpty()) &#123;<span class="hljs-comment">// 如果未读消息id列表是空的，就没必要判断</span><br>        messageService.readMessage(ids);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<p>（4）前端和测试</p>
<p>更新letter-detail.html、letter.html、letter.js</p>
<p>测试：用账号aaa（密码aaa）给wanyu（密码123）发送两条消息，再登录wanyu，检测消息是否发送成功，以及未读已读状态</p>
<h2 id="9-统一处理异常"><a href="#9-统一处理异常" class="headerlink" title="9. 统一处理异常"></a>9. 统一处理异常</h2><p>按照三层架构的开发逻辑，所有的异常都会抛到表现层，所以在表现层进行统一处理异常即可</p>
<p>（1）Springboot</p>
<p>SpringBoot处理异常的页面很简单，只要按照目录：Resources-templates-error放置对应错误码的页面即可</p>
<p>更新404.html  500.html，在messageController随便造个语法错误</p>
<p>测试：</p>
<ol>
<li>随便访问一个不存在的路径，会显示如下页面</li>
</ol>
<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch3-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86-%E6%B5%8B%E8%AF%95.png" srcset="/img/loading.gif" lazyload alt="image-20220520182713800"></p>
<ol start="2">
<li>访问私信列表，随便访问一个不存在的路径（前提是在messageController造个语法错误）</li>
</ol>
<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch3-%E5%BC%82%E5%B8%B8%E5%A4%84%E7%90%86-%E6%B5%8B%E8%AF%951.png" srcset="/img/loading.gif" lazyload alt="image-20220520182825124"></p>
<p>（2）Spring</p>
<p>前面介绍的处理异常方式处理的过于简单，我们在服务器发生异常时，希望记录异常日志。Spring里也提供了更丰富的统一异常处理机制，就是使用注解 @ControllerAdvice，它用于修饰类，表示该类是Controller的全局配置类。在此类中，可以对Controller进行如下三种全局配置：异常处理方案、绑定数据方案、绑定参数方案。</p>
<ul>
<li><p>@ExceptionHandler</p>
<p>  用于修饰方法，该方法会在Controller出现异常后被调用，用于处理捕获到的异常。</p>
</li>
<li><p>@ModelAttribute</p>
<p>  用于修饰方法，该方法会在Controller方法执行前被调用，用于为Model对象绑定参数。 </p>
</li>
<li><p>@DataBinder</p>
<p>  用于修饰方法，该方法会在Controller方法执行前被调用，用于绑定参数的转换器。</p>
</li>
</ul>
<p>此处主要用到第1个</p>
<p>首先在HomeController里配置error的访问请求，方便其他方法进行重定向</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping(path = &quot;/error&quot;, method = RequestMethod.GET)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getErrorPage</span><span class="hljs-params">()</span> &#123;<br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/error/500&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后在controller里新建advice-ExceptionAdvice</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@ControllerAdvice(annotations = Controller.class)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ExceptionAdvice</span> &#123;<br>    <span class="hljs-meta">@ExceptionHandler(&#123;Exception.class&#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleException</span><span class="hljs-params">(Exception e, HttpServletRequest request, HttpServletResponse response)</span> <span class="hljs-keyword">throws</span> IOException &#123;<br>        log.error(<span class="hljs-string">&quot;服务器发生异常: &quot;</span> + e.getMessage());<br>        <span class="hljs-keyword">for</span> (StackTraceElement element : e.getStackTrace()) &#123;<br>            log.error(element.toString());<br>        &#125;<br><br>        <span class="hljs-type">String</span> <span class="hljs-variable">xRequestedWith</span> <span class="hljs-operator">=</span> request.getHeader(<span class="hljs-string">&quot;x-requested-with&quot;</span>);<br>        <span class="hljs-comment">// 异步请求</span><br>        <span class="hljs-keyword">if</span> (<span class="hljs-string">&quot;XMLHttpRequest&quot;</span>.equals(xRequestedWith)) &#123;<br>            response.setContentType(<span class="hljs-string">&quot;application/plain;charset=utf-8&quot;</span>);<br>            <span class="hljs-type">PrintWriter</span> <span class="hljs-variable">writer</span> <span class="hljs-operator">=</span> response.getWriter();<br>            writer.write(CommunityUtil.getJSONString(<span class="hljs-number">1</span>, <span class="hljs-string">&quot;服务器异常!&quot;</span>));<br>        &#125; <span class="hljs-keyword">else</span> &#123; <span class="hljs-comment">// 同步请求</span><br>            response.sendRedirect(request.getContextPath() + <span class="hljs-string">&quot;/error&quot;</span>);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>后面可以进行测试，随便模拟几个错误，看看后台日志打印情况即可</p>
<h2 id="10-统一记录日志"><a href="#10-统一记录日志" class="headerlink" title="10. 统一记录日志"></a>10. 统一记录日志</h2><p>这部分需要Spring的AOP前置知识，建议学习后再来对这部分进行开发</p>
<p>记录日志属于整个系统的需求，如果我需要给每个业务记录日志，总不能在每个业务代码里编写记录日志的代码。这样就将业务代码和系统需求耦合在了一起，所以这里就需要用到AOP的思想。</p>
<p>使用AOP可以对每个业务模块例如：帖子、评论、消息模块，都进行统一的系统需求，比如：权限检查、记录日志、事务管理。</p>
<p>新建aspect包，编写记录日志代码，ServiceLogAspect</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-meta">@Aspect</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">ServiceLogAspect</span> &#123;<br><br>    <span class="hljs-meta">@Pointcut(&quot;execution(* com.nowcoder.community.service.*.*(..))&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">pointcut</span><span class="hljs-params">()</span> &#123;<br>    &#125;<br><br>    <span class="hljs-meta">@Before(&quot;pointcut()&quot;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">before</span><span class="hljs-params">(JoinPoint joinPoint)</span> &#123;<br>        <span class="hljs-comment">// 用户[1.2.3.4],在[xxx],访问了[com.nowcoder.community.service.xxx()].</span><br><br>        <span class="hljs-comment">// 获取用户ip</span><br>        <span class="hljs-type">ServletRequestAttributes</span> <span class="hljs-variable">attributes</span> <span class="hljs-operator">=</span> (ServletRequestAttributes) RequestContextHolder.getRequestAttributes();<br>        <span class="hljs-type">HttpServletRequest</span> <span class="hljs-variable">request</span> <span class="hljs-operator">=</span> attributes.getRequest();<br>        <span class="hljs-type">String</span> <span class="hljs-variable">ip</span> <span class="hljs-operator">=</span> request.getRemoteHost();<br>        <span class="hljs-comment">// 获取时间</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">now</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">SimpleDateFormat</span>(<span class="hljs-string">&quot;yyyy-MM-dd HH:mm:ss&quot;</span>).format(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        <span class="hljs-comment">// 获取访问的方法</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> joinPoint.getSignature().getDeclaringTypeName() + <span class="hljs-string">&quot;.&quot;</span> + joinPoint.getSignature().getName();<br>        log.info(String.format(<span class="hljs-string">&quot;用户[%s],在[%s],访问了[%s].&quot;</span>, ip, now, target));<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>





<h1 id="四、Redis，一站式高性能存储方案"><a href="#四、Redis，一站式高性能存储方案" class="headerlink" title="四、Redis，一站式高性能存储方案"></a>四、Redis，一站式高性能存储方案</h1><p>Redis是一款基于键值对的NoSQL数据库，它的值支持多种数据结构。Redis将所有的数据都存放在内存中，所以它的读写性能十分惊人。同时，Redis还可以将内存中的数据以快照或日志的形式保存到硬盘上，以保证数据的安全性。Redis典型的应用场景包括：缓存、排行榜、计数器、社交网络、消息队列等。</p>
<p>本项目使用Redis，按照如下步骤：</p>
<ul>
<li><p>引入依赖：spring-boot-starter-data-redis</p>
</li>
<li><p>配置Redis</p>
<ul>
<li><p>配置数据库参数</p>
</li>
<li><p>编写配置类，构造RedisTemplate（本项目未使用Spring默认提供的 StringRedisTemplate）</p>
  <figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Configuration</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisConfig</span> &#123;<br>    <span class="hljs-meta">@Bean</span><br>    <span class="hljs-keyword">public</span> RedisTemplate&lt;String, Object&gt; <span class="hljs-title function_">redisTemplate</span><span class="hljs-params">(RedisConnectionFactory factory)</span> &#123;<br>        RedisTemplate&lt;String, Object&gt; template = <span class="hljs-keyword">new</span> <span class="hljs-title class_">RedisTemplate</span>&lt;&gt;();<br>        template.setConnectionFactory(factory);<br>        <span class="hljs-comment">// 设置key的序列化方式</span><br>        template.setKeySerializer(RedisSerializer.string());<br>        <span class="hljs-comment">// 设置value的序列化方式</span><br>        template.setValueSerializer(RedisSerializer.json());<br>        <span class="hljs-comment">// 设置hash的key的序列化方式</span><br>        template.setHashKeySerializer(RedisSerializer.string());<br>        <span class="hljs-comment">// 设置hash的value的序列化方式</span><br>        template.setHashValueSerializer(RedisSerializer.json());<br>        template.afterPropertiesSet();<br>        <span class="hljs-keyword">return</span> template;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure></li>
</ul>
</li>
</ul>
<h2 id="1-点赞功能"><a href="#1-点赞功能" class="headerlink" title="1. 点赞功能"></a>1. 点赞功能</h2><p>功能要求：</p>
<ul>
<li>点赞<ul>
<li>支持对帖子、评论点赞。</li>
<li>第1次点赞，第2次取消点赞。</li>
</ul>
</li>
<li>首页点赞数量<ul>
<li>统计帖子的点赞数量。</li>
</ul>
</li>
<li>详情页点赞数量<ul>
<li>统计点赞数量。</li>
<li>显示点赞状态。</li>
</ul>
</li>
</ul>
<p>Redis由于操作数据访问层比较简单，不用额外编写类文件，直接编写业务层代码即可，由于我们主要对 key 进行操作，先写一个生成 key 的工具类，方便复用</p>
<p>注意这里用<strong>集合</strong>去存谁点了赞，而不是简单的计数，</p>
<p>并且后面需求如果变化看谁点了赞就没办法了</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">RedisKeyUtil</span> &#123;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">SPLIT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;:&quot;</span>;<br>    <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PREFIX_ENTITY_LIKE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;like:entity&quot;</span>;<br>    <span class="hljs-comment">// 某个实体的赞</span><br>    <span class="hljs-comment">// like:entity:entityType:entityId -&gt; set(userId)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getEntityLikeKey</span><span class="hljs-params">(<span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId)</span> &#123;<br>        <span class="hljs-keyword">return</span> PREFIX_ENTITY_LIKE + SPLIT + entityType + SPLIT + entityId;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>业务层</strong></p>
<p>业务层代码，逻辑都比较简单，看注释即可</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LikeService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-comment">// 点赞</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">like</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">entityLikeKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getEntityLikeKey(entityType, entityId);<br>        <span class="hljs-comment">// 判断是否是集合的成员，用于判断是第几次点赞</span><br>        <span class="hljs-type">boolean</span> <span class="hljs-variable">isMember</span> <span class="hljs-operator">=</span> redisTemplate.opsForSet().isMember(entityLikeKey, userId);<br>        <span class="hljs-keyword">if</span> (isMember) &#123;<br>            redisTemplate.opsForSet().remove(entityLikeKey, userId);<br>        &#125; <span class="hljs-keyword">else</span> &#123;<br>            redisTemplate.opsForSet().add(entityLikeKey, userId);<br>        &#125;<br>    &#125;<br><br>    <span class="hljs-comment">// 查询某实体点赞的数量</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">findEntityLikeCount</span><span class="hljs-params">(<span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">entityLikeKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getEntityLikeKey(entityType, entityId);<br>        <span class="hljs-keyword">return</span> redisTemplate.opsForSet().size(entityLikeKey);<br>    &#125;<br><br>    <span class="hljs-comment">// 查询某人对某实体的点赞状态</span><br>    <span class="hljs-comment">// 这里返回boolean也行，但扩展性较低，比如后续功能升级想点踩，可以让状态值为-1</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findEntityLikeStatus</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">entityLikeKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getEntityLikeKey(entityType, entityId);<br>        <span class="hljs-keyword">return</span> redisTemplate.opsForSet().isMember(entityLikeKey, userId) ? <span class="hljs-number">1</span> : <span class="hljs-number">0</span>;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>表现层</strong></p>
<p>表现层代码，异步请求，不要刷新整个页面，返回JSON字符串即可，加上注解@ResponseBody</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LikeController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> LikeService likeService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HostHolder hostHolder;<br><br>    <span class="hljs-meta">@RequestMapping(path = &quot;/like&quot;, method = RequestMethod.POST)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-comment">// 点赞显然是异步请求，不要刷新整个页面</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">like</span><span class="hljs-params">(<span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> hostHolder.getUser();<br><br>        <span class="hljs-comment">// 点赞</span><br>        likeService.like(user.getId(), entityType, entityId);<br>        <span class="hljs-comment">// 数量</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">likeCount</span> <span class="hljs-operator">=</span> likeService.findEntityLikeCount(entityType, entityId);<br>        <span class="hljs-comment">// 状态</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">likeStatus</span> <span class="hljs-operator">=</span> likeService.findEntityLikeStatus(user.getId(), entityType, entityId);<br><br>        <span class="hljs-comment">// 返回的结果</span><br>        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;likeCount&quot;</span>, likeCount);<br>        map.put(<span class="hljs-string">&quot;likeStatus&quot;</span>, likeStatus);<br><br>        <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">0</span>, <span class="hljs-literal">null</span>, map);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>在首页需要展示每条帖子赞的数量，更新表现层代码，HomeController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping(path = &quot;/index&quot;, method = RequestMethod.GET)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getIndexPage</span><span class="hljs-params">(Model model, Page page)</span> &#123;<br>    ...<br>    <br>    <span class="hljs-comment">// 首页需要展示每条帖子赞的数量，帖子的entity类别是1，ENTITY_TYPE_POST</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">likeCount</span> <span class="hljs-operator">=</span> likeService.findEntityLikeCount(ENTITY_TYPE_POST, post.getId());<br>    map.put(<span class="hljs-string">&quot;likeCount&quot;</span>, likeCount);    <br>        <br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>同理更新帖子详情页里的赞和评论的赞，DiscussPostController</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java">   <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getDiscussPost</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;discussPostId&quot;)</span> <span class="hljs-type">int</span> discussPostId, Model model, Page page)</span> &#123;<br>   	...<br>       <span class="hljs-comment">// 点赞数量</span><br>       <span class="hljs-type">long</span> <span class="hljs-variable">likeCount</span> <span class="hljs-operator">=</span> likeService.findEntityLikeCount(ENTITY_TYPE_POST, discussPostId);<br>       model.addAttribute(<span class="hljs-string">&quot;likeCount&quot;</span>, likeCount);<br>       <span class="hljs-comment">// 点赞状态，查询状态前先确认获取了用户</span><br>       <span class="hljs-type">int</span> <span class="hljs-variable">likeStatus</span> <span class="hljs-operator">=</span> hostHolder.getUser() == <span class="hljs-literal">null</span> ? <span class="hljs-number">0</span> :<br>               likeService.findEntityLikeStatus(hostHolder.getUser().getId(), ENTITY_TYPE_POST, discussPostId);<br>       model.addAttribute(<span class="hljs-string">&quot;likeStatus&quot;</span>, likeStatus);<br>   	...<br>   &#125;<br><br>下类似<br><br></code></pre></td></tr></table></figure>

<p>更新前端文件，登录不同测试账号测试点赞同一个帖子，主要观察redis数据库里的信息</p>
<h2 id="2-统计收到赞个数"><a href="#2-统计收到赞个数" class="headerlink" title="2. 统计收到赞个数"></a>2. 统计收到赞个数</h2><p>社区的个人信息里会统计每个用户关注了多少人，被多少人关注，以及获得了多少个赞。本小节先完成最后一个功能。</p>
<p>统计每个用户收到的赞可以先统计用户发布了多少帖子、评论、恢复，但这样太麻烦，我们可以在点赞时额外以用户为key，再记录一下点赞数量，然后调用自增和自减来更改数量，这样更方便</p>
<p>因此本小节的内容为：</p>
<ul>
<li>重构点赞功能<ul>
<li>以用户为key，记录点赞数量</li>
<li>increment(key)，decrement(key)</li>
</ul>
</li>
<li>开发个人主页<ul>
<li>以用户为key，查询点赞数量</li>
</ul>
</li>
</ul>
<p>首先添加生成用户key的方法，更新 RedisKeyUtil</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java">   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PREFIX_USER_LIKE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;like:user&quot;</span>;<br><span class="hljs-comment">// 某个用户的赞</span><br>   <span class="hljs-comment">// like:user:userId -&gt; int</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getUserLikeKey</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> &#123;<br>       <span class="hljs-keyword">return</span> PREFIX_USER_LIKE + SPLIT + userId;<br>   &#125;<br></code></pre></td></tr></table></figure>



<p><strong>业务层</strong></p>
<p>随后需要重构点赞业务代码，之前是只对某实体（帖子、评论、回复）点赞，现在加上该实体作者被点赞的数量，属于一次业务中执行两次更新的操作，需要用到Redis的编程事务管理 redisTemplate.execute(new SessionCallback(){ })。<strong>格外注意Redis的事务处理比较特殊，它不支持在事务内进行查询，Redis在执行事务过程中所提交的命令不是立刻执行，而是先提交到队列里，提交事务后统一执行。所以我们想要查询当前用户是否对这个实体点过赞，需要放在事务过程外查询</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 点赞</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">like</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId, <span class="hljs-type">int</span> entityUserId)</span> &#123;<br>    redisTemplate.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SessionCallback</span>() &#123;<br>        <span class="hljs-meta">@Override</span><br>        <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">execute</span><span class="hljs-params">(RedisOperations operations)</span> <span class="hljs-keyword">throws</span> DataAccessException &#123;<br>            <span class="hljs-type">String</span> <span class="hljs-variable">entityLikeKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getEntityLikeKey(entityType, entityId);<br>            <span class="hljs-type">String</span> <span class="hljs-variable">userLikeKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getUserLikeKey(entityUserId);<br><br>            <span class="hljs-comment">// Redis事务内查询不到结果，所以放在事务过程外查询</span><br>            <span class="hljs-comment">// 查询当前用户是否对这个实体点过赞</span><br>            <span class="hljs-type">boolean</span> <span class="hljs-variable">isMember</span> <span class="hljs-operator">=</span> operations.opsForSet().isMember(entityLikeKey, userId);<br><br>            <span class="hljs-comment">// 开启事务</span><br>            operations.multi();<br><br>            <span class="hljs-comment">// 两次更新操作</span><br>            <span class="hljs-keyword">if</span> (isMember) &#123;<br>                operations.opsForSet().remove(entityLikeKey, userId);<br>                operations.opsForValue().decrement(userLikeKey);<br>            &#125; <span class="hljs-keyword">else</span> &#123;<br>                operations.opsForSet().add(entityLikeKey, userId); <br>                <span class="hljs-comment">// 这里是往点赞集合里添加用户，谁对当前实体点赞，就把谁加进集合</span><br>                operations.opsForValue().increment(userLikeKey);   <br>                <span class="hljs-comment">// 这里是统计实体作者被点赞的次数，只是一个Stirng类型</span><br>            &#125;<br><br>            <span class="hljs-comment">// 提交事务</span><br>            <span class="hljs-keyword">return</span> operations.exec();<br>        &#125;<br>    &#125;);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>并且也注意到，之前的方法参数只有三个，分别是：int userId, int entityType, int entityId，根据这三个参数怎么去去获取实体的作者呢，这里的 userId 并不是作者，而是点赞的那个人。我们也不能凭借 entityId 去数据库里取，这样用 Redis 就没意义了，所以让该方法<strong>多传入一个参数，把实体的作者id也传进来</strong>，这个是很方便的，因为我们是在一个实体上点赞，传进来实体作者id很容易</p>
<p><strong>表现层</strong></p>
<p>LikeController里同步更新表现层方法，只用多传入一个 entityUserId</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping(path = &quot;/like&quot;, method = RequestMethod.POST)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">like</span><span class="hljs-params">(<span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId, <span class="hljs-type">int</span> entityUserId)</span> &#123;<br>    <br>&#125;<br></code></pre></td></tr></table></figure>

<p>随后需要开发在个人主页里显示被多少人赞过，如下图：</p>
<p><img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch4-%E6%88%91%E6%94%B6%E5%88%B0%E7%9A%84%E8%B5%9E-%E5%8A%9F%E8%83%BD%E6%BC%94%E7%A4%BA.png" srcset="/img/loading.gif" lazyload alt="image-20220618005206574"></p>
<p>可以直接在 UserController里建一个新方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 个人主页</span><br><span class="hljs-meta">@RequestMapping(path = &quot;/profile/&#123;userId&#125;&quot;, method = RequestMethod.GET)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getProfilePage</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;userId&quot;)</span> <span class="hljs-type">int</span> userId, Model model)</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findUserById(userId);<br>    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;该用户不存在!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 用户</span><br>    model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>, user);<br>    <span class="hljs-comment">// 点赞数量</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">likeCount</span> <span class="hljs-operator">=</span> likeService.findUserLikeCount(userId);<br>    model.addAttribute(<span class="hljs-string">&quot;likeCount&quot;</span>, likeCount);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/profile&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>根据视频更新前端代码，进行测试。对一个人点赞多次后，点他的头像进去，看他个人主页统计的赞的个数。再取消点赞，查看统计个数。同步观察Redis</p>
<h2 id="3-关注、取消关注"><a href="#3-关注、取消关注" class="headerlink" title="3. 关注、取消关注"></a>3. 关注、取消关注</h2><p>需求</p>
<ul>
<li>开发关注、取消关注功能。</li>
<li>统计用户的关注数、粉丝数。</li>
</ul>
<p>这个需求实现的关键在于区分谁是粉丝，谁是目标。<strong>若A关注了B，则A是B的Follower（粉丝），B是A的Followee（目标）。</strong>关注的目标可以是用户、帖子、题目等，在实现时将这些目标抽象为实体。</p>
<p>这里定义 key 的方式非常重要，建议多理清楚几次。这里的value 都使用 SortedSet，把时间传进去作为 score，方便后面有排序的需求</p>
<ul>
<li><p>某个用户关注哪些实体目标：<code>followee:userId:entityType -&gt; zset(entityId,now)</code></p>
<p>  假设用户151关注了用户146、用户133、帖子131，假设用户entityType为1，帖子entityType为2，则语句为</p>
<p>  <code>followee:151:1 -&gt; zset(146,now, 133,now)</code>，<code>followee:151:2 -&gt; zset(131,now)</code></p>
</li>
<li><p>某个实体拥有的粉丝：<code>follower:entityType:entityId -&gt; zset(userId,now)</code></p>
<p>  用户146被用户151、用户150关注着，它拥有150、151这两个粉丝，语句为：</p>
<p>  <code>follower:1:146 -&gt; zset(150,now, 151,now)</code></p>
</li>
</ul>
<p>RedisKeyUtil.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PREFIX_FOLLOWEE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;followee&quot;</span>;<br><span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PREFIX_FOLLOWER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;follower&quot;</span>;<br><br><span class="hljs-comment">// 某个用户关注的实体</span><br><span class="hljs-comment">// followee:userId:entityType -&gt; zset(entityId,now)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getFolloweeKey</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> entityType)</span> &#123;<br>    <span class="hljs-keyword">return</span> PREFIX_FOLLOWEE + SPLIT + userId + SPLIT + entityType;<br>&#125;<br><br><span class="hljs-comment">// 某个实体拥有的粉丝</span><br><span class="hljs-comment">// follower:entityType:entityId -&gt; zset(userId,now)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getFollowerKey</span><span class="hljs-params">(<span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId)</span> &#123;<br>    <span class="hljs-keyword">return</span> PREFIX_FOLLOWER + SPLIT + entityType + SPLIT + entityId;<br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>业务层</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Service</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FollowService</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> RedisTemplate redisTemplate;<br><br>    <span class="hljs-comment">// 关注，有两次更新操作，事务</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">follow</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId)</span> &#123;<br>        redisTemplate.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SessionCallback</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">execute</span><span class="hljs-params">(RedisOperations operations)</span> <span class="hljs-keyword">throws</span> DataAccessException &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">followeeKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getFolloweeKey(userId, entityType);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">followerKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getFollowerKey(entityType, entityId);<br><br>                <span class="hljs-comment">// 启动事务</span><br>                operations.multi();<br><br>                operations.opsForZSet().add(followeeKey, entityId, System.currentTimeMillis());<br>                operations.opsForZSet().add(followerKey, userId, System.currentTimeMillis());<br><br>                <span class="hljs-comment">// 提交事务</span><br>                <span class="hljs-keyword">return</span> operations.exec();<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-comment">// 取消关注，有两次更新操作，事务</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">unfollow</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId)</span> &#123;<br>        redisTemplate.execute(<span class="hljs-keyword">new</span> <span class="hljs-title class_">SessionCallback</span>() &#123;<br>            <span class="hljs-meta">@Override</span><br>            <span class="hljs-keyword">public</span> Object <span class="hljs-title function_">execute</span><span class="hljs-params">(RedisOperations operations)</span> <span class="hljs-keyword">throws</span> DataAccessException &#123;<br>                <span class="hljs-type">String</span> <span class="hljs-variable">followeeKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getFolloweeKey(userId, entityType);<br>                <span class="hljs-type">String</span> <span class="hljs-variable">followerKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getFollowerKey(entityType, entityId);<br><br>                <span class="hljs-comment">// 启动事务</span><br>                operations.multi();<br><br>                operations.opsForZSet().remove(followeeKey, entityId);<br>                operations.opsForZSet().remove(followerKey, userId);<br><br>                <span class="hljs-comment">// 提交事务</span><br>                <span class="hljs-keyword">return</span> operations.exec();<br>            &#125;<br>        &#125;);<br>    &#125;<br><br>    <span class="hljs-comment">// 查询关注的实体的数量</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">findFolloweeCount</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> entityType)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">followeeKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getFolloweeKey(userId, entityType);<br>        <span class="hljs-keyword">return</span> redisTemplate.opsForZSet().zCard(followeeKey);<br>    &#125;<br><br>    <span class="hljs-comment">// 查询实体的粉丝的数量</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">long</span> <span class="hljs-title function_">findFollowerCount</span><span class="hljs-params">(<span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">followerKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getFollowerKey(entityType, entityId);<br>        <span class="hljs-keyword">return</span> redisTemplate.opsForZSet().zCard(followerKey);<br>    &#125;<br><br>    <span class="hljs-comment">// 查询当前用户是否已关注该实体</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasFollowed</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId)</span> &#123;<br>        <span class="hljs-type">String</span> <span class="hljs-variable">followeeKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getFolloweeKey(userId, entityType);<br>        <span class="hljs-keyword">return</span> redisTemplate.opsForZSet().score(followeeKey, entityId) != <span class="hljs-literal">null</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>



<p><strong>表现层</strong></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">FollowController</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> FollowService followService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HostHolder hostHolder;<br><br>    <span class="hljs-comment">// 关注，异步请求</span><br>    <span class="hljs-meta">@RequestMapping(path = &quot;/follow&quot;, method = RequestMethod.POST)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">follow</span><span class="hljs-params">(<span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> hostHolder.getUser();<br><br>        followService.follow(user.getId(), entityType, entityId);<br><br>        <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;已关注!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 取消关注，异步请求</span><br>    <span class="hljs-meta">@RequestMapping(path = &quot;/unfollow&quot;, method = RequestMethod.POST)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">unfollow</span><span class="hljs-params">(<span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> hostHolder.getUser();<br><br>        followService.unfollow(user.getId(), entityType, entityId);<br><br>        <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;已取消关注!&quot;</span>);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>更新 UserController，让个人主页显示关注数和粉丝数</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 个人主页</span><br><span class="hljs-meta">@RequestMapping(path = &quot;/profile/&#123;userId&#125;&quot;, method = RequestMethod.GET)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getProfilePage</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;userId&quot;)</span> <span class="hljs-type">int</span> userId, Model model)</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findUserById(userId);<br>    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;该用户不存在!&quot;</span>);<br>    &#125;<br><br>    <span class="hljs-comment">// 用户</span><br>    model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>, user);<br>    <span class="hljs-comment">// 点赞数量</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">likeCount</span> <span class="hljs-operator">=</span> likeService.findUserLikeCount(userId);<br>    model.addAttribute(<span class="hljs-string">&quot;likeCount&quot;</span>, likeCount);<br><br>    <span class="hljs-comment">// 关注数量</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">followeeCount</span> <span class="hljs-operator">=</span> followService.findFolloweeCount(userId, ENTITY_TYPE_USER);<br>    model.addAttribute(<span class="hljs-string">&quot;followeeCount&quot;</span>, followeeCount);<br>    <span class="hljs-comment">// 粉丝数量</span><br>    <span class="hljs-type">long</span> <span class="hljs-variable">followerCount</span> <span class="hljs-operator">=</span> followService.findFollowerCount(ENTITY_TYPE_USER, userId);<br>    model.addAttribute(<span class="hljs-string">&quot;followerCount&quot;</span>, followerCount);<br>    <span class="hljs-comment">// 是否已关注</span><br>    <span class="hljs-type">boolean</span> <span class="hljs-variable">hasFollowed</span> <span class="hljs-operator">=</span> <span class="hljs-literal">false</span>;<br>    <span class="hljs-keyword">if</span> (hostHolder.getUser() != <span class="hljs-literal">null</span>) &#123;<br>        hasFollowed = followService.hasFollowed(hostHolder.getUser().getId(), ENTITY_TYPE_USER, userId);<br>    &#125;<br>    model.addAttribute(<span class="hljs-string">&quot;hasFollowed&quot;</span>, hasFollowed);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/profile&quot;</span>;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>更新前端文件，完成测试</p>
<h2 id="4-关注列表、粉丝列表"><a href="#4-关注列表、粉丝列表" class="headerlink" title="4. 关注列表、粉丝列表"></a>4. 关注列表、粉丝列表</h2><p>业务层</p>
<ul>
<li>查询某个用户关注的人，支持分页。</li>
<li>查询某个用户的粉丝，支持分页。</li>
</ul>
<p> 表现层</p>
<ul>
<li>处理“查询关注的人”、“查询粉丝”请求。</li>
<li>编写“查询关注的人”、“查询粉丝”模板。</li>
</ul>
<p>业务层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 查询某用户关注的人</span><br><span class="hljs-comment">// 这里就直接写死是查询关注的人了，实际功能里可能还有关注的帖子啊之类的，逻辑类似，加if判断就行</span><br><span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">findFollowees</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> offset, <span class="hljs-type">int</span> limit)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">followeeKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getFolloweeKey(userId, ENTITY_TYPE_USER);<br>    Set&lt;Integer&gt; targetIds = redisTemplate.opsForZSet().reverseRange(followeeKey, offset, offset + limit - <span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">if</span> (targetIds == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    List&lt;Map&lt;String, Object&gt;&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (Integer targetId : targetIds) &#123;<br>        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findUserById(targetId);<br>        map.put(<span class="hljs-string">&quot;user&quot;</span>, user);<br>        <span class="hljs-type">Double</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> redisTemplate.opsForZSet().score(followeeKey, targetId);<br>        map.put(<span class="hljs-string">&quot;followTime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(score.longValue()));<br>        list.add(map);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> list;<br>&#125;<br><br><span class="hljs-comment">// 查询某用户的粉丝</span><br><span class="hljs-keyword">public</span> List&lt;Map&lt;String, Object&gt;&gt; <span class="hljs-title function_">findFollowers</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, <span class="hljs-type">int</span> offset, <span class="hljs-type">int</span> limit)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">followerKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getFollowerKey(ENTITY_TYPE_USER, userId);<br>    Set&lt;Integer&gt; targetIds = redisTemplate.opsForZSet().reverseRange(followerKey, offset, offset + limit - <span class="hljs-number">1</span>);<br><br>    <span class="hljs-keyword">if</span> (targetIds == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">null</span>;<br>    &#125;<br><br>    List&lt;Map&lt;String, Object&gt;&gt; list = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>    <span class="hljs-keyword">for</span> (Integer targetId : targetIds) &#123;<br>        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findUserById(targetId);<br>        map.put(<span class="hljs-string">&quot;user&quot;</span>, user);<br>        <span class="hljs-type">Double</span> <span class="hljs-variable">score</span> <span class="hljs-operator">=</span> redisTemplate.opsForZSet().score(followerKey, targetId);<br>        map.put(<span class="hljs-string">&quot;followTime&quot;</span>, <span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(score.longValue()));<br>        list.add(map);<br>    &#125;<br><br>    <span class="hljs-keyword">return</span> list;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>表现层：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping(path = &quot;/followees/&#123;userId&#125;&quot;, method = RequestMethod.GET)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getFollowees</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;userId&quot;)</span> <span class="hljs-type">int</span> userId, Page page, Model model)</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findUserById(userId);<br>    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;该用户不存在!&quot;</span>);<br>    &#125;<br>    model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>, user);<br><br>    page.setLimit(<span class="hljs-number">5</span>);<br>    page.setPath(<span class="hljs-string">&quot;/followees/&quot;</span> + userId);<br>    page.setRows((<span class="hljs-type">int</span>) followService.findFolloweeCount(userId, ENTITY_TYPE_USER));<br><br>    List&lt;Map&lt;String, Object&gt;&gt; userList = followService.findFollowees(userId, page.getOffset(), page.getLimit());<br><br>    <span class="hljs-comment">// 要把关注列表里的每个用户信息取出来，加载他的头像啥的</span><br>    <span class="hljs-keyword">if</span> (userList != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">for</span> (Map&lt;String, Object&gt; map : userList) &#123;<br>            <span class="hljs-type">User</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> (User) map.get(<span class="hljs-string">&quot;user&quot;</span>);<br>            <span class="hljs-comment">// 判断当前用户是否关注了这个用户</span><br>            map.put(<span class="hljs-string">&quot;hasFollowed&quot;</span>, hasFollowed(u.getId()));<br>        &#125;<br>    &#125;<br>    model.addAttribute(<span class="hljs-string">&quot;users&quot;</span>, userList);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/followee&quot;</span>;<br>&#125;<br><br><span class="hljs-meta">@RequestMapping(path = &quot;/followers/&#123;userId&#125;&quot;, method = RequestMethod.GET)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">getFollowers</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;userId&quot;)</span> <span class="hljs-type">int</span> userId, Page page, Model model)</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userService.findUserById(userId);<br>    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">throw</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">RuntimeException</span>(<span class="hljs-string">&quot;该用户不存在!&quot;</span>);<br>    &#125;<br>    model.addAttribute(<span class="hljs-string">&quot;user&quot;</span>, user);<br><br>    page.setLimit(<span class="hljs-number">5</span>);<br>    page.setPath(<span class="hljs-string">&quot;/followers/&quot;</span> + userId);<br>    page.setRows((<span class="hljs-type">int</span>) followService.findFollowerCount(ENTITY_TYPE_USER, userId));<br><br>    List&lt;Map&lt;String, Object&gt;&gt; userList = followService.findFollowers(userId, page.getOffset(), page.getLimit());<br>    <span class="hljs-keyword">if</span> (userList != <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">for</span> (Map&lt;String, Object&gt; map : userList) &#123;<br>            <span class="hljs-type">User</span> <span class="hljs-variable">u</span> <span class="hljs-operator">=</span> (User) map.get(<span class="hljs-string">&quot;user&quot;</span>);<br>            map.put(<span class="hljs-string">&quot;hasFollowed&quot;</span>, hasFollowed(u.getId()));<br>        &#125;<br>    &#125;<br>    model.addAttribute(<span class="hljs-string">&quot;users&quot;</span>, userList);<br><br>    <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/follower&quot;</span>;<br>&#125;<br><br><span class="hljs-keyword">private</span> <span class="hljs-type">boolean</span> <span class="hljs-title function_">hasFollowed</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> &#123;<br>    <span class="hljs-keyword">if</span> (hostHolder.getUser() == <span class="hljs-literal">null</span>) &#123;<br>        <span class="hljs-keyword">return</span> <span class="hljs-literal">false</span>;<br>    &#125;<br>    <span class="hljs-keyword">return</span> followService.hasFollowed(hostHolder.getUser().getId(), ENTITY_TYPE_USER, userId);<br>&#125;<br></code></pre></td></tr></table></figure>



<p>更新前端代码，测试，查看关注列表和粉丝列表</p>
<h2 id="5-优化登录模块"><a href="#5-优化登录模块" class="headerlink" title="5. 优化登录模块"></a>5. 优化登录模块</h2><p>需求</p>
<ul>
<li>使用Redis存储验证码<ul>
<li>验证码需要频繁的访问与刷新，对性能要求较高。</li>
<li>验证码不需永久保存，通常在很短的时间后就会失效。</li>
<li>分布式部署时，存在Session共享的问题。</li>
</ul>
</li>
<li>使用Redis存储登录凭证<ul>
<li>处理每次请求时，都要查询用户的登录凭证，访问的频率非常高。</li>
</ul>
</li>
<li>使用Redis缓存用户信息<ul>
<li>处理每次请求时，都要根据凭证查询用户信息，访问的频率非常高。</li>
</ul>
</li>
</ul>
<h3 id="5-1-使用Redis存储验证码"><a href="#5-1-使用Redis存储验证码" class="headerlink" title="5.1 使用Redis存储验证码"></a>5.1 使用Redis存储验证码</h3><p>首先要构造 Redis的key，因为要把验证码和当前登录的客户端绑定（注意不是和用户绑定，用户还没登录，没法绑定），之前是session来维护，因为验证码存到了session里，现在验证码存到redis了，我们可以给客户端临时生成一个凭证，然后通过 response 里的 cookie 发给客户端，这样客户端在请求的时候就能凭借此凭证和验证码进行校验。所以这里redis的key里包含了一个 owner。（做另外一个项目的时候，是用手机号登录，所以把手机号作为key去存验证码，那个流程是先输入手机号，再发送请求，服务端返回验证码。本项目是登陆页面一开始就加载了验证码，注意体会网页端和移动端登录时验证码的区别）</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java">   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PREFIX_KAPTCHA</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;kaptcha&quot;</span>;    <br><br><span class="hljs-comment">// 登录验证码</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getKaptchaKey</span><span class="hljs-params">(String owner)</span> &#123;<br>       <span class="hljs-keyword">return</span> PREFIX_KAPTCHA + SPLIT + owner;<br>   &#125;<br></code></pre></td></tr></table></figure>

<p><strong>业务层</strong></p>
<p>业务层没有要更改的代码，因为业务层是生成验证码，本功能的重构不涉及到业务层</p>
<p><strong>表现层</strong></p>
<p>首先是生成验证码，并存到redis，注释掉之前 session 的代码</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@RequestMapping(path = &quot;/kaptcha&quot;, method = RequestMethod.GET)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">getKaptcha</span><span class="hljs-params">(HttpServletResponse response<span class="hljs-comment">/*, HttpSession session*/</span>)</span> &#123;<br>    <span class="hljs-comment">// 生成验证码</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">text</span> <span class="hljs-operator">=</span> kaptchaProducer.createText();<br>    <span class="hljs-type">BufferedImage</span> <span class="hljs-variable">image</span> <span class="hljs-operator">=</span> kaptchaProducer.createImage(text);<br><br>    <span class="hljs-comment">// 将验证码存入session</span><br>    <span class="hljs-comment">// session.setAttribute(&quot;kaptcha&quot;, text);</span><br><br>    <span class="hljs-comment">// 创建验证码的归属</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">kaptchaOwner</span> <span class="hljs-operator">=</span> CommunityUtil.generateUUID();  <span class="hljs-comment">// owner其实就是一串随机字符串</span><br>    <span class="hljs-type">Cookie</span> <span class="hljs-variable">cookie</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Cookie</span>(<span class="hljs-string">&quot;kaptchaOwner&quot;</span>, kaptchaOwner);<br>    cookie.setMaxAge(<span class="hljs-number">60</span>);         <span class="hljs-comment">// 存活时间60s</span><br>    cookie.setPath(contextPath);<br>    response.addCookie(cookie);<br><br>    <span class="hljs-comment">// 将验证码存入Redis</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getKaptchaKey(kaptchaOwner);<br>    redisTemplate.opsForValue().set(redisKey, text, <span class="hljs-number">60</span>, TimeUnit.SECONDS);  <span class="hljs-comment">// 存活时间60s</span><br><br>    <span class="hljs-comment">// 将突图片输出给浏览器</span><br>    response.setContentType(<span class="hljs-string">&quot;image/png&quot;</span>);<br>    <span class="hljs-keyword">try</span> &#123;<br>        <span class="hljs-type">OutputStream</span> <span class="hljs-variable">os</span> <span class="hljs-operator">=</span> response.getOutputStream();<br>        ImageIO.write(image, <span class="hljs-string">&quot;png&quot;</span>, os);<br>    &#125; <span class="hljs-keyword">catch</span> (IOException e) &#123;<br>        logger.error(<span class="hljs-string">&quot;响应验证码失败:&quot;</span> + e.getMessage());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后是登录，要从redis里去验证码，而不是从session里</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@RequestMapping(path = &quot;/login&quot;, method = RequestMethod.POST)</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">login</span><span class="hljs-params">(String username, String password, String code, <span class="hljs-type">boolean</span> rememberme,</span><br><span class="hljs-params">                    Model model, <span class="hljs-comment">/*HttpSession session,*/</span> HttpServletResponse response,</span><br><span class="hljs-params">                    <span class="hljs-meta">@CookieValue(&quot;kaptchaOwner&quot;)</span> String kaptchaOwner)</span> &#123;<br>    <span class="hljs-comment">/* 检查验证码</span><br><span class="hljs-comment">    String kaptcha = (String) session.getAttribute(&quot;kaptcha&quot;);</span><br><span class="hljs-comment">    if (StringUtils.isBlank(kaptcha) || StringUtils.isBlank(code) || !kaptcha.equalsIgnoreCase(code)) &#123; // 两个有一个为空，或者验证码不等（忽略大小写）</span><br><span class="hljs-comment">        model.addAttribute(&quot;codeMsg&quot;, &quot;验证码不正确!&quot;);</span><br><span class="hljs-comment">        return &quot;/site/login&quot;;</span><br><span class="hljs-comment">    &#125;*/</span><br><br>    <span class="hljs-comment">// 检查验证码</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">kaptcha</span> <span class="hljs-operator">=</span> <span class="hljs-literal">null</span>;<br>    <span class="hljs-keyword">if</span> (StringUtils.isNotBlank(kaptchaOwner)) &#123;  <span class="hljs-comment">// 从 cookie 中获取 kaptchaOwner</span><br>        <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getKaptchaKey(kaptchaOwner);<br>        kaptcha = (String) redisTemplate.opsForValue().get(redisKey);<br>    &#125;<br><br>    <span class="hljs-keyword">if</span> (StringUtils.isBlank(kaptcha) || StringUtils.isBlank(code) || !kaptcha.equalsIgnoreCase(code)) &#123;<br>        model.addAttribute(<span class="hljs-string">&quot;codeMsg&quot;</span>, <span class="hljs-string">&quot;验证码不正确!&quot;</span>);<br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/login&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 检查账号,密码</span><br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>前端代码无需更新，检测能够登录成功，观看redis里的值和浏览器里的cookie</p>
<h3 id="5-2-使用Redis存储登录凭证"><a href="#5-2-使用Redis存储登录凭证" class="headerlink" title="5.2 使用Redis存储登录凭证"></a>5.2 使用Redis存储登录凭证</h3><p>之前是把 登陆凭证 放到 mysql 里，创建了一张表，存储了 user_id, ticket, 状态，过期时间。现在存到redis里，这张表及其对应方法就可以不用了，</p>
<p>之前是在 userService 里编写的相关方法，有三个地方：</p>
<ul>
<li>登陆成功以后，生成登陆凭证并保存</li>
<li>退出时，把凭证删掉（其实是把状态设为1，表示失效，并不是真的删除）</li>
<li>查询凭证的方法</li>
</ul>
<p>现在逐一重构这些方法</p>
<p>首先还是为 凭证 ticket 创建 redis 的 key</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><code class="hljs Java">   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PREFIX_TICKET</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;ticket&quot;</span>;<br><br><span class="hljs-comment">// 登录的凭证	</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getTicketKey</span><span class="hljs-params">(String ticket)</span> &#123;<br>       <span class="hljs-keyword">return</span> PREFIX_TICKET + SPLIT + ticket;<br>   &#125;<br></code></pre></td></tr></table></figure>

<p>随后为LoginTicketMapper 添加注解@Deprecated，表示不推荐使用。</p>
<p><strong>业务层</strong></p>
<p>对 UserService 做出更改，首先是登录的业务方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">login</span><span class="hljs-params">(String username, String password, <span class="hljs-type">int</span> expiredSeconds)</span> &#123;<br>    ...<br>    <br>    <span class="hljs-comment">// 生成登录凭证</span><br>    <span class="hljs-type">LoginTicket</span> <span class="hljs-variable">loginTicket</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">LoginTicket</span>();<br>    loginTicket.setUserId(user.getId());<br>    loginTicket.setTicket(CommunityUtil.generateUUID());  <span class="hljs-comment">// 登陆凭证是一个随机字符串</span><br>    loginTicket.setStatus(<span class="hljs-number">0</span>);  <span class="hljs-comment">// 设置状态，0是有效</span><br>    loginTicket.setExpired(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>(System.currentTimeMillis() + (<span class="hljs-type">long</span>)expiredSeconds * <span class="hljs-number">1000</span>));  <span class="hljs-comment">// 当前的时间+希望多久过期，需要转为long型，否则int会溢出</span><br>    <span class="hljs-comment">// loginTicketMapper.insertLoginTicket(loginTicket);  // 原来存到mysql里</span><br><br>    <span class="hljs-comment">// 把凭证存到redis里，这个凭证是个对象，我们之前在redisTemplate已经写了序列化的方法，会把对象转成JSON字符串</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getTicketKey(loginTicket.getTicket());<br>    redisTemplate.opsForValue().set(redisKey, loginTicket);    <br>        <br>    ...<br>&#125;<br></code></pre></td></tr></table></figure>

<p>其次是退出登录的方法（其实感觉这里 value 用 hash结构更好，可以直接改状态字段的值）</p>
<p>这里要注意，其实是把登陆凭证的状态设为1，表示失效，并不是真的删除，因为以后可能有需求比如一年登录了多少天，需要用到这些登陆凭证的信息</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 退出功能</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">logout</span><span class="hljs-params">(String ticket)</span> &#123;<br>    <span class="hljs-comment">// loginTicketMapper.updateStatus(ticket, 1);  // 原来的做法</span><br>    <span class="hljs-comment">// 先得到对象 -&gt; 再把状态设为1，表示失效 -&gt; 再重写回去</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getTicketKey(ticket);<br>    <span class="hljs-type">LoginTicket</span> <span class="hljs-variable">loginTicket</span> <span class="hljs-operator">=</span> (LoginTicket) redisTemplate.opsForValue().get(redisKey);<br>    loginTicket.setStatus(<span class="hljs-number">1</span>);<br>    redisTemplate.opsForValue().set(redisKey, loginTicket);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>最后是查询用户登录凭证的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 查询用户登录凭证</span><br><span class="hljs-keyword">public</span> LoginTicket <span class="hljs-title function_">findLoginTicket</span><span class="hljs-params">(String ticket)</span> &#123;<br>    <span class="hljs-comment">// return loginTicketMapper.selectByTicket(ticket); // 原本是从mysql里取</span><br>    <span class="hljs-comment">// 改为从Redis里取登录凭证</span><br>    <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getTicketKey(ticket);<br>    <span class="hljs-keyword">return</span> (LoginTicket) redisTemplate.opsForValue().get(redisKey);<br>&#125;<br></code></pre></td></tr></table></figure>



<h3 id="5-3-使用Redis缓存用户信息"><a href="#5-3-使用Redis缓存用户信息" class="headerlink" title="5.3 使用Redis缓存用户信息"></a>5.3 使用Redis缓存用户信息</h3><p>处理每次请求时，都要根据凭证查询用户信息，访问的频率非常高。所以把它改为放到 redis 里。这里注意只是缓存，根本的还是用 user 表，只不过当前用户请求时，该用户信息会被频繁使用，所以将它缓存下来，提高性能。等这个用户不请求了，或者说登陆凭证失效了，就没必要留着这个缓存了。<strong>这个思路和之前的登录凭证是不同的，登陆凭证是一直留着，只是退出登录或者失效时，把状态改为1，注意体会这个区别</strong></p>
<p>缓存的思路一般为：</p>
<ul>
<li>查询用户信息时优先从缓存中取值，而不是去 mysql 里取值</li>
<li>取不到时，初始化缓存数据</li>
<li>数据变更时清除缓存数据（这里一般不会去更新缓存，而是直接删除，下一次查的时候再去初始化一下就行，更新数据比删除麻烦，而且容易导致并发的问题）</li>
</ul>
<p>首先仍然是创建对应的 key</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs Java">   <span class="hljs-keyword">private</span> <span class="hljs-keyword">static</span> <span class="hljs-keyword">final</span> <span class="hljs-type">String</span> <span class="hljs-variable">PREFIX_USER</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;user&quot;</span>;    <br><span class="hljs-comment">// 用户</span><br>   <span class="hljs-keyword">public</span> <span class="hljs-keyword">static</span> String <span class="hljs-title function_">getUserKey</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> &#123;<br>       <span class="hljs-keyword">return</span> PREFIX_USER + SPLIT + userId;<br>   &#125;<br></code></pre></td></tr></table></figure>

<p><strong>业务层</strong></p>
<p>先是缓存思路三个步骤的方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 1.优先从缓存中取值</span><br><span class="hljs-keyword">private</span> User <span class="hljs-title function_">getCache</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getUserKey(userId);<br>    <span class="hljs-keyword">return</span> (User) redisTemplate.opsForValue().get(redisKey);<br>&#125;<br><br><span class="hljs-comment">// 2.取不到时初始化缓存数据</span><br><span class="hljs-keyword">private</span> User <span class="hljs-title function_">initCache</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(userId);<br>    <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getUserKey(userId);<br>    redisTemplate.opsForValue().set(redisKey, user, <span class="hljs-number">3600</span>, TimeUnit.SECONDS);  <span class="hljs-comment">// 有效期1个小时</span><br>    <span class="hljs-keyword">return</span> user;<br>&#125;<br><br><span class="hljs-comment">// 3.数据变更时清除缓存数据</span><br><span class="hljs-keyword">private</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">clearCache</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> &#123;<br>    <span class="hljs-type">String</span> <span class="hljs-variable">redisKey</span> <span class="hljs-operator">=</span> RedisKeyUtil.getUserKey(userId);<br>    redisTemplate.delete(redisKey);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>然后更改需要 取用户信息、更新用户信息的其他方法</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">// 根据用户id查询用户信息</span><br><span class="hljs-keyword">public</span> User <span class="hljs-title function_">findUserById</span><span class="hljs-params">(<span class="hljs-type">int</span> id)</span> &#123;<br>    <span class="hljs-comment">// return userMapper.selectById(id); // 原来是从mysql里查用户信息</span><br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> getCache(id);<br>    <span class="hljs-keyword">if</span> (user == <span class="hljs-literal">null</span>) &#123;<br>        user = initCache(id);<br>    &#125;<br>    <span class="hljs-keyword">return</span> user;<br>&#125;<br><br><span class="hljs-comment">// 激活注册账号</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">activation</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String code)</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> userMapper.selectById(userId);<br>    <span class="hljs-keyword">if</span> (user.getStatus() == <span class="hljs-number">1</span>) &#123;  <span class="hljs-comment">// 激活成功为1，如果还是等于1，那就是重复激活</span><br>        <span class="hljs-keyword">return</span> ACTIVATION_REPEAT;<br>    &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (user.getActivationCode().equals(code)) &#123; <span class="hljs-comment">// 激活成功将状态设为1</span><br>        userMapper.updateStatus(userId, <span class="hljs-number">1</span>);<br>        <span class="hljs-comment">// 激活成功可以清除用户缓存</span><br>        clearCache(userId);<br>        <span class="hljs-keyword">return</span> ACTIVATION_SUCCESS;<br>    &#125; <span class="hljs-keyword">else</span> &#123;<br>        <span class="hljs-keyword">return</span> ACTIVATION_FAILURE;  <span class="hljs-comment">// 激活失败</span><br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 更改用户头像url</span><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">updateHeader</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String headerUrl)</span> &#123;<br>    <span class="hljs-comment">// return userMapper.updateHeader(userId, headerUrl);</span><br>    <span class="hljs-comment">// 先到数据库里更新，再清理reids的缓存</span><br>    <span class="hljs-type">int</span> <span class="hljs-variable">rows</span> <span class="hljs-operator">=</span> userMapper.updateHeader(userId, headerUrl);<br>    clearCache(userId);<br>    <span class="hljs-keyword">return</span> rows;<br>&#125;<br></code></pre></td></tr></table></figure>



<p>表现层、前端不用更新，测试：</p>
<ul>
<li>能否正常加载各个页面，加载每个页面时，会缓存用户信息。比如登陆后加载首页，会缓存首页发帖子几个用户的信息，看下一页时，又会多缓存几个用户信息</li>
<li>如果变更了用户信息，比如重新上传头像，则会先删除用户信息缓存，再次查询时则重新获取，这个不太好直观观察，可以打断点观察</li>
</ul>
<p>本章节没有演示redis效率提高了多少，后面再演示</p>
<h1 id="五、Kafka，构建TB级异步消息系统"><a href="#五、Kafka，构建TB级异步消息系统" class="headerlink" title="五、Kafka，构建TB级异步消息系统"></a>五、Kafka，构建TB级异步消息系统</h1><p>Kafka是一个分布式的流媒体平台。应用：消息系统、日志收集、用户行为追踪、流式处理。特点:高吞吐量、消息持久化、高可靠性、高扩展性。</p>
<p>官网及下载网址：<a target="_blank" rel="noopener" href="http://kafka.apache.org/">http://kafka.apache.org/</a></p>
<p>下载安装包解压即可，官网的安装包为windows、linux通用版本。</p>
<p>下载完成后首先更改配置文件：</p>
<p>Kafka是基于zookeeper的，首先更改其配置文件，位于<code>kafka_2.13-3.2.0\config\zookeeper.properties</code></p>
<p>暂时只用改动 <code>dataDir=d:/codework/data/zookeeper</code>，原本的是linux系统下的目录。</p>
<p>随后更改kafka的配置文件，位于<code>kafka_2.13-3.2.0\config\server.properties</code></p>
<p>暂时只用改动 <code>log.dirs=d:/codework/data/kafka-logs</code>，原本的是linux系统下的目录。</p>
<p>更改完成后，即可启动。</p>
<p>首先选到d盘，然后cd到<code>d:\Environment\kafka_2.13-3.2.0</code>，在此目录下先启动zookeeper，再启动kafka</p>
<p>命令分别为：（要按照配置文件启动）</p>
<p><code>bin\windows\zookeeper-server-start.bat config\zookeeper.properties</code></p>
<p><code>bin\windows\kafka-server-start.bat config\server.properties</code></p>
<p>启动之后，可以让springboot集成kafka</p>
<h2 id="5-1-Spring整合Kafka测试"><a href="#5-1-Spring整合Kafka测试" class="headerlink" title="5.1 Spring整合Kafka测试"></a>5.1 Spring整合Kafka测试</h2><p><strong>注意在此之前要保证使用命令行将zookeeper和kafka保持开启状态</strong></p>
<p>导入依赖，在配置文件后追加</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><code class="hljs properties"><span class="hljs-comment"># KafkaProperties</span><br><span class="hljs-attr">spring.kafka.bootstrap-servers</span>=<span class="hljs-string">localhost:9092</span><br><span class="hljs-attr">spring.kafka.consumer.group-id</span>=<span class="hljs-string">test-consumer-group</span><br><span class="hljs-attr">spring.kafka.consumer.enable-auto-commit</span>=<span class="hljs-string">true</span><br><span class="hljs-attr">spring.kafka.consumer.auto-commit-interval</span>=<span class="hljs-string">3000</span><br></code></pre></td></tr></table></figure>

<p>其中<code>spring.kafka.consumer.group-id</code>的值一定要和kafka本地文件<code>consumer.properties</code>里保持相同，否则会启动失败</p>
<p>第一次用kafka，先测试保证正常启动且没有问题，再进行下一步的开发</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@SpringBootTest</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaTests</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> KafkaProducer kafkaProducer;<br><br>    <span class="hljs-meta">@Test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">testKafka</span><span class="hljs-params">()</span> &#123;<br>        kafkaProducer.sendMessage(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;你好&quot;</span>);<br>        kafkaProducer.sendMessage(<span class="hljs-string">&quot;test&quot;</span>, <span class="hljs-string">&quot;在吗&quot;</span>);<br><br>        <span class="hljs-keyword">try</span> &#123;<br>            Thread.sleep(<span class="hljs-number">1000</span> * <span class="hljs-number">10</span>);<br>        &#125; <span class="hljs-keyword">catch</span> (InterruptedException e) &#123;<br>            e.printStackTrace();<br>        &#125;<br>    &#125;<br>&#125;<br><br><span class="hljs-comment">// 生产者类</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaProducer</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> KafkaTemplate kafkaTemplate;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">sendMessage</span><span class="hljs-params">(String topic, String content)</span> &#123;<br>        kafkaTemplate.send(topic, content);<br>    &#125;<br><br>&#125;<br><br><span class="hljs-comment">// 消费者类</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">class</span> <span class="hljs-title class_">KafkaConsumer</span> &#123;<br><br>    <span class="hljs-meta">@KafkaListener(topics = &#123;&quot;test&quot;&#125;)</span>  <span class="hljs-comment">// 这里直接写死消费者监听的消息主题为test</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleMessage</span><span class="hljs-params">(ConsumerRecord record)</span> &#123;<br>        System.out.println(record.value());<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>



<h2 id="5-2-发送系统通知"><a href="#5-2-发送系统通知" class="headerlink" title="5.2 发送系统通知"></a>5.2 发送系统通知</h2><p>当用户被别人点赞、关注，评论之后，系统应该发送一条消息去通知，我们把这三个操作抽象成事件</p>
<p>封装事件对象，entity-Event</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">Event</span> &#123;<br><br>    <span class="hljs-keyword">private</span> String topic; <span class="hljs-comment">// 事件类型：点赞，关注，评论</span><br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> userId;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> entityType;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> entityId;<br>    <span class="hljs-keyword">private</span> <span class="hljs-type">int</span> entityUserId;    <br>    <span class="hljs-keyword">private</span> Map&lt;String, Object&gt; data = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();  <span class="hljs-comment">// 为了扩展性，将其他的属性放到map里</span><br><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getTopic</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> topic;<br>    &#125;<br><br>    <span class="hljs-comment">// set方法把事件对象返回，可以对事件对象进一步设置属性（链式结构）。而不用对每种字段组合都设置构造函数</span><br>    <span class="hljs-keyword">public</span> Event <span class="hljs-title function_">setTopic</span><span class="hljs-params">(String topic)</span> &#123;<br>        <span class="hljs-built_in">this</span>.topic = topic;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getUserId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> userId;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Event <span class="hljs-title function_">setUserId</span><span class="hljs-params">(<span class="hljs-type">int</span> userId)</span> &#123;<br>        <span class="hljs-built_in">this</span>.userId = userId;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getEntityType</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> entityType;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Event <span class="hljs-title function_">setEntityType</span><span class="hljs-params">(<span class="hljs-type">int</span> entityType)</span> &#123;<br>        <span class="hljs-built_in">this</span>.entityType = entityType;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getEntityId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> entityId;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Event <span class="hljs-title function_">setEntityId</span><span class="hljs-params">(<span class="hljs-type">int</span> entityId)</span> &#123;<br>        <span class="hljs-built_in">this</span>.entityId = entityId;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">getEntityUserId</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> entityUserId;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Event <span class="hljs-title function_">setEntityUserId</span><span class="hljs-params">(<span class="hljs-type">int</span> entityUserId)</span> &#123;<br>        <span class="hljs-built_in">this</span>.entityUserId = entityUserId;<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>    <span class="hljs-keyword">public</span> Map&lt;String, Object&gt; <span class="hljs-title function_">getData</span><span class="hljs-params">()</span> &#123;<br>        <span class="hljs-keyword">return</span> data;<br>    &#125;<br><br>    <span class="hljs-comment">// 这里传入的不是map，而是key和value，set方法里put进map</span><br>    <span class="hljs-keyword">public</span> Event <span class="hljs-title function_">setData</span><span class="hljs-params">(String key, Object value)</span> &#123;<br>        <span class="hljs-built_in">this</span>.data.put(key, value);<br>        <span class="hljs-keyword">return</span> <span class="hljs-built_in">this</span>;<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>补充常量</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 主题: 评论</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">String</span> <span class="hljs-variable">TOPIC_COMMENT</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;comment&quot;</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 主题: 点赞</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">String</span> <span class="hljs-variable">TOPIC_LIKE</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;like&quot;</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 主题: 关注</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">String</span> <span class="hljs-variable">TOPIC_FOLLOW</span> <span class="hljs-operator">=</span> <span class="hljs-string">&quot;follow&quot;</span>;<br><br><span class="hljs-comment">/**</span><br><span class="hljs-comment"> * 系统用户ID</span><br><span class="hljs-comment"> */</span><br><span class="hljs-type">int</span> <span class="hljs-variable">SYSTEM_USER_ID</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span>;<br></code></pre></td></tr></table></figure>



<p>编写事件的生产者和消费者，创建新的包event</p>
<p>生产者很简单，就是用kafka发送事件的消息。将事件发布到指定的主题，需要两个参数：发送的主题和发送的内容，这里的内容可以把整个event对象都转成JSON字符串发过去，至于怎么处理这个对象的信息，让消费者决定</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventProducer</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> KafkaTemplate kafkaTemplate;<br><br>    <span class="hljs-comment">// 处理事件</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">fireEvent</span><span class="hljs-params">(Event event)</span> &#123;<br>        <span class="hljs-comment">// 将事件发布到指定的主题，需要两个参数：发送的主题和发送的内容</span><br>        <span class="hljs-comment">// 这里的内容可以把整个event对象都转成JSON字符串发过去，至于怎么处理这个对象的信息，让消费者决定</span><br>        kafkaTemplate.send(event.getTopic(), JSONObject.toJSONString(event));<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>消费者，看注释</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Slf4j</span><br><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">EventConsumer</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CommunityConstant</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MessageService messageService;<br><br>    <span class="hljs-comment">// kafka监听3个主题：点赞、关注、评论。 虽然也可以每个方法监听一个主题，但由于这里处理的方式类似，合起来写</span><br>    <span class="hljs-meta">@KafkaListener(topics = &#123;TOPIC_COMMENT, TOPIC_LIKE, TOPIC_FOLLOW&#125;)</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">handleCommentMessage</span><span class="hljs-params">(ConsumerRecord record)</span> &#123;  <span class="hljs-comment">// 消费者接受的参数类型：ConsumerRecord</span><br>        <span class="hljs-comment">// 对于第三方包的对象，要习惯判定是否为空</span><br>        <span class="hljs-keyword">if</span> (record == <span class="hljs-literal">null</span> || record.value() == <span class="hljs-literal">null</span>) &#123;<br>            log.error(<span class="hljs-string">&quot;消息的内容为空!&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-type">Event</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> JSONObject.parseObject(record.value().toString(), Event.class);<br>        <span class="hljs-keyword">if</span> (event == <span class="hljs-literal">null</span>) &#123;<br>            log.error(<span class="hljs-string">&quot;消息格式错误!&quot;</span>);<br>            <span class="hljs-keyword">return</span>;<br>        &#125;<br><br>        <span class="hljs-comment">// 发送站内通知：表现形式就是往message表里插入记录，建议写之前再看下表结构</span><br>        <span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Message</span>();<br>        message.setFromId(SYSTEM_USER_ID);  <span class="hljs-comment">// 系统用户id固定为1，用于发送系统消息</span><br>        message.setToId(event.getEntityUserId());<br>        <span class="hljs-comment">// ConversationId之前是两个用户之间的id，现在可以换为三个主题：点赞、关注、评论</span><br>        message.setConversationId(event.getTopic());<br>        message.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br><br>        <span class="hljs-comment">// 内容content之前是存储用户发送私信的文本，现在存储 用于拼出系统通知的各个组成部分</span><br>        <span class="hljs-comment">// 比如通知：用户xxx评论（回复）了你的xxx帖子（xxx评论）</span><br>        Map&lt;String, Object&gt; content = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        content.put(<span class="hljs-string">&quot;userId&quot;</span>, event.getUserId());<br>        content.put(<span class="hljs-string">&quot;entityType&quot;</span>, event.getEntityType());<br>        content.put(<span class="hljs-string">&quot;entityId&quot;</span>, event.getEntityId());<br>        <span class="hljs-comment">// event里其他的属性我们封装到了一个map里，现在表里也没有其他合适的字段放了，因此我们统一也放到content里</span><br>        <span class="hljs-keyword">if</span> (!event.getData().isEmpty()) &#123;<br>            <span class="hljs-keyword">for</span> (Map.Entry&lt;String, Object&gt; entry : event.getData().entrySet()) &#123;<br>                content.put(entry.getKey(), entry.getValue());<br>            &#125;<br>        &#125;<br>        message.setContent(JSONObject.toJSONString(content));<br><br>        <span class="hljs-comment">// 调用私信业务层方法</span><br>        messageService.addMessage(message);<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>生产者和消费者编写结束后，就是在什么时候去调用的问题了。其中消费者是被动触发的，这是kafka写好的，只要有生产者生产了消息，就会触发。所以我们主要考虑什么时候调用生产者。很明显，当用户点赞、评论、关注时，就应该调用。也就是LikeController、FollowController、CommentController</p>
<p>CommentController.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Controller</span><br><span class="hljs-meta">@RequestMapping(&quot;/comment&quot;)</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">CommentController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CommunityConstant</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> CommentService commentService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HostHolder hostHolder;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> EventProducer eventProducer;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> DiscussPostService discussPostService;<br><br>    <span class="hljs-comment">// 增加完评论后，我们希望它能回到当前帖子页面，所以需要传进来帖子id</span><br>    <span class="hljs-meta">@RequestMapping(path = &quot;/add/&#123;discussPostId&#125;&quot;, method = RequestMethod.POST)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">addComment</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;discussPostId&quot;)</span> <span class="hljs-type">int</span> discussPostId, Comment comment)</span> &#123;<br>        <span class="hljs-comment">// 登录才能评论</span><br>        <span class="hljs-keyword">if</span>(hostHolder.getUser()==<span class="hljs-literal">null</span>)&#123;<br>            <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/login&quot;</span>;<br>        &#125;<br>        comment.setUserId(hostHolder.getUser().getId()); <span class="hljs-comment">// 需要得到当前用户的id</span><br>        comment.setStatus(<span class="hljs-number">0</span>);<br>        comment.setCreateTime(<span class="hljs-keyword">new</span> <span class="hljs-title class_">Date</span>());<br>        commentService.addComment(comment);<br><br>        <span class="hljs-comment">// 触发评论事件</span><br>        <span class="hljs-type">Event</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>()<br>                .setTopic(TOPIC_COMMENT)<br>                .setUserId(hostHolder.getUser().getId())<br>                .setEntityType(comment.getEntityType())<br>                .setEntityId(comment.getEntityId())<br>                .setData(<span class="hljs-string">&quot;postId&quot;</span>, discussPostId);                   <span class="hljs-comment">// 帖子id放到名为data的map里，通知消息里是写的谁评论了你，那么应该跳转到具体哪条帖子上</span><br>        <span class="hljs-keyword">if</span> (comment.getEntityType() == ENTITY_TYPE_POST) &#123;           <span class="hljs-comment">// 可能是帖子的评论，添加该实体的用户id</span><br>            <span class="hljs-type">DiscussPost</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> discussPostService.findDiscussPostById(comment.getEntityId());<br>            event.setEntityUserId(target.getUserId());<br>        &#125; <span class="hljs-keyword">else</span> <span class="hljs-keyword">if</span> (comment.getEntityType() == ENTITY_TYPE_COMMENT) &#123; <span class="hljs-comment">// 也可能是评论的评论，即回复</span><br>            <span class="hljs-type">Comment</span> <span class="hljs-variable">target</span> <span class="hljs-operator">=</span> commentService.findCommentById(comment.getEntityId());<br>            event.setEntityUserId(target.getUserId());<br>        &#125;<br>        eventProducer.fireEvent(event);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;redirect:/discuss/detail/&quot;</span> + discussPostId;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>LikeController.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">LikeController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CommunityConstant</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> LikeService likeService;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HostHolder hostHolder;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> EventProducer eventProducer;<br><br>    <span class="hljs-meta">@RequestMapping(path = &quot;/like&quot;, method = RequestMethod.POST)</span><br>    <span class="hljs-meta">@ResponseBody</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">like</span><span class="hljs-params">(<span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId, <span class="hljs-type">int</span> entityUserId, <span class="hljs-type">int</span> postId)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> hostHolder.getUser();<br><br>        <span class="hljs-comment">// 点赞</span><br>        likeService.like(user.getId(), entityType, entityId, entityUserId);<br>        <span class="hljs-comment">// 数量</span><br>        <span class="hljs-type">long</span> <span class="hljs-variable">likeCount</span> <span class="hljs-operator">=</span> likeService.findEntityLikeCount(entityType, entityId);<br>        <span class="hljs-comment">// 状态</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">likeStatus</span> <span class="hljs-operator">=</span> likeService.findEntityLikeStatus(user.getId(), entityType, entityId);<br>        <span class="hljs-comment">// 返回的结果</span><br>        Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        map.put(<span class="hljs-string">&quot;likeCount&quot;</span>, likeCount);<br>        map.put(<span class="hljs-string">&quot;likeStatus&quot;</span>, likeStatus);<br><br>        <span class="hljs-comment">// 触发点赞事件</span><br>        <span class="hljs-keyword">if</span> (likeStatus == <span class="hljs-number">1</span>) &#123;<br>            <span class="hljs-type">Event</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>()<br>                    .setTopic(TOPIC_LIKE)<br>                    .setUserId(hostHolder.getUser().getId())<br>                    .setEntityType(entityType)<br>                    .setEntityId(entityId)<br>                    .setEntityUserId(entityUserId)<br>                    <span class="hljs-comment">// 消息通知里应该给到点赞的帖子是哪一条，所以需要传入帖子id</span><br>                    .setData(<span class="hljs-string">&quot;postId&quot;</span>, postId); <br>            eventProducer.fireEvent(event);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">0</span>, <span class="hljs-literal">null</span>, map);<br>    &#125;<br><br>&#125;<br></code></pre></td></tr></table></figure>

<p>FollowController.java</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-comment">// 关注，异步请求</span><br><span class="hljs-meta">@RequestMapping(path = &quot;/follow&quot;, method = RequestMethod.POST)</span><br><span class="hljs-meta">@ResponseBody</span><br><span class="hljs-keyword">public</span> String <span class="hljs-title function_">follow</span><span class="hljs-params">(<span class="hljs-type">int</span> entityType, <span class="hljs-type">int</span> entityId)</span> &#123;<br>    <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> hostHolder.getUser();<br>    followService.follow(user.getId(), entityType, entityId);<br><br>    <span class="hljs-comment">// 触发关注事件</span><br>    <span class="hljs-type">Event</span> <span class="hljs-variable">event</span> <span class="hljs-operator">=</span> <span class="hljs-keyword">new</span> <span class="hljs-title class_">Event</span>()<br>            .setTopic(TOPIC_FOLLOW)<br>            .setUserId(hostHolder.getUser().getId())<br>            .setEntityType(entityType)<br>            .setEntityId(entityId)<br>            .setEntityUserId(entityId);<br>    eventProducer.fireEvent(event);<br><br>    <span class="hljs-keyword">return</span> CommunityUtil.getJSONString(<span class="hljs-number">0</span>, <span class="hljs-string">&quot;已关注!&quot;</span>);<br>&#125;<br></code></pre></td></tr></table></figure>



<p>更新前端文件，进行测试，测试内容为点赞关注评论别人，去查看 message 表，看是否有新增记录</p>
<h2 id="5-3-显示系统通知"><a href="#5-3-显示系统通知" class="headerlink" title="5.3 显示系统通知"></a>5.3 显示系统通知</h2><ul>
<li><p>通知列表</p>
<ul>
<li><p>显示评论、点赞、关注三种类型的通知</p>
<p>  <img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch5-%E6%98%BE%E7%A4%BA%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5%E5%88%97%E8%A1%A8-%E5%8A%9F%E8%83%BD%E6%BC%94%E7%A4%BA.png" srcset="/img/loading.gif" lazyload alt="image-20220619212512893"></p>
</li>
</ul>
</li>
<li><p>通知详情</p>
<ul>
<li><p>分页显示某一类主题所包含的通知</p>
<p>  <img src="https://jswanyu-1309100582.cos.ap-shanghai.myqcloud.com/picgo/Community/ch5-%E6%98%BE%E7%A4%BA%E7%B3%BB%E7%BB%9F%E9%80%9A%E7%9F%A5%E8%AF%A6%E6%83%85-%E5%8A%9F%E8%83%BD%E6%BC%94%E7%A4%BA.png" srcset="/img/loading.gif" lazyload alt="image-20220619223901928"></p>
</li>
</ul>
</li>
<li><p>未读消息</p>
<ul>
<li>在页面头部显示所有的未读消息数量</li>
</ul>
</li>
</ul>
<p>这部分和kafka就没关系了，还是按照数据访问层-业务层-表现层进行开发。这里就不按照通知列表-通知详情的顺序来了，直接三层架构，每层把通知列表-通知详情都写好</p>
<p><strong>DAO层</strong></p>
<p>MessageMapper</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Mapper</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">interface</span> <span class="hljs-title class_">MessageMapper</span> &#123;<br>    <span class="hljs-comment">// 查询某个主题下最新的通知</span><br>    Message <span class="hljs-title function_">selectLatestNotice</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String topic)</span>;<br><br>    <span class="hljs-comment">// 查询某个主题所包含的通知数量</span><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">selectNoticeCount</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String topic)</span>;<br><br>    <span class="hljs-comment">// 查询未读的通知的数量</span><br>    <span class="hljs-type">int</span> <span class="hljs-title function_">selectNoticeUnreadCount</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String topic)</span>;<br><br>    <span class="hljs-comment">// 查询某个主题所包含的通知列表</span><br>    List&lt;Message&gt; <span class="hljs-title function_">selectNotices</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String topic, <span class="hljs-type">int</span> offset, <span class="hljs-type">int</span> limit)</span>;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>message-mapper.xml</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br></pre></td><td class="code"><pre><code class="hljs Java">&lt;select id=<span class="hljs-string">&quot;selectLatestNotice&quot;</span> resultType=<span class="hljs-string">&quot;Message&quot;</span>&gt;<br>    select &lt;include refid=<span class="hljs-string">&quot;selectFields&quot;</span>&gt;&lt;/include&gt;<br>    from message<br>    where id <span class="hljs-title function_">in</span> <span class="hljs-params">(</span><br><span class="hljs-params">    select max(id)</span> from message<br>    where status != <span class="hljs-number">2</span><br>    <span class="hljs-type">and</span> <span class="hljs-variable">from_id</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br>    <span class="hljs-type">and</span> <span class="hljs-variable">to_id</span> <span class="hljs-operator">=</span> #&#123;userId&#125;<br>    <span class="hljs-type">and</span> <span class="hljs-variable">conversation_id</span> <span class="hljs-operator">=</span> #&#123;topic&#125;<br>    )<br>&lt;/select&gt;<br><br>&lt;select id=<span class="hljs-string">&quot;selectNoticeCount&quot;</span> resultType=<span class="hljs-string">&quot;int&quot;</span>&gt;<br>    select <span class="hljs-title function_">count</span><span class="hljs-params">(id)</span> from message<br>    where status != <span class="hljs-number">2</span><br>    <span class="hljs-type">and</span> <span class="hljs-variable">from_id</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br>    <span class="hljs-type">and</span> <span class="hljs-variable">to_id</span> <span class="hljs-operator">=</span> #&#123;userId&#125;<br>      <span class="hljs-type">and</span> <span class="hljs-variable">conversation_id</span> <span class="hljs-operator">=</span> #&#123;topic&#125;<br>&lt;/select&gt;<br><br>&lt;select id=<span class="hljs-string">&quot;selectNoticeUnreadCount&quot;</span> resultType=<span class="hljs-string">&quot;int&quot;</span>&gt;<br>    select <span class="hljs-title function_">count</span><span class="hljs-params">(id)</span> from message<br>    <span class="hljs-type">where</span> <span class="hljs-variable">status</span> <span class="hljs-operator">=</span> <span class="hljs-number">0</span><br>    <span class="hljs-type">and</span> <span class="hljs-variable">from_id</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br>    <span class="hljs-type">and</span> <span class="hljs-variable">to_id</span> <span class="hljs-operator">=</span> #&#123;userId&#125;<br>    &lt;<span class="hljs-keyword">if</span> test=<span class="hljs-string">&quot;topic!=null&quot;</span>&gt;<br>        <span class="hljs-type">and</span> <span class="hljs-variable">conversation_id</span> <span class="hljs-operator">=</span> #&#123;topic&#125;<br>    &lt;/<span class="hljs-keyword">if</span>&gt;<br>&lt;/select&gt;<br><br>&lt;select id=<span class="hljs-string">&quot;selectNotices&quot;</span> resultType=<span class="hljs-string">&quot;Message&quot;</span>&gt;<br>    select &lt;include refid=<span class="hljs-string">&quot;selectFields&quot;</span>&gt;&lt;/include&gt;<br>    from message<br>    where status != <span class="hljs-number">2</span><br>    <span class="hljs-type">and</span> <span class="hljs-variable">from_id</span> <span class="hljs-operator">=</span> <span class="hljs-number">1</span><br>    <span class="hljs-type">and</span> <span class="hljs-variable">to_id</span> <span class="hljs-operator">=</span> #&#123;userId&#125;<br>    <span class="hljs-type">and</span> <span class="hljs-variable">conversation_id</span> <span class="hljs-operator">=</span> #&#123;topic&#125;<br>    order by create_time desc<br>    limit #&#123;offset&#125;, #&#123;limit&#125;<br>&lt;/select&gt;<br></code></pre></td></tr></table></figure>

<p>业务层</p>
<p>MessageService</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-keyword">public</span> Message <span class="hljs-title function_">findLatestNotice</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String topic)</span> &#123;<br>    <span class="hljs-keyword">return</span> messageMapper.selectLatestNotice(userId, topic);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findNoticeCount</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String topic)</span> &#123;<br>    <span class="hljs-keyword">return</span> messageMapper.selectNoticeCount(userId, topic);<br>&#125;<br><br><span class="hljs-keyword">public</span> <span class="hljs-type">int</span> <span class="hljs-title function_">findNoticeUnreadCount</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String topic)</span> &#123;<br>    <span class="hljs-keyword">return</span> messageMapper.selectNoticeUnreadCount(userId, topic);<br>&#125;<br><br><span class="hljs-keyword">public</span> List&lt;Message&gt; <span class="hljs-title function_">findNotices</span><span class="hljs-params">(<span class="hljs-type">int</span> userId, String topic, <span class="hljs-type">int</span> offset, <span class="hljs-type">int</span> limit)</span> &#123;<br>    <span class="hljs-keyword">return</span> messageMapper.selectNotices(userId, topic, offset, limit);<br>&#125;<br></code></pre></td></tr></table></figure>

<p>表现层</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br></pre></td><td class="code"><pre><code class="hljs java"><span class="hljs-meta">@Controller</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageController</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">CommunityConstant</span> &#123;<br>    <br>    ...<br>    <br>        <span class="hljs-comment">// 通知列表</span><br>    <span class="hljs-meta">@RequestMapping(path = &quot;/notice/list&quot;, method = RequestMethod.GET)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getNoticeList</span><span class="hljs-params">(Model model)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> hostHolder.getUser();<br><br>        <span class="hljs-comment">// 查询评论类通知，显示只显示最新通知</span><br>        <span class="hljs-type">Message</span> <span class="hljs-variable">message</span> <span class="hljs-operator">=</span> messageService.findLatestNotice(user.getId(), TOPIC_COMMENT);<br>        <span class="hljs-comment">// 构建一个message视图对象，往里添加信息</span><br>        Map&lt;String, Object&gt; messageVO = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-keyword">if</span> (message != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-comment">// 添加信息</span><br>            messageVO.put(<span class="hljs-string">&quot;message&quot;</span>, message);<br>            <span class="hljs-comment">// 很多信息都在之前存到了message表的content字段，从里面读出来，之前是转义的，现在对其进行反转义</span><br>            <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> HtmlUtils.htmlUnescape(message.getContent());<br>            Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);<br>            messageVO.put(<span class="hljs-string">&quot;user&quot;</span>, userService.findUserById((Integer) data.get(<span class="hljs-string">&quot;userId&quot;</span>)));<br>            messageVO.put(<span class="hljs-string">&quot;entityType&quot;</span>, data.get(<span class="hljs-string">&quot;entityType&quot;</span>));<br>            messageVO.put(<span class="hljs-string">&quot;entityId&quot;</span>, data.get(<span class="hljs-string">&quot;entityId&quot;</span>));<br>            messageVO.put(<span class="hljs-string">&quot;postId&quot;</span>, data.get(<span class="hljs-string">&quot;postId&quot;</span>));<br><br>            <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> messageService.findNoticeCount(user.getId(), TOPIC_COMMENT);<br>            messageVO.put(<span class="hljs-string">&quot;count&quot;</span>, count);<br><br>            <span class="hljs-type">int</span> <span class="hljs-variable">unread</span> <span class="hljs-operator">=</span> messageService.findNoticeUnreadCount(user.getId(), TOPIC_COMMENT);<br>            messageVO.put(<span class="hljs-string">&quot;unread&quot;</span>, unread);<br>        &#125;<br>        model.addAttribute(<span class="hljs-string">&quot;commentNotice&quot;</span>, messageVO);<br><br>        <span class="hljs-comment">// 查询点赞类通知，同上</span><br>        message = messageService.findLatestNotice(user.getId(), TOPIC_LIKE);<br>        messageVO = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-keyword">if</span> (message != <span class="hljs-literal">null</span>) &#123;<br>            messageVO.put(<span class="hljs-string">&quot;message&quot;</span>, message);<br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> HtmlUtils.htmlUnescape(message.getContent());<br>            Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);<br><br>            messageVO.put(<span class="hljs-string">&quot;user&quot;</span>, userService.findUserById((Integer) data.get(<span class="hljs-string">&quot;userId&quot;</span>)));<br>            messageVO.put(<span class="hljs-string">&quot;entityType&quot;</span>, data.get(<span class="hljs-string">&quot;entityType&quot;</span>));<br>            messageVO.put(<span class="hljs-string">&quot;entityId&quot;</span>, data.get(<span class="hljs-string">&quot;entityId&quot;</span>));<br>            messageVO.put(<span class="hljs-string">&quot;postId&quot;</span>, data.get(<span class="hljs-string">&quot;postId&quot;</span>));<br><br>            <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> messageService.findNoticeCount(user.getId(), TOPIC_LIKE);<br>            messageVO.put(<span class="hljs-string">&quot;count&quot;</span>, count);<br><br>            <span class="hljs-type">int</span> <span class="hljs-variable">unread</span> <span class="hljs-operator">=</span> messageService.findNoticeUnreadCount(user.getId(), TOPIC_LIKE);<br>            messageVO.put(<span class="hljs-string">&quot;unread&quot;</span>, unread);<br>        &#125;<br>        model.addAttribute(<span class="hljs-string">&quot;likeNotice&quot;</span>, messageVO);<br><br>        <span class="hljs-comment">// 查询关注类通知，同上</span><br>        message = messageService.findLatestNotice(user.getId(), TOPIC_FOLLOW);<br>        messageVO = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>        <span class="hljs-keyword">if</span> (message != <span class="hljs-literal">null</span>) &#123;<br>            messageVO.put(<span class="hljs-string">&quot;message&quot;</span>, message);<br><br>            <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> HtmlUtils.htmlUnescape(message.getContent());<br>            Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);<br><br>            messageVO.put(<span class="hljs-string">&quot;user&quot;</span>, userService.findUserById((Integer) data.get(<span class="hljs-string">&quot;userId&quot;</span>)));<br>            messageVO.put(<span class="hljs-string">&quot;entityType&quot;</span>, data.get(<span class="hljs-string">&quot;entityType&quot;</span>));<br>            messageVO.put(<span class="hljs-string">&quot;entityId&quot;</span>, data.get(<span class="hljs-string">&quot;entityId&quot;</span>));<br><br>            <span class="hljs-type">int</span> <span class="hljs-variable">count</span> <span class="hljs-operator">=</span> messageService.findNoticeCount(user.getId(), TOPIC_FOLLOW);<br>            messageVO.put(<span class="hljs-string">&quot;count&quot;</span>, count);<br><br>            <span class="hljs-type">int</span> <span class="hljs-variable">unread</span> <span class="hljs-operator">=</span> messageService.findNoticeUnreadCount(user.getId(), TOPIC_FOLLOW);<br>            messageVO.put(<span class="hljs-string">&quot;unread&quot;</span>, unread);<br>        &#125;<br>        model.addAttribute(<span class="hljs-string">&quot;followNotice&quot;</span>, messageVO);<br><br>        <span class="hljs-comment">// 查询未读消息数量</span><br>        <span class="hljs-type">int</span> <span class="hljs-variable">letterUnreadCount</span> <span class="hljs-operator">=</span> messageService.findLetterUnreadCount(user.getId(), <span class="hljs-literal">null</span>);<br>        model.addAttribute(<span class="hljs-string">&quot;letterUnreadCount&quot;</span>, letterUnreadCount);<br>        <span class="hljs-type">int</span> <span class="hljs-variable">noticeUnreadCount</span> <span class="hljs-operator">=</span> messageService.findNoticeUnreadCount(user.getId(), <span class="hljs-literal">null</span>);<br>        model.addAttribute(<span class="hljs-string">&quot;noticeUnreadCount&quot;</span>, noticeUnreadCount);<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/notice&quot;</span>;<br>    &#125;<br><br>    <span class="hljs-comment">// 通知详情</span><br>    <span class="hljs-meta">@RequestMapping(path = &quot;/notice/detail/&#123;topic&#125;&quot;, method = RequestMethod.GET)</span><br>    <span class="hljs-keyword">public</span> String <span class="hljs-title function_">getNoticeDetail</span><span class="hljs-params">(<span class="hljs-meta">@PathVariable(&quot;topic&quot;)</span> String topic, Page page, Model model)</span> &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> hostHolder.getUser();<br><br>        page.setLimit(<span class="hljs-number">5</span>);<br>        page.setPath(<span class="hljs-string">&quot;/notice/detail/&quot;</span> + topic);<br>        page.setRows(messageService.findNoticeCount(user.getId(), topic));<br><br>        <span class="hljs-comment">// 查到返回的是一个通知列表</span><br>        List&lt;Message&gt; noticeList = messageService.findNotices(user.getId(), topic, page.getOffset(), page.getLimit());<br>        <span class="hljs-comment">// 构建一个noticeVoList视图对象，列表里是一个个map</span><br>        List&lt;Map&lt;String, Object&gt;&gt; noticeVoList = <span class="hljs-keyword">new</span> <span class="hljs-title class_">ArrayList</span>&lt;&gt;();<br>        <span class="hljs-keyword">if</span> (noticeList != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-keyword">for</span> (Message notice : noticeList) &#123;<br>                Map&lt;String, Object&gt; map = <span class="hljs-keyword">new</span> <span class="hljs-title class_">HashMap</span>&lt;&gt;();<br>                <span class="hljs-comment">// 通知</span><br>                map.put(<span class="hljs-string">&quot;notice&quot;</span>, notice);<br>                <span class="hljs-comment">// 内容，对内容的操作和通知列表方法处理是一样的</span><br>                <span class="hljs-type">String</span> <span class="hljs-variable">content</span> <span class="hljs-operator">=</span> HtmlUtils.htmlUnescape(notice.getContent());<br>                Map&lt;String, Object&gt; data = JSONObject.parseObject(content, HashMap.class);<br>                map.put(<span class="hljs-string">&quot;user&quot;</span>, userService.findUserById((Integer) data.get(<span class="hljs-string">&quot;userId&quot;</span>)));<br>                map.put(<span class="hljs-string">&quot;entityType&quot;</span>, data.get(<span class="hljs-string">&quot;entityType&quot;</span>));<br>                map.put(<span class="hljs-string">&quot;entityId&quot;</span>, data.get(<span class="hljs-string">&quot;entityId&quot;</span>));<br>                map.put(<span class="hljs-string">&quot;postId&quot;</span>, data.get(<span class="hljs-string">&quot;postId&quot;</span>));<br>                <span class="hljs-comment">// 通知作者</span><br>                map.put(<span class="hljs-string">&quot;fromUser&quot;</span>, userService.findUserById(notice.getFromId()));<br><br>                noticeVoList.add(map);<br>            &#125;<br>        &#125;<br>        model.addAttribute(<span class="hljs-string">&quot;notices&quot;</span>, noticeVoList);<br><br>        <span class="hljs-comment">// 设置已读，既然访问了通知详情，就认为是已读了</span><br>        List&lt;Integer&gt; ids = getLetterIds(noticeList);<br>        <span class="hljs-keyword">if</span> (!ids.isEmpty()) &#123;<br>            messageService.readMessage(ids);<br>        &#125;<br><br>        <span class="hljs-keyword">return</span> <span class="hljs-string">&quot;/site/notice-detail&quot;</span>;<br>    &#125;    <br>&#125;<br></code></pre></td></tr></table></figure>

<p>在页面头部显示所有的未读消息数量，由于是在首页，所以所有请求访问时，都要查，此处我们写在拦截器里，去新建一个拦截器</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><code class="hljs Java"><span class="hljs-meta">@Component</span><br><span class="hljs-keyword">public</span> <span class="hljs-keyword">class</span> <span class="hljs-title class_">MessageInterceptor</span> <span class="hljs-keyword">implements</span> <span class="hljs-title class_">HandlerInterceptor</span> &#123;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> HostHolder hostHolder;<br><br>    <span class="hljs-meta">@Autowired</span><br>    <span class="hljs-keyword">private</span> MessageService messageService;<br><br>    <span class="hljs-meta">@Override</span><br>    <span class="hljs-keyword">public</span> <span class="hljs-keyword">void</span> <span class="hljs-title function_">postHandle</span><span class="hljs-params">(HttpServletRequest request, HttpServletResponse response, Object handler, ModelAndView modelAndView)</span> <span class="hljs-keyword">throws</span> Exception &#123;<br>        <span class="hljs-type">User</span> <span class="hljs-variable">user</span> <span class="hljs-operator">=</span> hostHolder.getUser();<br>        <span class="hljs-keyword">if</span> (user != <span class="hljs-literal">null</span> &amp;&amp; modelAndView != <span class="hljs-literal">null</span>) &#123;<br>            <span class="hljs-type">int</span> <span class="hljs-variable">letterUnreadCount</span> <span class="hljs-operator">=</span> messageService.findLetterUnreadCount(user.getId(), <span class="hljs-literal">null</span>);<br>            <span class="hljs-type">int</span> <span class="hljs-variable">noticeUnreadCount</span> <span class="hljs-operator">=</span> messageService.findNoticeUnreadCount(user.getId(), <span class="hljs-literal">null</span>);<br>            modelAndView.addObject(<span class="hljs-string">&quot;allUnreadCount&quot;</span>, letterUnreadCount + noticeUnreadCount);<br>        &#125;<br>    &#125;<br>&#125;<br></code></pre></td></tr></table></figure>

<p>更新前端文件，测试。这部分视频和资料里的代码里有bug，在视频课程下面评论区有勘误，我的代码已经改正</p>
<h1 id="六、Elasticsearch，分布式搜索引擎"><a href="#六、Elasticsearch，分布式搜索引擎" class="headerlink" title="六、Elasticsearch，分布式搜索引擎"></a>六、Elasticsearch，分布式搜索引擎</h1>
              
            </div>
            <hr/>
            <div>
              <div class="post-metas my-3">
  
    <div class="post-meta mr-3 d-flex align-items-center">
      <i class="iconfont icon-category"></i>
      

<span class="category-chains">
  
  
    
      <span class="category-chain">
        
  <a href="/categories/%E9%A1%B9%E7%9B%AE/" class="category-chain-item">项目</a>
  
  

      </span>
    
  
</span>

    </div>
  
  
</div>


              
  

  <div class="license-box my-3">
    <div class="license-title">
      <div>项目：学校交流论坛</div>
      <div>http://jswanyu.github.io/2022/06/11/项目/学校交流论坛/</div>
    </div>
    <div class="license-meta">
      
        <div class="license-meta-item">
          <div>作者</div>
          <div>万宇</div>
        </div>
      
      
        <div class="license-meta-item license-meta-date">
          <div>发布于</div>
          <div>2022年6月11日</div>
        </div>
      
      
      <div class="license-meta-item">
        <div>许可协议</div>
        <div>
          
            
            
              <a target="_blank" href="https://creativecommons.org/licenses/by/4.0/">
              <span class="hint--top hint--rounded" aria-label="BY - 署名">
                <i class="iconfont icon-by"></i>
              </span>
              </a>
            
          
        </div>
      </div>
    </div>
    <div class="license-icon iconfont"></div>
  </div>



              
            </div>

            
          </article>
        </div>
      </div>
    </div>

    <div class="side-col d-none d-lg-block col-lg-2">
      
  <aside class="sidebar" style="margin-left: -1rem">
    <div id="toc">
  <p class="toc-header"><i class="iconfont icon-list"></i>&nbsp;目录</p>
  <div class="toc-body" id="toc-body"></div>
</div>



  </aside>


    </div>
  </div>
</div>





  



  



  



  








    

    
      <a id="scroll-top-button" aria-label="TOP" href="#" role="button">
        <i class="iconfont icon-arrowup" aria-hidden="true"></i>
      </a>
    

    

    
  </main>

  <footer>
    <div class="footer-inner">
  
  
  
  
</div>

  </footer>

  <!-- Scripts -->
  
  <script  src="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.js" ></script>
  <link  rel="stylesheet" href="https://lib.baomitu.com/nprogress/0.2.0/nprogress.min.css" />

  <script>
    NProgress.configure({"showSpinner":false,"trickleSpeed":100})
    NProgress.start()
    window.addEventListener('load', function() {
      NProgress.done();
    })
  </script>


<script  src="https://lib.baomitu.com/jquery/3.6.0/jquery.min.js" ></script>
<script  src="https://lib.baomitu.com/twitter-bootstrap/4.6.1/js/bootstrap.min.js" ></script>
<script  src="/js/events.js" ></script>
<script  src="/js/plugins.js" ></script>


  <script  src="https://lib.baomitu.com/typed.js/2.0.12/typed.min.js" ></script>
  <script>
    (function (window, document) {
      var typing = Fluid.plugins.typing;
      var subtitle = document.getElementById('subtitle');
      if (!subtitle || !typing) {
        return;
      }
      var text = subtitle.getAttribute('data-typed-text');
      
        typing(text);
      
    })(window, document);
  </script>




  

  

  

  

  

  

  




  
    <script  src="/js/img-lazyload.js" ></script>
  




  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/tocbot/4.18.2/tocbot.min.js', function() {
    var toc = jQuery('#toc');
    if (toc.length === 0 || !window.tocbot) { return; }
    var boardCtn = jQuery('#board-ctn');
    var boardTop = boardCtn.offset().top;

    window.tocbot.init({
      tocSelector     : '#toc-body',
      contentSelector : '.markdown-body',
      headingSelector : CONFIG.toc.headingSelector || 'h1,h2,h3,h4,h5,h6',
      linkClass       : 'tocbot-link',
      activeLinkClass : 'tocbot-active-link',
      listClass       : 'tocbot-list',
      isCollapsedClass: 'tocbot-is-collapsed',
      collapsibleClass: 'tocbot-is-collapsible',
      collapseDepth   : CONFIG.toc.collapseDepth || 0,
      scrollSmooth    : true,
      headingsOffset  : -boardTop
    });
    if (toc.find('.toc-list-item').length > 0) {
      toc.css('visibility', 'visible');
    }
  });
</script>


  <script>
  (function() {
    var enableLang = CONFIG.code_language.enable && CONFIG.code_language.default;
    var enableCopy = CONFIG.copy_btn;
    if (!enableLang && !enableCopy) {
      return;
    }

    function getBgClass(ele) {
      return Fluid.utils.getBackgroundLightness(ele) >= 0 ? 'code-widget-light' : 'code-widget-dark';
    }

    var copyTmpl = '';
    copyTmpl += '<div class="code-widget">';
    copyTmpl += 'LANG';
    copyTmpl += '</div>';
    jQuery('.markdown-body pre').each(function() {
      var $pre = jQuery(this);
      if ($pre.find('code.mermaid').length > 0) {
        return;
      }
      if ($pre.find('span.line').length > 0) {
        return;
      }

      var lang = '';

      if (enableLang) {
        lang = CONFIG.code_language.default;
        if ($pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2 && $pre.children().hasClass('hljs')) {
          lang = $pre[0].children[0].classList[1];
        } else if ($pre[0].getAttribute('data-language')) {
          lang = $pre[0].getAttribute('data-language');
        } else if ($pre.parent().hasClass('sourceCode') && $pre[0].children.length > 0 && $pre[0].children[0].classList.length >= 2) {
          lang = $pre[0].children[0].classList[1];
          $pre.parent().addClass('code-wrapper');
        } else if ($pre.parent().hasClass('markdown-body') && $pre[0].classList.length === 0) {
          $pre.wrap('<div class="code-wrapper"></div>');
        }
        lang = lang.toUpperCase().replace('NONE', CONFIG.code_language.default);
      }
      $pre.append(copyTmpl.replace('LANG', lang).replace('code-widget">',
        getBgClass($pre[0]) + (enableCopy ? ' code-widget copy-btn" data-clipboard-snippet><i class="iconfont icon-copy"></i>' : ' code-widget">')));

      if (enableCopy) {
        Fluid.utils.createScript('https://lib.baomitu.com/clipboard.js/2.0.10/clipboard.min.js', function() {
          var clipboard = new window.ClipboardJS('.copy-btn', {
            target: function(trigger) {
              var nodes = trigger.parentNode.childNodes;
              for (var i = 0; i < nodes.length; i++) {
                if (nodes[i].tagName === 'CODE') {
                  return nodes[i];
                }
              }
            }
          });
          clipboard.on('success', function(e) {
            e.clearSelection();
            e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-copy', 'icon-success');
            setTimeout(function() {
              e.trigger.innerHTML = e.trigger.innerHTML.replace('icon-success', 'icon-copy');
            }, 2000);
          });
        });
      }
    });
  })();
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/anchor-js/4.3.1/anchor.min.js', function() {
    window.anchors.options = {
      placement: CONFIG.anchorjs.placement,
      visible  : CONFIG.anchorjs.visible
    };
    if (CONFIG.anchorjs.icon) {
      window.anchors.options.icon = CONFIG.anchorjs.icon;
    }
    var el = (CONFIG.anchorjs.element || 'h1,h2,h3,h4,h5,h6').split(',');
    var res = [];
    for (var item of el) {
      res.push('.markdown-body > ' + item.trim());
    }
    if (CONFIG.anchorjs.placement === 'left') {
      window.anchors.options.class = 'anchorjs-link-left';
    }
    window.anchors.add(res.join(', '));
  });
</script>


  
<script>
  Fluid.utils.createScript('https://lib.baomitu.com/fancybox/3.5.7/jquery.fancybox.min.js', function() {
    Fluid.plugins.fancyBox();
  });
</script>






<!-- 主题的启动项，将它保持在最底部 -->
<!-- the boot of the theme, keep it at the bottom -->
<script  src="/js/boot.js" ></script>


  

  <noscript>
    <div class="noscript-warning">博客在允许 JavaScript 运行的环境下浏览效果更佳</div>
  </noscript>
</body>
</html>
